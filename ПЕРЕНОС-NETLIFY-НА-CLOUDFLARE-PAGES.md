# Перенос фронта с Netlify на Cloudflare Pages

## Почему Cloudflare Pages

- **Безлимитный трафик** на бесплатном плане — при росте до тысячи пользователей не будет сюрпризов по лимитам.
- **500 сборок в месяц** бесплатно — при редких деплоях (только «большие» билды) хватит с запасом.
- **Без привязки карты** на Free — можно начать без оплаты.
- **Глобальный CDN** — быстрая отдача статики из ближайшей точки.
- **Pages Functions** — тот же прокси для изображений (api.telegram.org) уже добавлен в проект и будет работать по пути `/image-proxy`.

**Альтернатива:** Vercel (100 GB трафика, логика почти как у Netlify). Если захочешь минимум изменений в коде — можно рассмотреть Vercel; для долгого публичного релиза выгоднее Cloudflare Pages из‑за безлимитного трафика.

---

## Что уже сделано в репозитории

1. **Добавлена Cloudflare Pages Function** — `functions/image-proxy.js`: прокси для загрузки картинок с api.telegram.org (аналог Netlify Function).
2. **В `index.html`** URL прокси заменён с `/.netlify/functions/image-proxy` на `/image-proxy`.

Дальше — настройка в Cloudflare и обновление ссылок у бота.

---

## Чек-лист перед переносом

- [ ] Репозиторий с фронтом (тот же, что сейчас на Netlify) доступен в GitHub/GitLab.
- [ ] Закоммичены и запушены изменения: папка `functions/`, правка в `index.html`, можно удалить `netlify.toml` и папку `netlify/` после успешного перехода.
- [ ] Записан текущий URL мини-приложения в Netlify (нужен для смены в боте).
- [ ] Если есть свой домен на Netlify — решаешь, переносить ли его на Cloudflare (инструкция ниже).

---

## Пошаговая инструкция

### Шаг 1. Регистрация и доступ к Cloudflare Pages

1. Зайди на **https://dash.cloudflare.com**
2. Войди или зарегистрируйся (можно через Google/GitHub).
3. В левом меню выбери **Workers & Pages** → вкладка **Create** → **Pages** → **Connect to Git**.

### Шаг 2. Подключение репозитория

1. Выбери **GitHub** (или GitLab), разреши доступ к репозиторию с мини-приложением.
2. Выбери **репозиторий** и **ветку** (обычно `main`).
3. Нажми **Begin setup**.

### Шаг 3. Настройка сборки

- **Project name:** например `tg-wishlist-app` (будет в URL: `tg-wishlist-app.pages.dev`).
- **Production branch:** `main` (или твоя основная ветка).
- **Build command:** оставь **пустым** (или укажи `exit 0` — статика без сборки).
- **Build output directory:** укажи **`.`** (корень репозитория, где лежит `index.html`).

Нажми **Save and Deploy**.

### Шаг 4. Первый деплой

Cloudflare соберёт проект и задеплоит. Дождись зелёного статуса. URL будет вида:

`https://tg-wishlist-app.pages.dev`  
(или как назвал проект).

### Шаг 5. Проверка работы

1. Открой URL в браузере — должна открыться главная мини-приложения.
2. Проверь прокси изображений:
   - Отправь боту фото, открой мини-апп по кнопке «Анализировать изображение».
   - Должна подгрузиться картинка и (при настроенных ключах) анализ. Если картинка не грузится — в DevTools (F12 → Network) посмотри запрос к `/image-proxy?url=...` (должен быть 200 и JSON с `base64`).

### Шаг 6. Обновить URL мини-приложения у бота (Railway)

1. Зайди в **Railway** → проект бота → **Variables**.
2. Найди переменную **`WEB_APP_URL`**.
3. Замени значение на новый URL Cloudflare Pages, например:  
   `https://tg-wishlist-app.pages.dev`  
   (без слэша в конце).
4. Сохрани. Railway перезапустит сервис; новые сообщения с кнопкой будут открывать уже Cloudflare-версию.

### Шаг 7. Обновить URL в BotFather (если задан)

Если в BotFather для мини-приложения указан старый Netlify-URL — зайди в BotFather → **Bot Settings** → **Menu Button** / **Web App** и укажи новый URL Cloudflare Pages.

### Шаг 8. Отключить/удалить сайт на Netlify

- Когда убедишься, что всё работает на Cloudflare:
  - В Netlify: **Site settings** → **General** → **Stop builds** или удали сайт, чтобы не тратить лимиты.

### Шаг 9. (По желанию) Свой домен на Cloudflare

1. В проекте Pages: **Custom domains** → **Set up a custom domain**.
2. Введи домен (например `wishlist.example.com`).
3. Cloudflare подскажет, какие DNS-записи добавить у регистратора (обычно CNAME на `tg-wishlist-app.pages.dev`).
4. После проверки DNS сайт будет открываться по своему домену. Тогда в Railway в `WEB_APP_URL` и в BotFather укажи этот домен.

---

## Что можно удалить после перехода

После того как всё работает на Cloudflare:

- Файл **`netlify.toml`** — можно удалить.
- Папку **`netlify/`** (старая Netlify Function) — можно удалить, т.к. используется `functions/image-proxy.js` для Cloudflare.

Удаление делай коммитом в ту же ветку; на Cloudflare это не повлияет (они не используют эти файлы).

---

## Если что-то не работает

| Проблема | Что проверить |
|----------|----------------|
| Главная не открывается | В Cloudflare Pages → **Deployments** посмотри логи сборки. Убедись, что **Build output directory** = `.` и в корне репо есть `index.html`. |
| Картинка не грузится / ошибка прокси | В браузере F12 → Network: запрос к `/image-proxy?url=...`. Если 404 — проверь, что в репо есть файл `functions/image-proxy.js` и он запушен. Пересобери деплой в Cloudflare. |
| Бот открывает старый URL | Проверь переменную **WEB_APP_URL** в Railway и что деплой бота перезапустился. В Telegram полностью закрой чат с ботом и открой снова. |
| CORS / «blocked by CORS» | Прокси уже отдаёт заголовок `Access-Control-Allow-Origin: *`. Если ошибка на другом запросе — напиши, на каком именно. |

---

## Кратко

1. Подключи репо к Cloudflare Pages, сборка без команды, output = `.`.
2. Дождись деплоя, проверь сайт и отправку фото через бота.
3. Поменяй `WEB_APP_URL` в Railway на новый URL Cloudflare Pages.
4. При необходимости обнови URL в BotFather и отключи/удали сайт на Netlify.
5. После проверки можно удалить `netlify.toml` и папку `netlify/`.

После этого фронт будет отдаваться с Cloudflare Pages без лимитов по трафику на Free-плане.
