<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–í–∏—à–ª–∏—Å—Ç</title>
  <link rel="icon" href="data:,">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
  <script>
    function loadEruda(){try{localStorage.setItem('eruda','1');var e=document.createElement('script');e.src='https://cdn.jsdelivr.net/npm/eruda';e.onload=function(){eruda.init();};document.head.appendChild(e);}catch(x){}}
    if(/eruda=true/.test(location.href)||/#eruda/.test(location.hash)||localStorage.getItem('eruda'))loadEruda();
  </script>
  <style>
    /* ============================================================
       NEOBRUTALIST DESIGN ‚Äî I Want That So Bad
       Colors: #F0F0F0 bg | #FFFF00 primary | #FF00FF accent | #00FFFF tertiary
       Style: 2px black borders | 4px hard shadows | bold uppercase
    ============================================================ */
    :root {
      --nb-bg: #0D0D1A;
      --nb-card: #ffffff;
      --nb-black: #000000;
      --nb-yellow: #FFFF00;
      --nb-magenta: #FF00FF;
      --nb-cyan: #00FFFF;
      --nb-red: #FF0000;
      --nb-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
      --nb-shadow-sm: 2px 2px 0px 0px rgba(0,0,0,1);
      --nb-shadow-lg: 6px 6px 0px 0px rgba(0,0,0,1);
      --nb-border: 2px solid #000;
      --nb-radius: 12px;
      /* Legacy compat */
      --bg-primary: #0D0D1A;
      --bg-secondary: #1a1a2e;
      --bg-card: #ffffff;
      --accent: #FF00FF;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --border: rgba(255,255,255,0.15);
      --shadow: var(--nb-shadow);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif;
      background: var(--nb-bg);
      color: #ffffff;
      min-height: 100vh;
      padding: env(safe-area-inset-top) 0 0 0;
    }
    /* Animated background blobs ‚Äî on dark bg */
    .bg-blobs { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
    .bg-blob-1 { position: absolute; top: -80px; left: -60px; width: 380px; height: 380px; border-radius: 50%; background: radial-gradient(circle, rgba(255,0,255,0.55) 0%, transparent 60%); animation: blobMove1 8s ease-in-out infinite; }
    .bg-blob-2 { position: absolute; bottom: 5%; right: -60px; width: 340px; height: 340px; border-radius: 50%; background: radial-gradient(circle, rgba(80,0,220,0.6) 0%, transparent 60%); animation: blobMove2 10s ease-in-out infinite; }
    .bg-blob-3 { position: absolute; top: 38%; left: 10%; width: 280px; height: 280px; border-radius: 50%; background: radial-gradient(circle, rgba(0,200,255,0.4) 0%, transparent 60%); animation: blobMove1 12s ease-in-out infinite reverse; }
    @keyframes blobMove1 { 0%,100%{transform:translate(0,0)} 50%{transform:translate(30px,20px)} }
    @keyframes blobMove2 { 0%,100%{transform:translate(0,0)} 50%{transform:translate(-20px,-30px)} }
    /* Splash screen */
    .splash-screen { position: fixed; inset: 0; background: #0D0D1A; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .splash-screen.fade-out { animation: splashFade 0.5s ease-out forwards; }
    @keyframes splashFade { to { opacity: 0; pointer-events: none; } }
    .splash-lottie { width: 180px; height: 180px; }
    /* CSS loader spinner */
    .css-loader { width: 56px; height: 56px; border: 5px solid rgba(0,0,0,0.12); border-top-color: #000; border-right-color: #FF00FF; border-radius: 50%; animation: cssSpinLoader 0.8s linear infinite; }
    @keyframes cssSpinLoader { to { transform: rotate(360deg); } }
    /* Layout */
    .app-shell { width: 100%; min-height: 100vh; display: flex; flex-direction: column; padding-bottom: 110px; position: relative; z-index: 1; }
    .container { width: 100%; padding: 16px; flex: 1; box-sizing: border-box; }
    #content { animation: contentIn 0.25s ease-out; }
    @keyframes contentIn { from { opacity: 0; transform: translateX(12px); } to { opacity: 1; transform: translateX(0); } }
    /* App header ‚Äî logo full-width */
    .app-header { display: block; padding: 0; margin: 0; line-height: 0; }
    .app-logo { width: 100%; display: block; }
    /* Action buttons ‚Äî bottom right above tab bar */
    .action-buttons { position: fixed; bottom: calc(env(safe-area-inset-bottom) + 96px + 12px); right: 12px; z-index: 50; display: flex; flex-direction: column; gap: 10px; }
    .action-btn { width: 52px; height: 52px; border-radius: 50%; border: 2px solid #000; font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--nb-shadow); transition: transform 0.1s, box-shadow 0.1s; }
    .action-btn:active { transform: translate(4px,4px); box-shadow: none; }
    .action-btn.photo { background: var(--nb-yellow); color: #000; }
    .action-btn.link { background: var(--nb-magenta); color: #fff; }
    /* Tabbar ‚Äî Neon Pill style */
    .tab-bar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: #000;
      border-top: 4px solid var(--nb-magenta);
      border-bottom: 4px solid var(--nb-magenta);
      z-index: 100;
      display: flex; justify-content: space-around; align-items: center;
      padding: 10px 6px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
    }
    .tab-item {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      padding: 8px 16px;
      color: rgba(255,255,255,0.4);
      font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.06em;
      cursor: pointer; border: none; background: none; border-radius: 100px;
      font-family: inherit;
      transition: transform 0.12s, box-shadow 0.12s, background 0.12s, color 0.12s;
      flex: 1;
    }
    .tab-item:active { transform: scale(0.9); }
    .tab-item.active {
      background: var(--nb-yellow);
      color: #000;
      border: 2px solid #000;
      box-shadow: 3px 3px 0 0 #000;
      transform: translateY(-2px);
    }
    .tab-item svg { width: 24px; height: 24px; transition: width 0.12s, height 0.12s; }
    .tab-item.active svg { width: 22px; height: 22px; }
    /* Buttons */
    .btn { background: var(--nb-yellow); color: #000; border: var(--nb-border); padding: 10px 18px; border-radius: var(--nb-radius); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; box-shadow: var(--nb-shadow); display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-family: inherit; }
    .btn:hover { transform: translate(1px,1px); box-shadow: var(--nb-shadow-sm); }
    .btn:active { transform: translate(4px,4px); box-shadow: none; }
    .btn-secondary { background: var(--nb-magenta); color: #fff; }
    .btn-outline { background: #fff; color: #000; }
    .btn-sm { font-size: 0.72rem; padding: 5px 10px; }
    .btn-lg { font-size: 1rem; padding: 14px 22px; }
    .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 50%; }
    /* Cards */
    .card { background: #fff; color: #000; border: var(--nb-border); border-radius: var(--nb-radius); overflow: hidden; box-shadow: var(--nb-shadow); transition: transform 0.1s, box-shadow 0.1s; position: relative; content-visibility: auto; contain-intrinsic-size: auto 280px; }
    .card:active { transform: translate(2px,2px); box-shadow: var(--nb-shadow-sm); }
    .card-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: #eee; border-bottom: 2px solid #000; display: block; }
    .card .card-body { padding: 8px 10px 4px; }
    .card .card-title, .card .card-price, .card .card-meta, .card .card-link, .card .card-comment, .card .card-actions { padding: 0 10px; }
    .card .card-title { padding-top: 8px; }
    .card-title { font-size: 0.82rem; font-weight: 800; text-transform: uppercase; line-height: 1.3; margin-bottom: 4px; word-break: break-word; }
    .card-price { font-size: 0.82rem; font-weight: 700; background: var(--nb-yellow); border: 1px solid #000; display: inline-block; padding: 1px 5px; margin-bottom: 4px; }
    .card-meta { font-size: 0.72rem; color: #555; margin-bottom: 3px; }
    .card-link { font-size: 0.7rem; color: #0000EE; text-decoration: underline; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .card-comment { font-size: 0.75rem; margin: 6px 0; border-left: 2px solid var(--nb-magenta); padding-left: 6px; }
    .card-actions { display: flex; gap: 5px; padding: 6px 8px 8px; flex-wrap: wrap; border-top: 1px solid #000; }
    .card-move-wrap { position: relative; }
    .card-move-btn { padding: 4px 8px; font-size: 0.7rem; }
    .card-move-menu { position: absolute; bottom: 100%; left: 0; margin-bottom: 4px; background: #fff; border: 2px solid #000; padding: 4px 0; min-width: 160px; z-index: 10; box-shadow: var(--nb-shadow); }
    .card-move-menu button { display: block; width: 100%; padding: 8px 12px; text-align: left; background: none; border: none; color: #000; font-size: 0.85rem; cursor: pointer; font-weight: 700; }
    .card-move-menu button:hover { background: var(--nb-yellow); }
    .card-reserved { border-left: 4px solid var(--nb-magenta); }
    .card-reserved-badge { font-size: 0.72rem; font-weight: 700; color: var(--nb-magenta); padding: 4px 10px; border-top: 1px solid #000; }
    .card-tape { width: 36px; height: 12px; background: rgba(255,230,0,0.8); border-radius: 2px; margin: -2px auto 6px; display: block; }
    /* Wish grid */
    .wish-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 24px; }
    .wish-grid .card { margin-bottom: 0; padding: 0; border: 1.5px solid rgba(0,0,0,0.12); box-shadow: none; overflow: hidden; }
    .wish-grid-card { border: 1.5px solid rgba(0,0,0,0.12) !important; box-shadow: none !important; }
    .wish-card-edit, .wish-card-del, .wish-card-move { font-size: 0.65rem !important; }
    /* Manage cards (wishlists list) ‚Äî vertical layout */
    .manage-card { background: #fff; color: #000; border: var(--nb-border); border-radius: var(--nb-radius); box-shadow: var(--nb-shadow); padding: 14px 14px 22px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 0; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; content-visibility: auto; contain-intrinsic-size: auto 160px; }
    .manage-card:active { transform: translate(2px,2px); box-shadow: var(--nb-shadow-sm); }
    .manage-card-img { width: 72px; height: 72px; object-fit: cover; border: 2px solid #000; border-radius: 10px; background: #eee; display: block; }
    .manage-card-name { font-weight: 900; font-size: 0.92rem; text-transform: uppercase; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; letter-spacing: -0.01em; flex: 1; min-width: 0; }
    .manage-card-actions { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
    .manage-icon-btn { width: 32px; height: 32px; border: 2px solid #000; background: #fff; color: #000; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; box-shadow: var(--nb-shadow-sm); transition: transform 0.1s, box-shadow 0.1s; }
    .manage-icon-btn:active { transform: translate(2px,2px); box-shadow: none; }
    .manage-icon-btn.danger { background: var(--nb-red); color: #fff; }
    /* Page header */
    .page-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .page-header-title { font-size: 1.25rem; font-weight: 900; text-transform: uppercase; letter-spacing: -0.02em; flex: 1; }
    .page-back-btn { background: #fff; border: var(--nb-border); box-shadow: var(--nb-shadow-sm); color: #000; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; font-weight: 700; transition: transform 0.1s, box-shadow 0.1s; font-family: inherit; white-space: nowrap; }
    .page-back-btn:active { transform: translate(2px,2px); box-shadow: none; }
    /* Wishlist detail header ‚Äî unified chip system */
    .wl-chip { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border: 2px solid #000; border-radius: 100px; font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; white-space: nowrap; font-family: inherit; box-shadow: 2px 2px 0 0 #000; cursor: default; line-height: 1; }
    .wl-chip-btn { cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; }
    .wl-chip-btn:active { transform: translate(2px,2px); box-shadow: none; }
    .wl-chip.back { background: #fff; color: #000; }
    .wl-chip.privacy-private { background: #000; color: var(--nb-yellow); }
    .wl-chip.privacy-public { background: var(--nb-magenta); color: #fff; }
    .wl-chip.privacy-shared { background: var(--nb-cyan); color: #000; }
    .wl-chip.action-share { background: var(--nb-yellow); color: #000; }
    .wl-chip.action-invite { background: var(--nb-cyan); color: #000; }
    .page-header-title { color: #fff; }
    /* Tag cloud */
    .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px 0; justify-content: center; }
    .tag-chip { padding: 8px 16px; border: 2px solid #000; background: #fff; box-shadow: 3px 3px 0 0 #000; color: #000; font-weight: 700; font-size: 0.82rem; text-transform: uppercase; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s, background 0.1s; user-select: none; border-radius: 100px; }
    .tag-chip:hover { background: var(--nb-yellow); }
    .tag-chip:active { transform: translate(2px,2px); box-shadow: 1px 1px 0 0 #000; }
    .tag-chip.selected { background: var(--nb-red); color: #fff; box-shadow: 6px 6px 0 0 #000; transform: scale(1.06); }
    @keyframes tagShake { 0% { transform: rotate(-1deg); } 100% { transform: rotate(1deg); } }
    .tag-chip.selected { animation: none !important; }
    .cat-chips-wrap { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .cat-chip { display: inline-flex; align-items: center; gap: 8px; border: 2px solid #000; background: #fff; box-shadow: var(--nb-shadow-sm); padding: 6px 12px; font-weight: 700; font-size: 0.78rem; text-transform: uppercase; cursor: pointer; border-radius: 100px; }
    .cat-chip-remove { color: var(--nb-red); font-size: 1rem; background: none; border: none; cursor: pointer; padding: 0; font-weight: 700; }
    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: flex; align-items: flex-end; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s; }
    .modal-overlay.open { opacity: 1; visibility: visible; }
    .modal { background: #F0F0F0; color: #000; border: 2px solid #000; border-radius: 20px 20px 0 0; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; padding: 24px; transform: translateY(100%); transition: transform 0.3s; box-shadow: 0 -6px 0 0 #000; }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal h2 { margin-bottom: 20px; font-size: 1.1rem; font-weight: 900; text-transform: uppercase; letter-spacing: -0.01em; }
    /* SLAY wish modal dark gradient */
    #wishModal .modal { background: linear-gradient(160deg, #1a0035 0%, #2a004a 45%, #0d001f 100%); border-color: #FF00FF; box-shadow: 0 -8px 0 0 #FF00FF, 0 0 40px rgba(255,0,255,0.15); color: #fff; }
    #wishModal .modal h2 { color: #FF00FF; text-shadow: 0 0 20px rgba(255,0,255,0.4); }
    #wishModal .modal .form-group label { color: rgba(255,255,255,0.7); }
    #wishModal .modal .form-group input, #wishModal .modal .form-group select, #wishModal .modal .form-group textarea { background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.2); color: #fff; caret-color: #FF00FF; }
    #wishModal .modal .form-group input:focus, #wishModal .modal .form-group select:focus, #wishModal .modal .form-group textarea:focus { background: rgba(255,0,255,0.18); transform: translate(2px,2px); box-shadow: none; }
    #wishModal .modal .form-group input::placeholder, #wishModal .modal .form-group textarea::placeholder { color: rgba(255,255,255,0.28); }
    #wishModal .modal .img-upload { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.25); color: rgba(255,255,255,0.6); }
    #wishModal .modal .img-upload:hover { background: rgba(255,0,255,0.2); }
    #wishModal .modal small { color: rgba(255,255,255,0.4) !important; }
    #wishModal .modal .multiselect-trigger { background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.2); color: #fff; }
    #wishModal .modal .multiselect-trigger.open, #wishModal .modal .multiselect-trigger:focus { background: rgba(255,0,255,0.25); }
    #wishModal .modal .multiselect-panel { background: #200040; border-color: rgba(255,0,255,0.4); }
    #wishModal .modal .multiselect-option { color: #fff; border-color: rgba(255,255,255,0.1); }
    #wishModal .modal .multiselect-option:hover, #wishModal .modal .multiselect-option.selected { background: rgba(255,0,255,0.35); }
    #wishModal .modal #wishDeleteSection { border-color: rgba(255,255,255,0.2); }
    /* Feed entity links */
    .feed-link { cursor: pointer; text-decoration: underline; font-weight: 700; color: #000; }
    /* Forms */
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 5px; color: #000; }
    /* Global input reset ‚Äî prevent white caret on white bg */
    input, textarea, select { color: #000; background: #fff; caret-color: #000; }
    .form-group label .required { color: var(--nb-magenta); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 2px solid #000; box-shadow: var(--nb-shadow-sm); background: #fff; color: #000; caret-color: #000; font-size: 0.95rem; font-weight: 600; border-radius: 6px; outline: none; font-family: inherit; transition: box-shadow 0.1s, transform 0.1s, background 0.1s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { box-shadow: none; transform: translate(2px,2px); background: var(--nb-yellow); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: flex; gap: 12px; }
    .form-row .form-group { flex: 1; }
    .form-row .form-group:last-child { flex: 0 0 90px; }
    .form-actions { display: flex; gap: 12px; margin-top: 20px; }
    .form-actions .btn { flex: 1; }
    .form-actions-split { display: flex; gap: 12px; margin-top: 20px; }
    .form-actions-split .btn { flex: 1; }
    .error-msg { font-size: 0.7rem; color: var(--nb-red); margin-top: 4px; font-weight: 700; text-transform: uppercase; }
    /* Img upload */
    .img-upload { border: 3px dashed #000; padding: 24px; text-align: center; cursor: pointer; transition: background 0.15s; background: #fff; color: #000; border-radius: 8px; }
    .img-upload:hover, .img-upload.dragover { background: var(--nb-yellow); }
    .img-upload input { display: none; }
    .img-preview { max-width: 100%; max-height: 200px; border: 2px solid #000; margin-top: 12px; }
    .wl-add-img { min-height: 80px; overflow: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .wl-add-img .img-preview { max-width: 100%; max-height: 120px; object-fit: contain; margin-top: 0; }
    /* Multiselect */
    .multiselect-wrap { position: relative; }
    .multiselect-trigger { display: flex; align-items: center; flex-wrap: wrap; gap: 6px; min-height: 42px; padding: 8px 12px; background: #fff; border: 2px solid #000; box-shadow: var(--nb-shadow-sm); cursor: pointer; font-size: 0.9rem; border-radius: 6px; font-family: inherit; }
    .multiselect-trigger:focus { outline: none; background: var(--nb-yellow); }
    .multiselect-trigger.open { background: var(--nb-yellow); }
    .multiselect-placeholder { color: #999; font-size: 0.85rem; }
    .multiselect-chip { background: #000; color: #fff; padding: 2px 8px; font-size: 0.72rem; font-weight: 700; border-radius: 4px; }
    .multiselect-panel { display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 2px; max-height: 200px; overflow-y: auto; background: #fff; border: 2px solid #000; z-index: 100; box-shadow: var(--nb-shadow); }
    .multiselect-wrap.open .multiselect-panel { display: block; }
    .multiselect-option { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #000; font-weight: 600; font-size: 0.9rem; }
    .multiselect-option:last-child { border-bottom: none; }
    .multiselect-option:hover, .multiselect-option.selected { background: var(--nb-yellow); }
    /* Skeleton */
    .skeleton { background: linear-gradient(90deg, #ddd 25%, #eee 50%, #ddd 75%); background-size: 200% 100%; animation: skeleton 1.2s ease-in-out infinite; border: 2px solid #000; border-radius: 8px; }
    .skeleton-text { height: 16px; margin-bottom: 8px; }
    .skeleton-btn { height: 44px; }
    .skeleton-recent { height: 52px; margin-bottom: 10px; }
    @keyframes skeleton { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.5); }
    .empty-state p { margin-bottom: 16px; font-weight: 700; text-transform: uppercase; font-size: 0.85rem; }
    .empty-cats { font-size: 0.8rem; color: #999; margin: 8px 0; font-weight: 600; text-transform: uppercase; }
    /* Privacy badge (public view) */
    .privacy-badge { font-size: 0.58rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; padding: 2px 6px; border: 1px solid #000; }
    .wl-header-actions { margin-left: auto; display: flex; gap: 8px; }
    /* WL section (public view / read-only) */
    .wl-section { margin-bottom: 20px; border: var(--nb-border); border-radius: var(--nb-radius); overflow: hidden; box-shadow: var(--nb-shadow); background: #fff; color: #000; }
    .wl-section-header { padding: 12px 14px; display: flex; align-items: center; gap: 12px; border-bottom: var(--nb-border); }
    .wl-section-img { width: 40px; height: 40px; object-fit: cover; border: 2px solid #000; border-radius: 6px; }
    .wl-section-title { font-weight: 900; font-size: 0.92rem; text-transform: uppercase; }
    .wl-section-body { padding: 12px 14px; }
    .categories-section { margin: 16px 0; }
    .category-title { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; color: #555; }
    .category-title .count { font-weight: 900; color: #000; }
    .wishlist { margin-top: 10px; }
    /* Analysis overlay */
    .analysis-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
    .analysis-overlay.visible { display: flex; }
    .analysis-spinner { width: 48px; height: 48px; border: 4px solid #333; border-top-color: var(--nb-yellow); border-radius: 50%; animation: spin 0.8s linear infinite; }
    .analysis-overlay span { color: #fff; font-size: 0.95rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Live feed ‚Äî compact ticker style */
    .feed-container { padding: 4px 0 16px; }
    .feed-item { display: flex; align-items: center; gap: 8px; padding: 3px 0; animation: feedIn 0.3s ease-out; }
    .feed-item-ts { flex-shrink: 0; font-size: 0.68rem; font-weight: 700; color: rgba(255,255,255,0.35); letter-spacing: 0.03em; font-variant-numeric: tabular-nums; }
    .feed-item-track { flex: 1; overflow: hidden; position: relative; }
    .feed-item-inner { display: inline-block; white-space: nowrap; font-size: 0.82rem; font-weight: 600; color: rgba(255,255,255,0.88); line-height: 1.6; }
    .feed-item-inner.is-scrolling { animation: feedTicker 9s ease-in-out infinite alternate; }
    @keyframes feedTicker { 0%, 15% { transform: translateX(0); } 85%, 100% { transform: translateX(var(--scroll-px, 0px)); } }
    .feed-link { color: #FF00FF; font-weight: 700; cursor: pointer; text-decoration: none; }
    .feed-link:hover { text-decoration: underline; }
    @keyframes feedIn { from { opacity: 0; transform: translateX(-6px); } to { opacity: 1; transform: none; } }
    .feed-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 2px 0; }
    /* Section title */
    .section-title { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: rgba(255,255,255,0.5); margin-bottom: 12px; }
    /* Recent items */
    .recent-list { display: flex; flex-direction: column; gap: 8px; }
    .recent-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff; border: 2px solid #000; border-radius: 12px; box-shadow: var(--nb-shadow-sm); cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; }
    .recent-item:active { transform: translate(2px,2px); box-shadow: none; }
    .recent-item img { width: 44px; height: 44px; object-fit: cover; border: 2px solid #000; border-radius: 6px; }
    /* Back button */
    .back-btn { background: #fff; color: #000; border: var(--nb-border); box-shadow: var(--nb-shadow-sm); padding: 8px 12px; border-radius: 8px; font-weight: 700; text-transform: uppercase; font-size: 0.72rem; cursor: pointer; margin-bottom: 16px; transition: transform 0.1s, box-shadow 0.1s; font-family: inherit; }
    .back-btn:active { transform: translate(2px,2px); box-shadow: none; }
    /* WL items (old compat) */
    .wl-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff; border: var(--nb-border); border-radius: var(--nb-radius); margin-bottom: 10px; box-shadow: var(--nb-shadow); content-visibility: auto; contain-intrinsic-size: auto 72px; }
    .wl-item-img { width: 48px; height: 48px; object-fit: cover; border: 2px solid #000; border-radius: 6px; background: #eee; }
    .wl-item-body { flex: 1; }
    .wl-item-remove { color: var(--nb-red); cursor: pointer; padding: 4px; font-size: 1.1rem; }
    .wl-item-edit { color: #000; cursor: pointer; padding: 4px; font-size: 0.9rem; }
    /* View readonly */
    .view-readonly .btn-edit, .view-readonly .btn-del, .view-readonly .btn-move, .view-readonly .wish-card-edit, .view-readonly .wish-card-del, .view-readonly .wish-card-move { display: none !important; }
    /* Scrollbar hide */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* Wl form section */
    .wl-form-section { margin-top: 20px; background: #fff; border: var(--nb-border); border-radius: var(--nb-radius); padding: 16px; box-shadow: var(--nb-shadow-sm); }
    /* Cat add row */
    .cat-add { display: flex; gap: 8px; margin-top: 12px; }
    .cat-add input { flex: 1; }
    .tag-form-row { display: flex; }
    /* Hero area (home page) */
    .hero-section { padding: 4px 0 8px; text-align: center; }
    .hero-feed-title { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255,255,255,0.5); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .hero-feed-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--nb-magenta); box-shadow: 0 0 6px rgba(255,0,255,0.7); animation: dotPulse 2s ease-in-out infinite; }
    @keyframes dotPulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }
    @media (min-width: 480px) {
      .modal { border-radius: 20px; margin: auto 16px 16px; }
    }
  </style>
</head>
<body>
  <!-- Splash screen with Logo Animation -->
  <div class="splash-screen" id="splashScreen">
    <dotlottie-player src="Loader.lottie" autoplay loop class="splash-lottie"></dotlottie-player>
  </div>

  <!-- Animated background blobs -->
  <div class="bg-blobs">
    <div class="bg-blob-1"></div>
    <div class="bg-blob-2"></div>
    <div class="bg-blob-3"></div>
  </div>

  <div class="app-shell">
    <header class="app-header" id="mainHeader">
      <img src="logo-main.png?v=2" alt="I Want That So Bad" class="app-logo">
    </header>

    <div class="action-buttons" id="actionButtons">
      <button type="button" class="action-btn photo" id="addByPhotoBtn" data-i18n-title="btn_add_photo_title" title="–ü–æ —Ñ–æ—Ç–æ—á–∫–µ">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
      </button>
      <button type="button" class="action-btn link" id="addByLinkBtn" data-i18n-title="btn_add_link_title" title="–ü–æ –ª–∏–Ω–∫—É">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
      </button>
    </div>
    <input type="file" id="addByPhotoInput" accept="image/*" capture="environment" style="display:none">

    <div class="container">
    <div id="content">
      <div class="main-buttons">
        <button class="btn" data-nav="manageWishlists" onclick="window.__nav&&window.__nav('manageWishlists')">–í–∏—à–ª–∏—Å—Ç—ã</button>
        <button class="btn btn-secondary" data-nav="manageCategories" onclick="window.__nav&&window.__nav('manageCategories')">–¢–µ–≥–∏</button>
        <button class="btn btn-secondary" data-nav="manageWishes" onclick="window.__nav&&window.__nav('manageWishes')">–ñ–µ–ª–∞–Ω–∏—è</button>
      </div>
      <h3 class="section-title">Live Feed</h3>
      <div class="recent-list"><p style="color:#999;font-size:0.85rem;font-weight:700;text-transform:uppercase;" data-i18n="feed_loading">–°–µ–∫—É–Ω–¥—É...</p></div>
    </div>
    </div>
  </div>

  <nav class="tab-bar" id="tabBar">
    <button type="button" class="tab-item" data-nav="main" id="tabHome" aria-label="–î–æ–º–æ–π">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span data-i18n="nav_home">–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button type="button" class="tab-item" data-nav="manageWishlists" id="tabWishlists" aria-label="–í–∏—à–ª–∏—Å—Ç—ã">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
      <span data-i18n="nav_wishlists">–ú–æ–∏ –ª–∏—Å—Ç—ã</span>
    </button>
    <button type="button" class="tab-item" data-nav="manageCategories" id="tabTags" aria-label="–¢–µ–≥–∏">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/></svg>
      <span data-i18n="nav_tags">–õ–µ–π–±–ª—ã</span>
    </button>
    <button type="button" class="tab-item" data-nav="manageWishes" id="tabWishes" aria-label="–ñ–µ–ª–∞–Ω–∏—è">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
      <span data-i18n="nav_wishes">–ñ–µ–ª–∞–Ω–∏—è</span>
    </button>
  </nav>

  <div class="analysis-overlay" id="analysisOverlay">
    <div class="css-loader"></div>
    <span id="analysisOverlayText" data-i18n="overlay_analyzing_image">–°–º–æ—Ç—Ä–∏–º —Ñ–æ—Ç–æ...</span>
  </div>

  <!-- Wish modal -->
  <div class="modal-overlay" id="wishModal">
    <div class="modal">
      <h2 id="wishModalTitle" data-i18n="modal_add_wish">–ù–æ–≤–∞—è —à—Ç—É–∫–∞</h2>
      <form id="wishForm">
        <input type="hidden" id="wishId">
        <div class="form-group">
          <label><span class="required">*</span> <span data-i18n="wish_image_label_text">–ö–∞—Ä—Ç–∏–Ω–∫–∞</span></label>
          <div class="img-upload" id="imgUpload">
            <input type="file" id="wishImage" accept="image/*" capture="environment">
            <span id="imgUploadText" data-i18n="wish_image_placeholder">–¢–∞–ø–Ω–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç—è–Ω–∏ —Ñ–æ—Ç–æ</span>
            <img id="imgPreview" class="img-preview" style="display:none;" alt="">
          </div>
          <div id="imgError" class="error-msg" style="display:none;"></div>
        </div>
        <div class="form-group">
          <label><span class="required">*</span> <span data-i18n="wish_name_label_text">–ù–∞–∑–≤–∞–Ω–∏–µ</span> <span id="nameCounter">0/100</span></label>
          <input type="text" id="wishName" maxlength="100" data-i18n-placeholder="wish_name_placeholder">
          <div id="nameError" class="error-msg" style="display:none;"></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label data-i18n="wish_price_label">–ü—Ä–∞–π—Å</label>
            <input type="number" id="wishPrice" min="0" max="9999999" step="0.01" placeholder="0">
            <div id="priceError" class="error-msg" style="display:none;"></div>
          </div>
          <div class="form-group">
            <label data-i18n="wish_currency_label">–ß–µ–º –ø–ª–∞—Ç–∏–º</label>
            <select id="wishCurrency">
              <option value="">‚Äî</option>
              <option value="‚Ç¨">‚Ç¨</option>
              <option value="$">$</option>
              <option value="Br">Br</option>
              <option value="‚ÇΩ">‚ÇΩ</option>
              <option value="‚Ç∏">‚Ç∏</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label data-i18n="wish_size_label">–†–∞–∑–º–µ—Ä</label>
          <input type="text" id="wishSize" placeholder="M, 42, XL">
          <div id="sizeError" class="error-msg" style="display:none;"></div>
        </div>
        <div class="form-group">
          <label data-i18n="wish_link_label">–°—Å—ã–ª–∫–∞</label>
          <input type="url" id="wishLink" data-i18n-placeholder="wish_link_placeholder">
          <div id="linkError" class="error-msg" style="display:none;"></div>
        </div>
        <div class="form-group">
          <label><span data-i18n="wish_comment_label">–ó–∞–º–µ—Ç–∫–∞</span> <span id="commentCounter">0/500</span></label>
          <textarea id="wishComment" maxlength="500" data-i18n-placeholder="wish_comment_placeholder"></textarea>
        </div>
        <div class="form-group">
          <label data-i18n="wish_category_label">–õ–µ–π–±–ª</label>
          <select id="wishCategory">
            <option value="" data-i18n="wish_category_none">–ë–µ–∑ –ª–µ–π–±–ª–∞</option>
          </select>
        </div>
        <div class="form-group">
          <label data-i18n="wish_wl_label">–ö—É–¥–∞ –¥–æ–±–∞–≤–∏—Ç—å</label>
          <div class="multiselect-wrap" id="wishWishlistSelect"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="wishCancel" data-i18n="btn_cancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn" data-i18n="btn_save">–ì–æ—Ç–æ–≤–æ</button>
        </div>
        <div id="wishDeleteSection" style="display:none;margin-top:16px;padding-top:16px;border-top:2px solid #000;">
          <button type="button" class="btn" id="wishDeleteBtn" style="width:100%;background:#FF0000;color:#fff;" data-i18n="btn_delete_wish">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Categories modal -->
  <div class="modal-overlay" id="catsModal">
    <div class="modal">
      <h2>–ü—Ä–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
      <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
        –£–¥–∞–ª—è–π –Ω–µ–Ω—É–∂–Ω—ã–µ –∏ –¥–æ–±–∞–≤–ª—è–π —Å–≤–æ–∏. –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.
      </p>
      <div class="cat-list" id="catList"></div>
      <div class="cat-add">
        <input type="text" id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
        <button type="button" class="btn" id="addCatBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="form-actions" style="margin-top:20px;">
        <button type="button" class="btn btn-secondary" id="catsClose" data-i18n="btn_close">–ü–æ–Ω—è—Ç–Ω–æ</button>
      </div>
    </div>
  </div>

  <!-- Wishlists modal -->
  <div class="modal-overlay" id="wlModal">
    <div class="modal">
      <h2>–ü—Ä–∞–≤–∏—Ç—å –≤–∏—à–ª–∏—Å—Ç—ã</h2>
      <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
        –í–∏—à–ª–∏—Å—Ç ‚Äî –ø–∞–ø–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∂–µ–ª–∞–Ω–∏–π. –î–æ–±–∞–≤–ª—è–π, —É–¥–∞–ª—è–π, –ø–µ—Ä–µ–Ω–æ—Å–∏ –∫–∞—Ä—Ç–æ—á–∫–∏.
      </p>
      <div class="cat-list" id="wlList"></div>
      <div style="margin-top:16px;" id="wlAddForm">
        <div class="form-group">
          <label><span class="required">*</span> –ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" id="newWlName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏—à–ª–∏—Å—Ç–∞">
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
          <select id="newWlPrivacy">
            <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π ‚Äî —Ç–æ–ª—å–∫–æ –≤—ã</option>
            <option value="public">–ü—É–±–ª–∏—á–Ω—ã–π ‚Äî –ª—é–±–æ–π –ø–æ —Å—Å—ã–ª–∫–µ –º–æ–∂–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</option>
            <option value="shared">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π ‚Äî —Å–æ–∞–≤—Ç–æ—Ä—ã –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
          <div class="img-upload wl-add-img" id="wlImgUpload">
            <input type="file" id="wlImage" accept="image/*">
            <span id="wlImgText">–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
            <img id="wlImgPreview" class="img-preview" style="display:none;max-height:120px;" alt="">
          </div>
        </div>
        <button type="button" class="btn" id="addWlBtn">–î–æ–±–∞–≤–∏—Ç—å –≤–∏—à–ª–∏—Å—Ç</button>
      </div>
      <div id="wlEditForm" style="display:none;">
        <div class="form-group">
          <label><span class="required">*</span> –ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" id="editWlName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏—à–ª–∏—Å—Ç–∞">
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
          <select id="editWlPrivacy">
            <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
            <option value="public">–ü—É–±–ª–∏—á–Ω—ã–π</option>
            <option value="shared">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
          <div class="img-upload wl-add-img" id="wlImgUploadEdit">
            <input type="file" id="wlImageEdit" accept="image/*">
            <span id="wlImgTextEdit">–û–±–ª–æ–∂–∫–∞</span>
            <img id="wlImgPreviewEdit" class="img-preview" style="display:none;max-height:120px;" alt="">
          </div>
        </div>
        <div id="wlEditFormExtras"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="editWlCancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn" id="editWlSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div class="form-actions" style="margin-top:20px;">
        <button type="button" class="btn btn-secondary" id="wlClose" data-i18n="btn_close">–ü–æ–Ω—è—Ç–Ω–æ</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="shareWlModal">
    <div class="modal">
      <h2 data-i18n="share_wl_title">–®–µ—Ä–∏—Ç—å –ª–∏—Å—Ç</h2>
      <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:12px;" data-i18n="share_wl_desc">–ö–∏–Ω—å —Å—Å—ã–ª–∫—É –≤ –¢–µ–ª–µ–≥—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±–æ—Ç–µ. –ö—Ç–æ –ø–µ—Ä–µ–π–¥—ë—Ç, —É–≤–∏–¥–∏—Ç –ª–∏—Å—Ç –∏ —Å–º–æ–∂–µ—Ç –∑–∞–±—É–∫–∞—Ç—å —Ö–æ—Ç–µ–ª–∫–∏.</p>
      <div class="share-link" id="shareWlLink" style="word-break:break-all;padding:12px;background:var(--bg-card);border-radius:8px;font-size:0.85rem;"></div>
      <p id="shareWlHint" style="display:none;color:var(--accent);font-size:0.8rem;margin-top:8px;">–ß—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞—Å—å –≤ –±–æ—Ç–µ, —É–∫–∞–∂–∏ <code>wantthat_bot</code> –∏ <code>wantthat</code> –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞.</p>
      <div class="form-actions" style="margin-top:16px;">
        <button type="button" class="btn btn-secondary" id="shareWlClose" data-i18n="btn_close">–ü–æ–Ω—è—Ç–Ω–æ</button>
        <button type="button" class="btn" id="shareWlCopy" data-i18n="btn_copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="shareWelcomeModal">
    <div class="modal">
      <h2 data-i18n="share_wl_title">–®–µ—Ä–∏—Ç—å –ª–∏—Å—Ç</h2>
      <p id="shareWelcomeText" style="color:var(--text-secondary);font-size:0.95rem;margin-bottom:20px;"></p>
      <button type="button" class="btn" id="shareWelcomeOk" data-i18n="btn_got_it">–û–∫–µ–π</button>
    </div>
  </div>

  <div class="modal-overlay" id="inviteConsentModal">
    <div class="modal">
      <h2 data-i18n="invite_modal_title">–ò–Ω–≤–∞–π—Ç</h2>
      <p id="inviteConsentText" style="color:var(--text-secondary);font-size:0.95rem;margin-bottom:20px;"></p>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="inviteConsentDecline" data-i18n="btn_decline">–ù–µ, —Å–ø—Å</button>
        <button type="button" class="btn" id="inviteConsentAccept" data-i18n="btn_accept">–ü–æ–≥–Ω–∞–ª–∏</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="inviteWlModal">
    <div class="modal">
      <h2 data-i18n="invite_wl_title">–ü–æ–∑–≤–∞—Ç—å —Å–æ–∞–≤—Ç–æ—Ä–∞</h2>
      <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:12px;" data-i18n="invite_wl_desc">–ö–∏–Ω—å —Å—Å—ã–ª–∫—É –≤ –¢–µ–ª–µ–≥—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±–æ—Ç–µ, —á–µ–ª–æ–≤–µ–∫ —Å—Ç–∞–Ω–µ—Ç —Å–æ–∞–≤—Ç–æ—Ä–æ–º –∏ —Å–º–æ–∂–µ—Ç —Ä–µ–¥–∞—á–∏—Ç—å –ª–∏—Å—Ç.</p>
      <div class="share-link" id="inviteWlLink" style="word-break:break-all;padding:12px;background:var(--bg-card);border-radius:8px;font-size:0.85rem;"></div>
      <p id="inviteWlHint" style="display:none;color:var(--accent);font-size:0.8rem;margin-top:8px;">–ß—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞—Å—å –≤ –±–æ—Ç–µ, —É–∫–∞–∂–∏ <code>TELEGRAM_BOT</code> –∏ <code>TELEGRAM_APP</code> –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞.</p>
      <div class="form-actions" style="margin-top:16px;">
        <button type="button" class="btn btn-secondary" id="inviteWlClose" data-i18n="btn_close">–ü–æ–Ω—è—Ç–Ω–æ</button>
        <button type="button" class="btn" id="inviteWlCopy" data-i18n="btn_copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // --- Supabase: –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –∏–∑ GitHub Secrets (SUPABASE_URL, SUPABASE_ANON_KEY) ---
    const SUPABASE_URL = '__SUPABASE_URL__';
    const SUPABASE_ANON_KEY = '__SUPABASE_ANON_KEY__';
    let sb = null;
    // --- API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å –≥–ª–∞–≤–Ω–æ–π (–ø–æ —Ñ–æ—Ç–æ / –ø–æ —Å—Å—ã–ª–∫–µ): –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –∏–∑ GitHub Secret LINK_SCRAPER_URL ---
    const _apiFromDeploy = ('__LINK_SCRAPER_URL__'.indexOf('__') === 0 ? '' : '__LINK_SCRAPER_URL__'.replace(/\/$/, ''));
    const _apiFromQuery = (() => { const p = new URLSearchParams(location.search); const u = p.get('api'); return (u && u.startsWith('http')) ? u.replace(/\/$/, '') : ''; })();
    const _raw = _apiFromDeploy || _apiFromQuery;
    const API_BASE_URL = _raw ? (_raw.startsWith('http://') ? 'https' + _raw.slice(4) : _raw) : '';
    function ensureHttps(u) { return (u && u.startsWith('http://')) ? 'https' + u.slice(4) : u; }
    const useSupabase = !!(SUPABASE_URL && SUPABASE_ANON_KEY);
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        if (document.querySelector('script[src="' + src + '"]')) { resolve(); return; }
        const s = document.createElement('script'); s.src = src;
        s.onload = () => resolve(); s.onerror = reject;
        document.head.appendChild(s);
      });
    }
    const WISH_IMAGES_BUCKET = 'wish-images';
    async function uploadImageToSupabaseStorage(dataUrl) {
      if (!sb || !dataUrl || typeof dataUrl !== 'string' || !dataUrl.startsWith('data:image/')) return null;
      try {
        const m = dataUrl.match(/^data:(image\/\w+);base64,(.+)$/);
        if (!m) return null;
        const type = m[1];
        const base64 = m[2];
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        const blob = new Blob([bytes], { type: type });
        const ext = type === 'image/png' ? 'png' : 'jpg';
        const path = `${(currentUserId || 'user').replace(/\s/g, '_')}_${Date.now()}_${Math.random().toString(36).slice(2, 10)}.${ext}`;
        const { error } = await sb.storage.from(WISH_IMAGES_BUCKET).upload(path, blob, { contentType: type, upsert: false });
        if (error) return null;
        const { data: urlData } = sb.storage.from(WISH_IMAGES_BUCKET).getPublicUrl(path);
        return urlData?.publicUrl || null;
      } catch (e) {
        return null;
      }
    }

    async function loadSupabase() {
      if (sb) return;
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;
      await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });
    }
    let _lzReady = null;
    async function ensureLzString() {
      if (typeof LZString !== 'undefined') return;
      if (_lzReady) return _lzReady;
      _lzReady = loadScript('https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js');
      await _lzReady;
    }

    // --- Telegram Bot: –¥–ª—è —Å—Å—ã–ª–æ–∫ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª / ¬´–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å¬ª ‚Äî —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã–≤–∞–ª–∏—Å—å –≤ –±–æ—Ç–µ ---
    // –£–∫–∞–∂–∏ username –±–æ—Ç–∞ (–±–µ–∑ @) –∏ short_name Mini App –∏–∑ BotFather
    const TELEGRAM_BOT = 'wantthat_bot';
    const TELEGRAM_APP = 'wantthat';

    const tg = window.Telegram?.WebApp;

    // ‚îÄ‚îÄ‚îÄ i18n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const STRINGS = {
      ru: {
        nav_home:'–ì–ª–∞–≤–Ω–∞—è', nav_wishlists:'–ú–æ–∏ –ª–∏—Å—Ç—ã', nav_tags:'–õ–µ–π–±–ª—ã', nav_wishes:'–ñ–µ–ª–∞–Ω–∏—è',
        btn_add_photo_title:'–ü–æ —Ñ–æ—Ç–æ—á–∫–µ', btn_add_link_title:'–ü–æ –ª–∏–Ω–∫—É',
        feed_title:'–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å', feed_loading:'–°–µ–∫—É–Ω–¥—É...', feed_empty:'–ù–∞—á–Ω–∏ —Å —Ñ–æ—Ç–æ –∏–ª–∏ –ª–∏–Ω–∫–∞ üíÖ',
        feed_added_to_wl:'–¢—ã –¥–æ–±–∞–≤–∏–ª {wish} –≤ {wl} ‚ú®',
        feed_added_to_list:'{wish} –≤ —Ç–≤–æ—ë–º –ª–∏—Å—Ç–µ {wl} ‚ú®',
        feed_reserved_private:'{user} –∑–∞–±—É–∫–∞–ª —á—Ç–æ-—Ç–æ –≤ —Ç–≤–æ—ë–º {wl} ü§©‚ù§Ô∏è',
        feed_reserved_public:'{user} –∑–∞–±—É–∫–∞–ª {wish} –∏–∑ {wl} ü§©‚ù§Ô∏è',
        feed_i_reserved:'–¢—ã –∑–∞–±—É–∫–∞–ª {wish} –∏–∑ {wl} üò≥',
        btn_new_wishlist:'üíÖ –ù–æ–≤—ã–π slay-–ª–∏—Å—Ç',
        wl_empty:'–õ–∏—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç üíî', wl_empty_hint:'–ñ–º–∏ –≤—ã—à–µ –∏ –Ω–∞—á–∏–Ω–∞–π',
        pr_private:'–ü—Ä–∏–≤–∞—Ç–Ω—ã–π', pr_public:'–ü—É–±–ª–∏—á–Ω—ã–π', pr_shared:'–°–æ–≤–º–µ—Å—Ç–Ω—ã–π',
        btn_share:'‚Üó –®–µ—Ä–∏—Ç—å', btn_invite:'+ –ò–Ω–≤–∞–π—Ç –¥—Ä—É–≥–∞', btn_leave:'–õ–∏–≤–Ω—É—Ç—å',
        create_wl_title:'–ù–æ–≤—ã–π slay-–ª–∏—Å—Ç üíÖ',
        create_wl_name_label:'–ö–∞–∫ –Ω–∞–∑–æ–≤—ë–º?', create_wl_name_placeholder:'–ù–∞–ø—Ä–∏–º–µ—Ä: Birthday Bash 2026 üéÇ',
        create_wl_cover_label:'–ö–∞—Ä—Ç–∏–Ω–∫–∞', btn_add_cover:'üì∑ –í—ã–±—Ä–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É', cover_selected:'‚úì –§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ',
        create_wl_privacy_label:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞',
        privacy_private_opt:'üîí –°–µ–∫—Ä–µ—Ç–Ω—ã–π', privacy_public_opt:'üëÅ –î–ª—è –≤—Å–µ—Ö', privacy_shared_opt:'ü§ù –° –¥—Ä—É–∑—å—è–º–∏',
        btn_back:'–ù–∞–∑–∞–¥', btn_create:'–ü–æ–≥–Ω–∞–ª–∏ üéâ',
        edit_wl_title:'–ò–∑–º–µ–Ω–∏—Ç—å',
        edit_wl_name_label:'–ù–∞–∑–≤–∞–Ω–∏–µ *', edit_wl_name_placeholder:'–ö–∞–∫ –Ω–∞–∑–≤–∞—Ç—å?',
        edit_wl_privacy_label:'–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å', edit_wl_cover_label:'–ö–∞—Ä—Ç–∏–Ω–∫–∞',
        btn_change_cover:'üì∑ –°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ', btn_cancel:'–û—Ç–º–µ–Ω–∞', btn_save:'–ì–æ—Ç–æ–≤–æ',
        btn_delete_wl:'üóë –£–¥–∞–ª–∏—Ç—å', btn_delete_wl_confirm:'‚ö†Ô∏è –¢–∞–ø–Ω–∏ –µ—â—ë —Ä–∞–∑ ‚Äî —É–¥–∞–ª–∏—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞',
        deleting:'–£–±–∏—Ä–∞–µ–º...', btn_leave_wl:'–õ–∏–≤–Ω—É—Ç—å',
        kick_collab_label:'–ö–∏–∫–Ω—É—Ç—å —Å–æ–∞–≤—Ç–æ—Ä–∞', kick_collab_placeholder:'‚Äî –ö–æ–≥–æ —É–±—Ä–∞—Ç—å? ‚Äî', btn_kick:'–ö–∏–∫–Ω—É—Ç—å',
        btn_add_wish_to_wl:'+ –ù–æ–≤–∞—è —à—Ç—É–∫–∞', btn_invite_chip:'+ –ò–Ω–≤–∞–π—Ç –¥—Ä—É–≥–∞', btn_share_chip:'‚Üó –®–µ—Ä–∏—Ç—å',
        filter_by_date:'–ü–æ –¥–∞—Ç–µ', filter_az:'A-Z', filter_all_tags:'–í—Å–µ –ª–µ–π–±–ª—ã', filter_no_tags:'–ë–µ–∑ –ª–µ–π–±–ª–æ–≤',
        filter_all_lists:'–í—Å–µ –ª–∏—Å—Ç—ã', btn_add_wish:'+ –ù–æ–≤–∞—è —à—Ç—É–∫–∞', wishes_empty:'–ü—É—Å—Ç–æ.',
        modal_add_wish:'–ù–æ–≤–∞—è —à—Ç—É–∫–∞', modal_edit_wish:'–ò–∑–º–µ–Ω–∏—Ç—å',
        modal_from_link:'–ß–µ–∫–Ω–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–∏–Ω–∫–∞', modal_from_text:'–ß–µ–∫–Ω–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞', modal_from_image:'–ß–µ–∫–Ω–∏ –¥–∞–Ω–Ω—ã–µ —Å —Ñ–æ—Ç–æ',
        wish_image_label:'* –ö–∞—Ä—Ç–∏–Ω–∫–∞', wish_image_placeholder:'–¢–∞–ø–Ω–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç—è–Ω–∏ —Ñ–æ—Ç–æ', wish_image_change:'–°–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É',
        wish_name_label:'* –ù–∞–∑–≤–∞–Ω–∏–µ', wish_name_placeholder:'–ù–∞–∑–≤–∞–Ω–∏–µ —à—Ç—É–∫–∏',
        wish_price_label:'–ü—Ä–∞–π—Å', wish_currency_label:'–ß–µ–º –ø–ª–∞—Ç–∏–º', wish_size_label:'–†–∞–∑–º–µ—Ä',
        wish_link_label:'–°—Å—ã–ª–∫–∞', wish_link_placeholder:'–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É',
        wish_comment_label:'–ó–∞–º–µ—Ç–∫–∞', wish_comment_placeholder:'–ß—Ç–æ –µ—â—ë –¥–æ–±–∞–≤–∏—Ç—å',
        wish_category_label:'–õ–µ–π–±–ª', wish_category_none:'–ë–µ–∑ –ª–µ–π–±–ª–∞',
        wish_wl_label:'–ö—É–¥–∞ –¥–æ–±–∞–≤–∏—Ç—å', wish_wl_placeholder:'–í—ã–±–µ—Ä–∏ –ª–∏—Å—Ç—ã', wish_wl_empty:'–õ–∏—Å—Ç–æ–≤ –Ω–µ—Ç',
        autofilled:'(–∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–æ–º)',
        btn_delete_wish:'üóë –£–¥–∞–ª–∏—Ç—å', confirm_delete_wish:'–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?',
        btn_new_tag:'+ –ù–æ–≤—ã–π –ª–µ–π–±–ª', tag_placeholder:'–ö–∞–∫ –Ω–∞–∑–≤–∞—Ç—å?',
        tags_empty:'–õ–µ–π–±–ª–æ–≤ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π!',
        btn_delete_tags:'üóë –°–Ω–µ—Å—Ç–∏ –ª–µ–π–±–ª—ã', btn_delete_tags_select:'üóë –¢–∞–ø–Ω–∏ –ª–µ–π–±–ª—ã, –ø–æ—Ç–æ–º –∂–º–∏ —Å—é–¥–∞',
        share_wl_title:'–®–µ—Ä–∏—Ç—å –ª–∏—Å—Ç',
        share_wl_desc:'–ö–∏–Ω—å —Å—Å—ã–ª–∫—É –≤ –¢–µ–ª–µ–≥—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±–æ—Ç–µ. –ö—Ç–æ –ø–µ—Ä–µ–π–¥—ë—Ç, —É–≤–∏–¥–∏—Ç –ª–∏—Å—Ç –∏ —Å–º–æ–∂–µ—Ç –∑–∞–±—É–∫–∞—Ç—å —Ö–æ—Ç–µ–ª–∫–∏.',
        btn_close:'–ü–æ–Ω—è—Ç–Ω–æ', btn_copy:'–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', copied:'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!',
        share_welcome_msg:'{owner} —à–µ—Ä–Ω—É–ª —Å —Ç–æ–±–æ–π –ª–∏—Å—Ç ¬´{name}¬ª. –ú–æ–∂–µ—à—å –∑–∞–±—É–∫–∞—Ç—å –ª—é–±—É—é —Ö–æ—Ç–µ–ª–∫—É.',
        btn_got_it:'–û–∫–µ–π',
        invite_wl_title:'–ü–æ–∑–≤–∞—Ç—å —Å–æ–∞–≤—Ç–æ—Ä–∞',
        invite_wl_desc:'–ö–∏–Ω—å —Å—Å—ã–ª–∫—É –≤ –¢–µ–ª–µ–≥—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±–æ—Ç–µ, —á–µ–ª–æ–≤–µ–∫ —Å—Ç–∞–Ω–µ—Ç —Å–æ–∞–≤—Ç–æ—Ä–æ–º –∏ —Å–º–æ–∂–µ—Ç —Ä–µ–¥–∞—á–∏—Ç—å –ª–∏—Å—Ç.',
        invite_modal_title:'–ò–Ω–≤–∞–π—Ç',
        invite_consent_msg:'{owner} –∑–æ–≤—ë—Ç —Ç–µ–±—è —Å–æ–∞–≤—Ç–æ—Ä–æ–º –≤ –ª–∏—Å—Ç ¬´{name}¬ª. –°–º–æ–∂–µ—à—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —Ä–µ–¥–∞—á–∏—Ç—å —Ö–æ—Ç–µ–ª–∫–∏.',
        btn_decline:'–ù–µ, —Å–ø—Å', btn_accept:'–ü–æ–≥–Ω–∞–ª–∏',
        overlay_analyzing_image:'–°–º–æ—Ç—Ä–∏–º —Ñ–æ—Ç–æ...', overlay_loading_card:'–ì—Ä—É–∑–∏–º –∫–∞—Ä—Ç–æ—á–∫—É...',
        overlay_preparing_photo:'–ì–æ—Ç–æ–≤–ª—é —Ñ–æ—Ç–æ...', overlay_sending_photo:'–û—Ç–ø—Ä–∞–≤–ª—è—é —Ñ–æ—Ç–æ...',
        overlay_analyzing:'–ß–µ–∫–∞–µ–º...', overlay_analyzing_link:'–ß–µ–∫–∞–µ–º —Å—Å—ã–ª–∫—É...',
        prompt_link:'–ö–∏–Ω—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä:', err_link_invalid:'–£–∫–∞–∂–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É, —Å https://',
        err_required:'–ù—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å', err_max100:'–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ, –º–∞–∫—Å 100',
        err_chars:'–ú–æ–∂–Ω–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –∑–Ω–∞–∫–∏: - _ . , ! ? ( ) \' " & / | ‚Ä¶',
        err_url:'–°—Å—ã–ª–∫–∞ –∫—Ä–∏–≤–∞—è', err_price:'–ß–∏—Å–ª–æ –æ—Ç 0 –¥–æ 9999999', err_price_decimals:'–î–æ –∫–æ–ø–µ–µ–∫ (2 –∑–Ω–∞–∫–∞)',
        err_size:'–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞ –∏ —Ü–∏—Ñ—Ä—ã', err_max500:'–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ, –º–∞–∫—Å 500',
        err_image_required_photo:'–ù—É–∂–Ω–æ —Ñ–æ—Ç–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏', err_image_required:'–ó–∞–≥—Ä—É–∑–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É',
        err_image_upload:'–ù–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å —Ñ–æ—Ç–æ',
        err_save:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å.',
        err_save_network:'–ù–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å. –ß–µ–∫–Ω–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.',
        btn_refresh:'–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞', err_load:'–ß—ë—Ç –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è.',
        btn_reserve:'–Ø –±–µ—Ä—É', btn_unreserve:'–ü–µ—Ä–µ–¥—É–º–∞–ª', badge_reserved:'–ó–∞–±—É–∫–∞–Ω–æ:',
        tg_share_msg:'–ì–ª—è–Ω—å –º–æ–π –ª–∏—Å—Ç ¬´{name}¬ª!', tg_invite_msg:'–ó–∞—Ö–æ–¥–∏ –≤ –ª–∏—Å—Ç ¬´{name}¬ª —Å–æ–∞–≤—Ç–æ—Ä–æ–º!',
      },
      en: {
        nav_home:'Feed', nav_wishlists:'Wishlists', nav_tags:'Labels', nav_wishes:'Wishes',
        btn_add_photo_title:'Upload pic', btn_add_link_title:'Drop a link',
        feed_title:'Right Now', feed_loading:'Hold on...', feed_empty:'Start with a pic or URL üíÖ',
        feed_added_to_wl:'You added {wish} to {wl} ‚ú®',
        feed_added_to_list:'{wish} now in your {wl} ‚ú®',
        feed_reserved_private:'{user} reserved smth in {wl} ü§©‚ù§Ô∏è',
        feed_reserved_public:'{user} claimed {wish} from {wl} ü§©‚ù§Ô∏è',
        feed_i_reserved:'You claimed {wish} from {wl} üò≥',
        btn_new_wishlist:'üíÖ New slay-list',
        wl_empty:'No wishlists yet üíî', wl_empty_hint:'Tap above to start',
        pr_private:'Private', pr_public:'Public', pr_shared:'Shared',
        btn_share:'‚Üó Share', btn_invite:'+ Invite', btn_leave:'Leave',
        create_wl_title:'New slay-list üíÖ',
        create_wl_name_label:"What's it called?", create_wl_name_placeholder:'Example: Birthday Bash 2026 üéÇ',
        create_wl_cover_label:'Picture', btn_add_cover:'üì∑ Choose image', cover_selected:'‚úì Pic uploaded',
        create_wl_privacy_label:'Access settings',
        privacy_private_opt:'üîí Private', privacy_public_opt:'üëÅ Public', privacy_shared_opt:'ü§ù With friends',
        btn_back:'Back', btn_create:"Let's go üéâ",
        edit_wl_title:'Settings',
        edit_wl_name_label:'Title *', edit_wl_name_placeholder:"What's it called?",
        edit_wl_privacy_label:'Privacy', edit_wl_cover_label:'Picture',
        btn_change_cover:'üì∑ Update pic', btn_cancel:'Cancel', btn_save:'Done',
        btn_delete_wl:'üóë Delete wishlist', btn_delete_wl_confirm:'‚ö†Ô∏è Tap again ‚Äî delete forever',
        deleting:'Deleting...', btn_leave_wl:'Bounce',
        kick_collab_label:'Kick collaborator', kick_collab_placeholder:'‚Äî Choose one ‚Äî', btn_kick:'Kick',
        btn_add_wish_to_wl:'+ New item', btn_invite_chip:'+ Invite', btn_share_chip:'‚Üó Share',
        filter_by_date:'By date', filter_az:'A-Z', filter_all_tags:'All labels', filter_no_tags:'No labels',
        filter_all_lists:'All lists', btn_add_wish:'+ New want', wishes_empty:'Empty.',
        modal_add_wish:'Add want', modal_edit_wish:'Edit wish',
        modal_from_link:'Check data from link', modal_from_text:'Check text data', modal_from_image:'Check image data',
        wish_image_label:'* Picture', wish_image_placeholder:'Tap or drag photo', wish_image_change:'Update pic',
        wish_name_label:'* Name', wish_name_placeholder:'Item name',
        wish_price_label:'Price', wish_currency_label:'Currency', wish_size_label:'Size',
        wish_link_label:'Product link', wish_link_placeholder:'Paste link',
        wish_comment_label:'Note', wish_comment_placeholder:'Anything else',
        wish_category_label:'Label', wish_category_none:'No label',
        wish_wl_label:'Which lists', wish_wl_placeholder:'Select lists', wish_wl_empty:'No wishlists',
        autofilled:'(auto-filled)',
        btn_delete_wish:'üóë Remove', confirm_delete_wish:'Sure to delete?',
        btn_new_tag:'+ Add label', tag_placeholder:"What's it called?",
        tags_empty:'No labels ‚Äî create one!',
        btn_delete_tags:'üóë Delete labels', btn_delete_tags_select:'üóë Tap labels, then press here',
        share_wl_title:'Share wishlist',
        share_wl_desc:'Send the link via Telegram ‚Äî it opens in the bot. Anyone with the link can see your list and claim items.',
        btn_close:'Got it', btn_copy:'Copy', copied:'Copied!',
        share_welcome_msg:'{owner} shared wishlist "{name}" with you. You can claim any item.',
        btn_got_it:'Okay',
        invite_wl_title:'Invite co-author',
        invite_wl_desc:"Send the link via Telegram ‚Äî it opens in the bot, person becomes co-author and can edit the list.",
        invite_modal_title:'Invitation',
        invite_consent_msg:'{owner} invites you to co-author wishlist "{name}". You\'ll be able to add and edit wishes.',
        btn_decline:'Pass', btn_accept:"Let's go",
        overlay_analyzing_image:'Checking image...', overlay_loading_card:'Loading card...',
        overlay_preparing_photo:'Preparing photo...', overlay_sending_photo:'Sending pic...',
        overlay_analyzing:'Checking...', overlay_analyzing_link:'Checking link...',
        prompt_link:'Drop product link:', err_link_invalid:'Provide valid link starting with https://',
        err_required:'Must fill', err_max100:'Too long, max 100',
        err_chars:"Letters, numbers, spaces, and symbols: - _ . , ! ? ( ) ' \" & / | ‚Ä¶",
        err_url:'Invalid link', err_price:'Number from 0 to 9999999', err_price_decimals:'Up to 2 digits after dot',
        err_size:'Latin letters and numbers only', err_max500:'Too long, max 500',
        err_image_required_photo:'Image required for photo card', err_image_required:'Upload pic',
        err_image_upload:'Failed to upload image',
        err_save:"Couldn't save.",
        err_save_network:'Failed to save. Check your connection and try again.',
        btn_refresh:'Try again', err_load:"Couldn't load.",
        btn_reserve:'I got this', btn_unreserve:'Unclaim', badge_reserved:'Claimed:',
        tg_share_msg:'Check out my wishlist "{name}"!', tg_invite_msg:'Join wishlist "{name}" as co-author!',
      }
    };

    let appLang = 'ru';
    function detectLang() {
      const lc = tg?.initDataUnsafe?.user?.language_code || navigator.language || 'ru';
      appLang = lc.toLowerCase().startsWith('ru') ? 'ru' : 'en';
    }
    function t(key) { return STRINGS[appLang]?.[key] ?? STRINGS.ru[key] ?? key; }
    function applyStaticI18n() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.textContent = t(el.dataset.i18n);
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        el.placeholder = t(el.dataset.i18nPlaceholder);
      });
      document.querySelectorAll('[data-i18n-title]').forEach(el => {
        el.title = t(el.dataset.i18nTitle);
      });
    }
    // ‚îÄ‚îÄ‚îÄ end i18n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const _savedStartParam = (() => {
      const h = window.location.hash.slice(1);
      if (h) { try { const p = new URLSearchParams(h); const sp = p.get('tgWebAppStartParam'); if (sp) return sp; } catch (_) {} }
      return tg?.initDataUnsafe?.start_param || '';
    })();
    const WISHES_KEY = 'wishlist_wishes';
    const CATS_KEY = 'wishlist_categories';
    const WISHLISTS_KEY = 'wishlist_folders';
    const DEFAULT_CATS = [];
    const PLACEHOLDER_IMAGE = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300"><rect fill="#c8c8c8" width="400" height="300"/><text x="200" y="155" fill="white" font-family="sans-serif" font-size="28" font-weight="bold" text-anchor="middle">PLACEHOLDER</text><line x1="0" y1="0" x2="400" y2="300" stroke="white" stroke-width="8"/><line x1="400" y1="0" x2="0" y2="300" stroke="white" stroke-width="8"/></svg>');
    const PRIVACY_VALUES = ['private', 'public', 'shared'];
    const NAME_RE = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-_.,!?()'"&/\x7C\u00A6\u2016\u2223\u2758\u2026]*$/;
    const SIZE_RE = /^[a-zA-Z0-9\s\-.]*$/;
    const URL_RE = /^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w\-./?%&=]*)?$/i;

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function hasUnsavedData() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –º–æ–¥–∞–ª–∫–∞ —Ñ–æ—Ä–º—ã –∂–µ–ª–∞–Ω–∏—è
      const wishModal = document.getElementById('wishModal');
      if (wishModal && wishModal.classList.contains('open')) {
        const form = document.getElementById('wishForm');
        const name = document.getElementById('wishName')?.value?.trim();
        const comment = document.getElementById('wishComment')?.value?.trim();
        const link = document.getElementById('wishLink')?.value?.trim();
        const price = document.getElementById('wishPrice')?.value?.trim();
        const size = document.getElementById('wishSize')?.value?.trim();
        const wishlistId = document.getElementById('wishWishlist')?.value;
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if (name || comment || link || price || size || wishlistId || pendingImageBase64) {
          return true;
        }
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥–∞–ª–∫–∏ —Å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      // (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º)
      
      return false;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
    function updateClosingConfirmation() {
      if (tg && typeof tg.enableClosingConfirmation === 'function' && typeof tg.disableClosingConfirmation === 'function') {
        if (hasUnsavedData()) {
          tg.enableClosingConfirmation();
        } else {
          tg.disableClosingConfirmation();
        }
      }
    }

    try {
      if (tg) {
        tg.ready();
        tg.expand();
        // –ù–µ –≤–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å—Ä–∞–∑—É - –±—É–¥–µ–º –≤–∫–ª—é—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        updateClosingConfirmation();
        try { tg.setHeaderColor('#0D0D1A'); } catch (_) {}
        try { tg.setBackgroundColor('#0D0D1A'); } catch (_) {}
      }
    } catch (_) {}

    const CLIENT_ID_KEY = 'wishlist_client_id';
    function packPayload(obj) {
      const s = JSON.stringify(obj);
      if (typeof LZString !== 'undefined') return LZString.compressToEncodedURIComponent(s);
      return btoa(unescape(encodeURIComponent(s)));
    }
    function unpackPayload(str) {
      if (!str) return null;
      try {
        if (typeof LZString !== 'undefined') {
          const d = LZString.decompressFromEncodedURIComponent(str);
          if (d) return JSON.parse(d);
        }
        return JSON.parse(decodeURIComponent(escape(atob(str))));
      } catch (_) { return null; }
    }
    function unpackStartParam(b64) {
      if (!b64) return null;
      try {
        return JSON.parse(atob(b64));
      } catch (_) { return null; }
    }
    let _memStorage = {};
    let _anonClientId = null;
    function safeGetItem(key) {
      if (useSupabase && key !== CLIENT_ID_KEY) return null;
      try { return localStorage.getItem(key); } catch (_) { return _memStorage[key] ?? null; }
    }
    function safeSetItem(key, val) {
      if (useSupabase && key !== CLIENT_ID_KEY) return;
      try { localStorage.setItem(key, val); } catch (_) { _memStorage[key] = val; }
    }
    function getCurrentUserId() {
      const u = tg?.initDataUnsafe?.user;
      if (u?.id) return 'tg_' + u.id;
      if (useSupabase) {
        if (!_anonClientId) _anonClientId = 'anon_' + Date.now() + '_' + Math.random().toString(36).slice(2);
        return _anonClientId;
      }
      let cid = safeGetItem(CLIENT_ID_KEY);
      if (!cid) { cid = 'anon_' + Date.now() + '_' + Math.random().toString(36).slice(2); safeSetItem(CLIENT_ID_KEY, cid); }
      return cid;
    }
    let currentUserId;
    try { currentUserId = getCurrentUserId(); } catch (_) { currentUserId = 'anon_' + Date.now(); }

    let wishes = [];
    let categories = [];
    let wishlists = [];
    let pendingImageBase64 = null;
    let pendingWlImageBase64 = null;
    let _imageFromPhotoForSave = null;
    let publicViewData = null;
    let pendingInviteData = null;
    let shareWelcomeShown = false;
    let editingWlId = null;
    let currentView = 'main';
    let selectedWlId = null;
    let isLoading = true;

    function migrateWish(w) {
      const ids = Array.isArray(w.wishlistIds) ? w.wishlistIds : (w.wishlistId ? [w.wishlistId] : []);
      const { wishlistId, ...rest } = w;
      return { ...rest, wishlistIds: ids };
    }

    async function ensureUser() {
      const u = tg?.initDataUnsafe?.user;
      if (!u?.id || !useSupabase) return { error: null };
      const { error } = await sb.from('users').upsert({ id: 'tg_' + u.id, first_name: u.first_name, username: u.username }, { onConflict: 'id' });
      return { error };
    }

    function decodeImageUrl(encoded) {
      try {
        return decodeURIComponent(encoded);
      } catch {
        return null;
      }
    }

    function safeShowAlert(message) {
      try {
        tg?.showAlert?.(message);
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ popup —É–∂–µ –æ—Ç–∫—Ä—ã—Ç, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        console.log(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å alert (popup —É–∂–µ –æ—Ç–∫—Ä—ã—Ç): ${message}`);
      }
    }

    async function loadWishesFromSupabase(wlIdSet) {
      const wlIds = wlIdSet || new Set(wishlists.map((w) => w.id));
      const { data: items } = wlIds.size > 0 ? await sb.from('wishlist_items').select('wishlist_id, wish_id').in('wishlist_id', [...wlIds]) : { data: [] };
      const wishIds = new Set((items || []).map((i) => i.wish_id));
      const { data: ownRows } = await sb.from('wishes').select('*').eq('user_id', currentUserId);
      (ownRows || []).forEach((r) => wishIds.add(r.id));
      if (wishIds.size === 0) return [];
      const { data: rows } = await sb.from('wishes').select('*').in('id', [...wishIds]);
      const byWish = {};
      (items || []).forEach((i) => {
        if (!wlIds.has(i.wishlist_id)) return;
        if (!byWish[i.wish_id]) byWish[i.wish_id] = [];
        byWish[i.wish_id].push(i.wishlist_id);
      });
      return (rows || []).map((r) => ({
        id: r.id, name: r.name, image: r.image, price: r.price, currency: r.currency,
        size: r.size, link: r.link, comment: r.comment, category: r.category,
        wishlistIds: byWish[r.id] || [],
      }));
    }

    async function loadWishlistsFromSupabase() {
      const [ownedRes, collabRes, followedRes] = await Promise.all([
        sb.from('wishlists').select('*').eq('owner_id', currentUserId),
        sb.from('wishlist_collaborators').select('wishlist_id').eq('user_id', currentUserId),
        sb.from('followed_public_wishlists').select('wishlist_id').eq('user_id', currentUserId)
      ]);
      if (ownedRes.error) return { data: [], error: ownedRes.error };
      const owned = ownedRes.data || [];
      const collab = collabRes.data || [];
      const followedRows = followedRes.data || [];
      const collabIds = collab.map((c) => c.wishlist_id);
      const byId = {};
      owned.forEach((w) => { byId[w.id] = { ...w, ownerId: w.owner_id, coAuthorIds: [w.owner_id] }; });
      const [sharedRes, allCollabRes] = await Promise.all([
        collabIds.length ? sb.from('wishlists').select('*').in('id', collabIds) : { data: [] },
        Object.keys(byId).length ? sb.from('wishlist_collaborators').select('wishlist_id, user_id').in('wishlist_id', Object.keys(byId)) : { data: [] }
      ]);
      const shared = sharedRes.data || [];
      const allCollab = allCollabRes.data || [];
      shared.forEach((w) => {
        if (!byId[w.id]) byId[w.id] = { ...w, ownerId: w.owner_id, coAuthorIds: [w.owner_id] };
        if (!byId[w.id].coAuthorIds.includes(currentUserId)) byId[w.id].coAuthorIds.push(currentUserId);
      });
      allCollab.forEach((c) => {
        if (byId[c.wishlist_id] && !byId[c.wishlist_id].coAuthorIds.includes(c.user_id)) byId[c.wishlist_id].coAuthorIds.push(c.user_id);
      });
      const followedIds = followedRows.map((r) => r.wishlist_id).filter((id) => !byId[id]);
      if (followedIds.length > 0) {
        const { data: followedWls } = await sb.from('wishlists').select('*').in('id', followedIds).eq('privacy', 'public');
        (followedWls || []).forEach((w) => { byId[w.id] = { ...w, ownerId: w.owner_id, isFollowedPublic: true }; });
      }
      return { data: Object.values(byId).map(migrateWishlist), error: null };
    }

    async function loadCategoriesFromSupabase() {
      const { data } = await sb.from('categories').select('name').eq('user_id', currentUserId);
      return (data || []).map((r) => r.name);
    }

    async function fetchPublicWishlistFromSupabase(wlId) {
      const { data: wlRow, error: e1 } = await sb.from('wishlists').select('*').eq('id', wlId).eq('privacy', 'public').single();
      if (e1 || !wlRow) return null;
      const wl = { ...wlRow, ownerId: wlRow.owner_id };
      const { data: ownerRow } = await sb.from('users').select('first_name, username').eq('id', wl.owner_id).single();
      const ownerName = ownerRow?.username ? '@' + ownerRow.username : (ownerRow?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      const { data: items } = await sb.from('wishlist_items').select('wish_id').eq('wishlist_id', wlId);
      const wishIds = (items || []).map((i) => i.wish_id);
      const { data: wishRows } = wishIds.length ? await sb.from('wishes').select('*').in('id', wishIds) : { data: [] };
      const wishes = (wishRows || []).map((r) => ({ ...r, wishlistIds: [wlId] }));
      const { data: resRows } = await sb.from('reservations').select('wish_id, user_id, user_name').in('wish_id', wishIds);
      const reservedCards = {};
      (resRows || []).forEach((r) => { reservedCards[r.wish_id] = { userId: r.user_id, userName: r.user_name || '–ö—Ç–æ-—Ç–æ' }; });
      return { type: 'public', wishlist: wl, wishes, reservedCards, ownerName };
    }

    async function addFollowedPublicWishlist(wlId) {
      if (!useSupabase || !sb || !currentUserId) return;
      try {
        const { data: wl } = await sb.from('wishlists').select('owner_id, privacy').eq('id', wlId).single();
        if (!wl || wl.privacy !== 'public' || wl.owner_id === currentUserId) return;
        await sb.from('followed_public_wishlists').upsert({ user_id: currentUserId, wishlist_id: wlId }, { onConflict: 'user_id,wishlist_id' });
      } catch (_) {}
    }

    async function removeFollowedPublicWishlist(wlId) {
      if (!useSupabase || !sb) return;
      await sb.from('followed_public_wishlists').delete().eq('user_id', currentUserId).eq('wishlist_id', wlId);
      const { data: items } = await sb.from('wishlist_items').select('wish_id').eq('wishlist_id', wlId);
      const wishIds = (items || []).map((i) => i.wish_id);
      if (wishIds.length) await sb.from('reservations').delete().eq('user_id', currentUserId).in('wish_id', wishIds);
    }

    async function fetchInviteWishlistFromSupabase(wlId) {
      const { data: wlRow, error: e1 } = await sb.from('wishlists').select('*').eq('id', wlId).eq('privacy', 'shared').single();
      if (e1 || !wlRow) return null;
      const { data: ownerRow } = await sb.from('users').select('first_name, username').eq('id', wlRow.owner_id).single();
      const ownerName = ownerRow?.username ? '@' + ownerRow.username : (ownerRow?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      return { wishlist: { ...wlRow, name: wlRow.name }, ownerName };
    }

    function loadWishesSync() {
      const hash = window.location.hash.slice(1);
      if (hash) {
        const data = unpackPayload(hash);
        if (data?.type === 'public') { publicViewData = data; return []; }
        if (data) {
          const arr = Array.isArray(data.wishes) ? data.wishes : (Array.isArray(data) ? data : []);
          return arr.map(migrateWish);
        }
      }
      publicViewData = null;
      try {
        return JSON.parse(safeGetItem(WISHES_KEY) || '[]').map(migrateWish);
      } catch (_) { return []; }
    }

    async function handleInviteJoin(data) {
      const wl = data.wishlist;
      const wlWishes = data.wishes || [];
      if (!wl?.id) return;
      if (useSupabase) {
        await ensureUser();
        await sb.from('wishlist_collaborators').upsert({ wishlist_id: wl.id, user_id: currentUserId }, { onConflict: 'wishlist_id,user_id' });
      } else {
        const wls = JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]');
        const wis = JSON.parse(safeGetItem(WISHES_KEY) || '[]').map(migrateWish);
        const existing = wls.find((x) => x.id === wl.id);
        const coAuthorIds = Array.isArray(wl.coAuthorIds) ? [...wl.coAuthorIds] : (wl.ownerId ? [wl.ownerId] : []);
        if (!coAuthorIds.includes(currentUserId)) coAuthorIds.push(currentUserId);
        const mergedWl = { ...wl, coAuthorIds };
        let newWls = existing ? wls.map((x) => x.id === wl.id ? { ...x, ...mergedWl, coAuthorIds: [...new Set([...(x.coAuthorIds || []), currentUserId])] } : x) : [...wls, mergedWl];
        const newWis = [...wis];
        wlWishes.forEach((w) => {
          const mw = migrateWish({ ...w, wishlistIds: [...(Array.isArray(w.wishlistIds) ? w.wishlistIds : []), wl.id].filter((x, i, a) => a.indexOf(x) === i) });
          const ei = newWis.findIndex((x) => x.id === mw.id);
          if (ei >= 0) { if (!newWis[ei].wishlistIds?.includes(wl.id)) newWis[ei].wishlistIds = [...(newWis[ei].wishlistIds || []), wl.id]; }
          else newWis.push(mw);
        });
        safeSetItem(WISHLISTS_KEY, JSON.stringify(newWls));
        safeSetItem(WISHES_KEY, JSON.stringify(newWis));
      }
      window.location.hash = '';
      window.location.reload();
    }

    function getStartParam() {
      if (_savedStartParam) return _savedStartParam;
      const urlParams = new URLSearchParams(window.location.search);
      const urlStartParam = urlParams.get('start_param');
      if (urlStartParam) return urlStartParam;
      const h = window.location.hash.slice(1);
      if (h) {
        try {
          const hashParams = new URLSearchParams(h);
          const sp = hashParams.get('tgWebAppStartParam') || hashParams.get('start_param');
          if (sp) return sp;
        } catch (e) {}
        if (h.startsWith('start_param=')) return decodeURIComponent(h.split('=').slice(1).join('='));
      }
      if (tg?.initData) {
        try {
          const initDataStartParam = new URLSearchParams(tg.initData).get('start_param');
          if (initDataStartParam) return initDataStartParam;
        } catch (e) {}
      }
      return tg?.initDataUnsafe?.start_param || '';
    }

    async function loadAll() {
      if (useSupabase) await loadSupabase();
      let hash = window.location.hash.slice(1);
      const goHome = sessionStorage.getItem('publicViewGoHome');
      if (goHome) { sessionStorage.removeItem('publicViewGoHome'); hash = ''; }
      const startParam = goHome ? '' : getStartParam();
      if (startParam && startParam.startsWith('img_')) {
        const payload = unpackStartParam(startParam.slice(4));
        if (!payload || !payload.n) {
          isLoading = false; currentView = 'main'; render(); return;
        }
        isLoading = false; currentView = 'main'; render();
        const extracted = { name: payload.n || 'N/A', price: payload.p ?? null, currency: payload.c ?? null, size: payload.s ?? null };
        const overlay = document.getElementById('analysisOverlay');
        const overlayText = document.getElementById('analysisOverlayText');
        if (overlay) overlay.classList.add('visible');
        if (overlayText) overlayText.textContent = t('overlay_loading_card');
        const loadDataThenOpen = async () => {
          try {
            await Promise.race([
              (async () => {
                await ensureUser();
                if (useSupabase && sb) {
                  const wlRes = await loadWishlistsFromSupabase();
                  if (wlRes.data) wishlists = wlRes.data;
                  wishes = await loadWishesFromSupabase(new Set(wishlists.map((w) => w.id)));
                  wishes = Array.isArray(wishes) ? wishes : [];
                  const cats = await loadCategoriesFromSupabase();
                  categories = Array.isArray(cats) && cats.length ? cats : [];
                } else {
                  wishes = loadWishesSync(); wishes = Array.isArray(wishes) ? wishes : [];
                  try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
                  wishlists = Array.isArray(wishlists) ? wishlists : [];
                  try { const raw = safeGetItem(CATS_KEY); categories = raw ? JSON.parse(raw) : []; } catch (_) { categories = []; }
                  categories = Array.isArray(categories) ? categories : [];
                }
              })(),
              new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 8000))
            ]);
          } catch (_) {}
          isLoading = false; render();
          try {
            const imageSrc = (payload.i && typeof payload.i === 'string')
              ? (payload.i.startsWith('http') ? payload.i : 'data:image/jpeg;base64,' + payload.i)
              : null;
            openWishModalFromImage(imageSrc, extracted);
          } finally {
            document.getElementById('analysisOverlay')?.classList.remove('visible');
          }
        };
        requestAnimationFrame(() => loadDataThenOpen());
        return;
      }
      if (startParam && startParam.startsWith('text_')) {
        const payload = unpackStartParam(startParam.slice(5));
        if (!payload || !payload.n) { isLoading = false; currentView = 'main'; render(); return; }
        isLoading = false; currentView = 'main'; render();
        const extracted = { name: payload.n || '–ñ–µ–ª–∞–Ω–∏–µ', price: payload.p ?? null, currency: payload.c ?? null, size: payload.s ?? null };
        const overlay = document.getElementById('analysisOverlay');
        const overlayText = document.getElementById('analysisOverlayText');
        if (overlay) overlay.classList.add('visible');
        if (overlayText) overlayText.textContent = t('overlay_loading_card');
        const loadDataThenOpen = async () => {
          try {
            await Promise.race([
              (async () => {
                await ensureUser();
                if (useSupabase && sb) {
                  const wlRes = await loadWishlistsFromSupabase();
                  if (wlRes.data) wishlists = wlRes.data;
                  wishes = await loadWishesFromSupabase(new Set(wishlists.map((w) => w.id)));
                  wishes = Array.isArray(wishes) ? wishes : [];
                  const cats = await loadCategoriesFromSupabase();
                  categories = Array.isArray(cats) && cats.length ? cats : [];
                } else {
                  wishes = loadWishesSync(); wishes = Array.isArray(wishes) ? wishes : [];
                  try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
                  try { const raw = safeGetItem(CATS_KEY); categories = raw ? JSON.parse(raw) : []; } catch (_) { categories = []; }
                }
              })(),
              new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 8000))
            ]);
          } catch (_) {}
          isLoading = false; render();
          try {
            openWishModalFromText(extracted);
          } finally {
            document.getElementById('analysisOverlay')?.classList.remove('visible');
          }
        };
        requestAnimationFrame(() => loadDataThenOpen());
        return;
      }
      if (startParam && startParam.startsWith('link_')) {
        const payload = unpackStartParam(startParam.slice(5));
        if (!payload || !payload.l) { isLoading = false; currentView = 'main'; render(); return; }
        const targetUrl = payload.l;
        isLoading = false; currentView = 'main'; render();
        const extracted = {
          name: payload.n || 'N/A',
          price: payload.p ?? null,
          currency: payload.c ?? null,
          size: payload.s ?? null,
          link: targetUrl,
          image: payload.i || null,
          imageBase64: null
        };
        const overlay = document.getElementById('analysisOverlay');
        const overlayText = document.getElementById('analysisOverlayText');
        if (overlay) overlay.classList.add('visible');
        if (overlayText) overlayText.textContent = t('overlay_loading_card');
        const loadDataThenOpen = async () => {
          try {
            await Promise.race([
              (async () => {
                await ensureUser();
                if (useSupabase && sb) {
                  const wlRes = await loadWishlistsFromSupabase();
                  if (wlRes.data) wishlists = wlRes.data;
                  wishes = await loadWishesFromSupabase(new Set(wishlists.map((w) => w.id)));
                  wishes = Array.isArray(wishes) ? wishes : [];
                  const cats = await loadCategoriesFromSupabase();
                  categories = Array.isArray(cats) && cats.length ? cats : [];
                } else {
                  wishes = loadWishesSync(); wishes = Array.isArray(wishes) ? wishes : [];
                  try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
                  try { const raw = safeGetItem(CATS_KEY); categories = raw ? JSON.parse(raw) : []; } catch (_) { categories = []; }
                }
              })(),
              new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 8000))
            ]);
          } catch (_) {}
          isLoading = false; render();
          try {
            openWishModalFromLink(extracted, targetUrl);
          } finally {
            document.getElementById('analysisOverlay')?.classList.remove('visible');
          }
        };
        requestAnimationFrame(() => loadDataThenOpen());
        return;
      }
      if (startParam && (startParam.startsWith('w_') || startParam.startsWith('i_'))) {
        hash = startParam.replace('_', '/');
      }
      if (hash) {
        const shortW = /^w\/(.+)$/.exec(hash);
        const shortI = /^i\/(.+)$/.exec(hash);
        if (shortW && useSupabase && sb) {
          publicViewData = await fetchPublicWishlistFromSupabase(shortW[1]);
          if (publicViewData) {
            await ensureUser();
            await addFollowedPublicWishlist(shortW[1]);
            wishes = []; categories = []; wishlists = [];
            history.replaceState(null, '', window.location.pathname + '#w/' + shortW[1]);
            isLoading = false;
            return;
          }
        }
        if (shortI && useSupabase && sb) {
          const wlId = shortI[1];
          try {
            if (sessionStorage.getItem('accepted_invite_' + wlId)) {
              sessionStorage.removeItem('accepted_invite_' + wlId);
              hash = '';
            } else if (sessionStorage.getItem('declined_invite_' + wlId)) {
              sessionStorage.removeItem('declined_invite_' + wlId);
              hash = '';
            } else {
              const info = await fetchInviteWishlistFromSupabase(wlId);
              if (info) {
                pendingInviteData = { wlId, ownerName: info.ownerName, wlName: info.wishlist?.name || '–í–∏—à–ª–∏—Å—Ç' };
                isLoading = false;
                return;
              }
            }
          } catch (_) {}
        }
        await ensureLzString();
        const data = unpackPayload(hash);
        if (data?.type === 'public' && data?.wishlist?.id) {
          publicViewData = data;
          if (useSupabase && sb) { await ensureUser(); await addFollowedPublicWishlist(data.wishlist.id); }
          wishes = []; categories = []; wishlists = [];
          isLoading = false;
          return;
        }
        if (data?.type === 'invite' && data?.wishlist?.id) {
          pendingInviteData = {
            wlId: data.wishlist.id,
            ownerName: data.ownerName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            wlName: data.wishlist.name || '–í–∏—à–ª–∏—Å—Ç',
            fullPayload: data
          };
          isLoading = false;
          return;
        }
      }
      publicViewData = null;
      if (useSupabase && sb) {
        const userRes = await ensureUser();
        if (userRes.error) {
          window._supabaseLoadError = userRes.error.message || JSON.stringify(userRes.error);
          isLoading = false;
          return;
        }
        const wlRes = await loadWishlistsFromSupabase();
        if (wlRes.error) {
          window._supabaseLoadError = wlRes.error.message || JSON.stringify(wlRes.error);
          isLoading = false;
          return;
        }
        wishlists = Array.isArray(wlRes.data) ? wlRes.data : [];
        const wlIdSet = new Set(wishlists.map((w) => w.id));
        const [wishesRes, catsRes] = await Promise.all([
          loadWishesFromSupabase(wlIdSet),
          loadCategoriesFromSupabase()
        ]);
        wishes = Array.isArray(wishesRes) ? wishesRes : [];
        const cats = Array.isArray(catsRes) ? catsRes : [];
        categories = cats.length ? cats : [];
      } else {
        wishes = loadWishesSync();
        wishes = Array.isArray(wishes) ? wishes : [];
        try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
        wishlists = Array.isArray(wishlists) ? wishlists : [];
        try { const raw = safeGetItem(CATS_KEY); categories = raw ? JSON.parse(raw) : []; } catch (_) { categories = []; }
        categories = Array.isArray(categories) ? categories : [];
      }
    }

    async function saveWishes() {
      if (useSupabase) {
        for (const w of wishes) {
          const row = { id: w.id, name: w.name, image: w.image, price: w.price, currency: w.currency, size: w.size, link: w.link, comment: w.comment, category: w.category, user_id: currentUserId };
          await sb.from('wishes').upsert(row, { onConflict: 'id' });
          await sb.from('wishlist_items').delete().eq('wish_id', w.id);
          for (const wlId of (w.wishlistIds || [])) await sb.from('wishlist_items').insert({ wishlist_id: wlId, wish_id: w.id });
        }
        const { data: dbRows } = await sb.from('wishes').select('id').eq('user_id', currentUserId);
        const localIds = new Set(wishes.map((w) => w.id));
        for (const r of (dbRows || [])) { if (!localIds.has(r.id)) await sb.from('wishes').delete().eq('id', r.id); }
      } else {
        try { safeSetItem(WISHES_KEY, JSON.stringify(wishes)); } catch (e) { tg?.showAlert?.(t('err_save')); }
      }
    }

    async function saveCategories() {
      if (useSupabase) {
        await sb.from('categories').delete().eq('user_id', currentUserId);
        for (const name of categories) await sb.from('categories').insert({ user_id: currentUserId, name });
      } else {
        safeSetItem(CATS_KEY, JSON.stringify(categories));
      }
    }

    function migrateWishlist(wl) {
      if (!wl.ownerId) wl.ownerId = wl.owner_id || currentUserId;
      if (!Array.isArray(wl.coAuthorIds) && wl.ownerId) wl.coAuthorIds = [wl.ownerId];
      if (!wl.privacy) wl.privacy = wl.privacy || 'private';
      if (wl.updatedAt == null) wl.updatedAt = wl.updated_at ? new Date(wl.updated_at).getTime() : 0;
      return wl;
    }

    function updateHeaderForView() {
      // Logo always visible; header is static
    }

    function navigateTo(view, wlId = null) {
      currentView = view;
      selectedWlId = wlId;
      document.querySelectorAll('.tab-item').forEach((t) => t.classList.remove('active'));
      const tabMap = { main: 'tabHome', manageWishlists: 'tabWishlists', manageCategories: 'tabTags', manageWishes: 'tabWishes', createWishlist: 'tabWishlists', wishlist: 'tabWishlists', editWishlist: 'tabWishlists' };
      const tabId = tabMap[view];
      if (tabId) document.getElementById(tabId)?.classList.add('active');
      const actionBtns = document.getElementById('actionButtons');
      if (actionBtns) actionBtns.style.display = (view === 'main') ? 'flex' : 'none';
      updateHeaderForView();
      render();
    }
    window.__nav = navigateTo;
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-nav]');
      if (btn) { e.preventDefault(); try { navigateTo(btn.dataset.nav); } catch (err) { console.error('nav err:', err); } return; }
      const back = e.target.closest('[data-nav-back]');
      if (back) { e.preventDefault(); navigateTo(back.dataset.navBack || 'main'); return; }
      const recent = e.target.closest('.recent-item[data-wl-id]');
      if (recent) { e.preventDefault(); navigateTo('wishlist', recent.dataset.wlId); }
    });

    function fwlLink(wl) {
      if (!wl) return '';
      return `<span class="feed-link" data-action="wl" data-id="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</span>`;
    }
    function fwishLink(w) {
      if (!w) return '';
      return `<span class="feed-link" data-action="wish" data-id="${escapeHtml(w.id)}">${escapeHtml(w.name)}</span>`;
    }
    function fmtTime(ts) {
      const d = (ts > 946684800000) ? new Date(ts) : new Date();
      return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    async function getFeedEvents() {
      const now = Date.now();
      const events = [];
      const myWishes = getMyWishes();
      const myWishIds = new Set(myWishes.map((w) => w.id));

      // Recently added wishes ‚Äî sort by real created_at from Supabase
      const sortedWishes = [...myWishes].sort((a, b) => {
        const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
        const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
        return tb - ta;
      });
      for (const w of sortedWishes) {
        const wlId = (w.wishlistIds || [])[0];
        const wl = wishlists.find((x) => x.id === wlId);
        const ts = w.created_at ? new Date(w.created_at).getTime() : 0;
        events.push({
          ts,
          time: fmtTime(ts),
          html: wl
            ? t('feed_added_to_wl').replace('{wish}', fwishLink(w)).replace('{wl}', fwlLink(wl))
            : t('feed_added_to_list').replace('{wish}', fwishLink(w)).replace('{wl}', ''),
        });
      }

      // Reservation events from Supabase
      if (useSupabase && sb) {
        try {
          // Others reserved MY wishes ‚Äî include created_at
          if (myWishIds.size > 0) {
            const { data: resRows } = await sb.from('reservations')
              .select('wish_id, user_id, user_name, created_at')
              .in('wish_id', [...myWishIds])
              .neq('user_id', currentUserId);
            for (const r of (resRows || [])) {
              const w = wishes.find((x) => x.id === r.wish_id);
              if (!w) continue;
              const wlId = (w.wishlistIds || []).find((id) => wishlists.some((wl) => wl.id === id));
              const wl = wishlists.find((x) => x.id === wlId);
              const userName = r.user_name || 'Someone';
              const isPublic = wl?.privacy === 'public';
              const itemLabel = isPublic ? `<i>${appLang === 'ru' ? '–∫–æ–µ-—á—Ç–æ' : 'smth'}</i>` : fwishLink(w);
              const ts = r.created_at ? new Date(r.created_at).getTime() : now;
              const evKey = isPublic ? 'feed_reserved_private' : 'feed_reserved_public';
              events.push({
                ts,
                time: fmtTime(ts),
                html: wl
                  ? t(evKey).replace('{user}', `<b>${escapeHtml(userName)}</b>`).replace('{wish}', itemLabel).replace('{wl}', fwlLink(wl))
                  : `<b>${escapeHtml(userName)}</b> ${itemLabel}`,
              });
            }
          }

          // MY reservations on others' lists ‚Äî include created_at
          const { data: myResRows } = await sb.from('reservations')
            .select('wish_id, created_at')
            .eq('user_id', currentUserId);
          for (const r of (myResRows || [])) {
            if (myWishIds.has(r.wish_id)) continue;
            const w = wishes.find((x) => x.id === r.wish_id);
            if (!w) continue;
            const wlId = (w.wishlistIds || []).find((id) => wishlists.some((wl) => wl.id === id));
            const wl = wishlists.find((x) => x.id === wlId);
            const ts = r.created_at ? new Date(r.created_at).getTime() : now;
            events.push({
              ts,
              time: fmtTime(ts),
              html: wl
                ? t('feed_i_reserved').replace('{wish}', fwishLink(w)).replace('{wl}', fwlLink(wl))
                : t('feed_i_reserved').replace('{wish}', fwishLink(w)).replace(' from {wl}', '').replace('–∏–∑ {wl}', ''),
            });
          }
        } catch (_) {}
      }

      events.sort((a, b) => b.ts - a.ts);
      if (events.length === 0) {
        events.push({ ts: 0, time: fmtTime(now), html: t('feed_empty') });
      }
      return events.slice(0, 6);
    }

    async function renderMain() {
      const content = document.getElementById('content');

      content.innerHTML = `
        <div class="hero-section">
          <div class="hero-feed-title">
            <span class="hero-feed-dot"></span>
            ${t('feed_title')}
          </div>
        </div>
        <div class="feed-container" id="feedContainer">
          <div class="skeleton skeleton-recent"></div>
          <div class="skeleton skeleton-recent"></div>
          <div class="skeleton skeleton-recent"></div>
        </div>
      `;

      const feedEvents = await getFeedEvents();

      const feedContainer = document.getElementById('feedContainer');
      if (!feedContainer) return;

      feedContainer.innerHTML = feedEvents.map((ev, i) => `
        ${i > 0 ? '<div class="feed-divider"></div>' : ''}
        <div class="feed-item" style="animation-delay:${i * 0.06}s">
          <span class="feed-item-ts">${ev.time || ''}</span>
          <div class="feed-item-track">
            <span class="feed-item-inner">${ev.html}</span>
          </div>
        </div>
      `).join('');

      // Activate marquee for overflowing items
      feedContainer.querySelectorAll('.feed-item-track').forEach((track) => {
        const inner = track.querySelector('.feed-item-inner');
        if (!inner) return;
        requestAnimationFrame(() => {
          const overflow = inner.scrollWidth - track.clientWidth;
          if (overflow > 10) {
            inner.style.setProperty('--scroll-px', `-${overflow + 24}px`);
            inner.classList.add('is-scrolling');
          }
        });
      });

      feedContainer.querySelectorAll('.feed-link').forEach((el) => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          if (el.dataset.action === 'wl') navigateTo('wishlist', el.dataset.id);
          else if (el.dataset.action === 'wish') openWishModal(el.dataset.id);
        });
      });
    }

    function bindActionButtons() {
      if (window._actionButtonsBound) return;
      window._actionButtonsBound = true;
      const addByPhotoBtn = document.getElementById('addByPhotoBtn');
      const addByPhotoInput = document.getElementById('addByPhotoInput');
      const addByLinkBtn = document.getElementById('addByLinkBtn');
      if (addByPhotoBtn && addByPhotoInput) {
        addByPhotoBtn.addEventListener('click', () => addByPhotoInput.click());
        addByPhotoInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          e.target.value = '';
          if (!file?.type?.startsWith('image/')) return;
          try {
            const overlay = document.getElementById('analysisOverlay');
            const overlayText = document.getElementById('analysisOverlayText');
            if (overlay) overlay.classList.add('visible');
            if (overlayText) overlayText.textContent = t('overlay_preparing_photo');
            let imageBase64 = await fileToBase64(file);
            if (overlayText) overlayText.textContent = t('overlay_sending_photo');
            imageBase64 = await resizeImageBase64(imageBase64, 960, 0.8);
            let extracted = { name: '', price: null, currency: null, size: null };
            if (API_BASE_URL && API_BASE_URL.startsWith('http')) {
              if (overlayText) overlayText.textContent = t('overlay_analyzing');
              try {
                const b64 = imageBase64.includes(',') ? imageBase64.split(',')[1] : imageBase64;
                const r = await fetch(ensureHttps(API_BASE_URL) + '/analyze-image', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ image: b64 }),
                });
                if (r.ok) {
                  const data = await r.json();
                  extracted = { name: data.name || '', price: data.price ?? null, currency: data.currency ?? null, size: data.size ?? null };
                } else {
                  console.warn('analyze-image:', r.status);
                }
              } catch (e) {
                console.warn('analyze-image fetch:', e);
              }
              if (overlay) overlay.classList.remove('visible');
            } else if (!API_BASE_URL) {
              console.warn('API_BASE_URL –Ω–µ –∑–∞–¥–∞–Ω (LINK_SCRAPER_URL –≤ GitHub Secrets?)');
            }
            openWishModalFromImage(imageBase64, extracted);
          } catch (err) {
            document.getElementById('analysisOverlay')?.classList.remove('visible');
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', err);
            safeShowAlert(t('err_image_upload'));
          }
        });
      }
      if (addByLinkBtn) {
        addByLinkBtn.addEventListener('click', async () => {
          const url = (prompt(t('prompt_link')) || '').trim();
          if (!url || !url.startsWith('https://')) {
            if (url) safeShowAlert(t('err_link_invalid'));
            return;
          }
          let extracted = { name: '', price: null, currency: null, size: null, link: url, image: null };
          if (API_BASE_URL && API_BASE_URL.startsWith('http')) {
            const overlay = document.getElementById('analysisOverlay');
            const overlayText = document.getElementById('analysisOverlayText');
            if (overlay) { overlay.classList.add('visible'); overlayText && (overlayText.textContent = t('overlay_analyzing_link')); }
            try {
              const r = await fetch(ensureHttps(API_BASE_URL) + '/?url=' + encodeURIComponent(url), { signal: AbortSignal.timeout(45000) });
              if (r.ok) {
                const data = await r.json();
                extracted = {
                  name: data.name || '',
                  price: data.price ?? null,
                  currency: data.currency ?? null,
                  size: data.size ?? null,
                  link: url,
                  image: data.image || null,
                  imageBase64: data.imageBase64 || null,
                };
              } else {
                console.warn('parse url:', r.status);
              }
            } catch (e) {
              console.warn('parse url fetch:', e);
            }
            if (overlay) overlay.classList.remove('visible');
          } else if (!API_BASE_URL) {
            console.warn('API_BASE_URL –Ω–µ –∑–∞–¥–∞–Ω (LINK_SCRAPER_URL –≤ GitHub Secrets?)');
          }
          openWishModalFromLink(extracted, url);
        });
      }
    }

    function canEditWishlist(wl) {
      if (!wl) return false;
      return wl.ownerId === currentUserId || (Array.isArray(wl.coAuthorIds) && wl.coAuthorIds.includes(currentUserId));
    }

    function isOwner(wl) {
      return wl?.ownerId === currentUserId;
    }

    async function saveWishlists() {
      if (useSupabase) {
        const ourIds = new Set(wishlists.map((w) => w.id));
        const { data: owned } = await sb.from('wishlists').select('id').eq('owner_id', currentUserId);
        for (const r of (owned || [])) {
          if (!ourIds.has(r.id)) await sb.from('wishlists').delete().eq('id', r.id);
        }
        for (const wl of wishlists) {
          const row = { id: wl.id, name: wl.name, image: wl.image, privacy: wl.privacy || 'private', owner_id: wl.ownerId || currentUserId };
          if (wl.updatedAt) row.updated_at = new Date(wl.updatedAt).toISOString();
          await sb.from('wishlists').upsert(row, { onConflict: 'id' });
          await sb.from('wishlist_collaborators').delete().eq('wishlist_id', wl.id);
          for (const uid of (wl.coAuthorIds || [])) {
            if (uid !== (wl.ownerId || wl.owner_id)) await sb.from('wishlist_collaborators').insert({ wishlist_id: wl.id, user_id: uid });
          }
        }
      } else {
        safeSetItem(WISHLISTS_KEY, JSON.stringify(wishlists));
      }
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s ?? '';
      return d.innerHTML;
    }

    /** –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –æ—Ç–≤–µ—Ç API (—Ä—É–±, RUB, Br –∏ —Ç.–¥.) –≤ value —Å–µ–ª–µ–∫—Ç–∞ –≤–∞–ª—é—Ç—ã: ‚ÇΩ, Br, $, ‚Ç¨, ‚Ç∏ */
    function normalizeCurrency(raw) {
      if (!raw || typeof raw !== 'string') return '';
      const s = raw.trim().toLowerCase().replace(/\.$/, '');
      const map = {
        '—Ä—É–±': '‚ÇΩ', '—Ä—É–±–ª–µ–π': '‚ÇΩ', 'rub': '‚ÇΩ', '‚ÇΩ': '‚ÇΩ',
        '–±—É–Ω': 'Br', 'byn': 'Br', 'br': 'Br',
        '–¥–æ–ª–ª': '$', 'usd': '$', '$': '$',
        '–µ–≤—Ä': '‚Ç¨', 'eur': '‚Ç¨', '‚Ç¨': '‚Ç¨',
        '—Ç–≥': '‚Ç∏', 'kzt': '‚Ç∏', '‚Ç∏': '‚Ç∏'
      };
      return map[s] || (map[s.replace(/\s+/g, '')] ?? '');
    }

    function resizeImageBase64(base64, maxW = 800, quality = 0.8) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const w = img.width, h = img.height;
          if (w <= maxW) { resolve(base64); return; }
          const canvas = document.createElement('canvas');
          canvas.width = maxW;
          canvas.height = (h / w) * maxW;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = () => resolve(base64);
        img.src = base64;
      });
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function validateName(v) {
      if (!v || !v.trim()) return t('err_required');
      if (v.length > 100) return t('err_max100');
      if (!NAME_RE.test(v)) return t('err_chars');
      return null;
    }

    function validateLink(v) {
      if (!v?.trim()) return null;
      if (!URL_RE.test(v.trim())) return t('err_url');
      return null;
    }

    function validatePrice(v) {
      if (!v) return null;
      const n = parseFloat(String(v).replace(',', '.'));
      if (isNaN(n) || n < 0 || n > 9999999) return t('err_price');
      if (/\.\d{3,}/.test(String(v))) return t('err_price_decimals');
      return null;
    }

    function validateSize(v) {
      if (!v?.trim()) return null;
      if (!SIZE_RE.test(v.trim())) return t('err_size');
      return null;
    }

    function validateComment(v) {
      if (!v?.trim()) return null;
      if (v.length > 500) return t('err_max500');
      return null;
    }

    function formatPrice(price, currency) {
      if (!price) return '';
      const n = parseFloat(String(price).replace(',', '.'));
      if (isNaN(n)) return price;
      const fmt = new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(n);
      return currency ? `${fmt} ${currency}` : fmt;
    }

    function render() {
      if (!Array.isArray(wishlists)) wishlists = [];
      if (!Array.isArray(wishes)) wishes = [];
      if (!Array.isArray(categories)) categories = [];
      if (pendingInviteData) {
        document.getElementById('inviteConsentText').textContent = t('invite_consent_msg').replace('{owner}', pendingInviteData.ownerName).replace('{name}', pendingInviteData.wlName);
        document.getElementById('inviteConsentModal').classList.add('open');
        return;
      }
      if (publicViewData) {
        renderPublicView();
        if (!shareWelcomeShown) {
          const owner = publicViewData.ownerName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
          const wlName = publicViewData.wishlist?.name || '–í–∏—à–ª–∏—Å—Ç';
          document.getElementById('shareWelcomeText').textContent = t('share_welcome_msg').replace('{owner}', owner).replace('{name}', wlName);
          document.getElementById('shareWelcomeModal').classList.add('open');
          shareWelcomeShown = true;
        }
        return;
      }
      const content = document.getElementById('content');
      if (!content) return;
      updateHeaderForView();
      if (currentView === 'main') {
        renderMain();
        return;
      }
      if (currentView === 'manageWishlists') {
        renderManageWishlists();
        return;
      }
      if (currentView === 'manageCategories') {
        renderManageCategories();
        return;
      }
      if (currentView === 'manageWishes') {
        renderManageWishes();
        return;
      }
      if (currentView === 'wishlist' && selectedWlId) {
        renderWishlistDetail(selectedWlId);
        return;
      }
      if (currentView === 'createWishlist') {
        renderCreateWishlist();
        return;
      }
      if (currentView === 'editWishlist' && selectedWlId) {
        renderEditWishlist(selectedWlId);
        return;
      }
      renderMain();
    }

    function renderCreateWishlist() {
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="page-header">
          <button class="page-back-btn" id="createWlBack">‚Üê ${t('btn_back')}</button>
          <span class="page-header-title">${t('create_wl_title')}</span>
        </div>
        <div class="form-group">
          <label>${t('create_wl_name_label')} <span class="required">*</span></label>
          <input type="text" id="newWlName" placeholder="${t('create_wl_name_placeholder')}">
        </div>
        <div class="form-group">
          <label>${t('create_wl_cover_label')}</label>
          <div class="img-upload wl-add-img" id="wlImgUpload" style="min-height:100px;">
            <input type="file" id="wlImage" accept="image/*">
            <span id="wlImgText" style="font-size:0.85rem;font-weight:700;text-transform:uppercase;">${t('btn_add_cover')}</span>
            <img id="wlImgPreview" class="img-preview" style="display:none;max-height:120px;" alt="">
          </div>
        </div>
        <div class="form-group">
          <label>${t('create_wl_privacy_label')}</label>
          <select id="newWlPrivacy">
            <option value="private">${t('privacy_private_opt')}</option>
            <option value="public">${t('privacy_public_opt')}</option>
            <option value="shared">${t('privacy_shared_opt')}</option>
          </select>
        </div>
        <div class="form-actions-split" style="margin-top:24px;">
          <button type="button" class="btn btn-outline" id="createWlBack2" style="flex:0.35;">${t('btn_back')}</button>
          <button type="button" class="btn btn-secondary" id="createWlSubmit" style="flex:0.65;">${t('btn_create')}</button>
        </div>
      `;
      document.getElementById('createWlBack').addEventListener('click', () => navigateTo('manageWishlists'));
      document.getElementById('createWlBack2').addEventListener('click', () => navigateTo('manageWishlists'));
      document.getElementById('createWlSubmit').addEventListener('click', addWlInManage);
      document.getElementById('wlImgUpload').addEventListener('click', () => document.getElementById('wlImage').click());
      document.getElementById('wlImage').addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f?.type?.startsWith('image/')) return;
        try {
          let b = await fileToBase64(f);
          b = await resizeImageBase64(b, 400);
          pendingWlImageBase64 = b;
          document.getElementById('wlImgPreview').src = b;
          document.getElementById('wlImgPreview').style.display = 'block';
          document.getElementById('wlImgText').textContent = t('cover_selected');
        } catch (_) {}
      });
    }

    function renderEditWishlist(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl) { navigateTo('manageWishlists'); return; }
      const content = document.getElementById('content');
      const isCollab = wl.privacy === 'shared' && canEditWishlist(wl) && !isOwner(wl);
      const selStyle = 'width:100%;padding:10px 12px;border:2px solid #000;box-shadow:2px 2px 0 0 #000;border-radius:8px;font-family:inherit;font-weight:700;font-size:0.95rem;outline:none;background:#fff;color:#000;-webkit-appearance:none;appearance:none;cursor:pointer;';
      content.innerHTML = `
        <div class="page-header">
          <button class="page-back-btn" id="ewlBackBtn">‚Üê ${t('btn_back')}</button>
          <span class="page-header-title">${t('edit_wl_title')}</span>
        </div>
        <div class="form-group">
          <label>${t('edit_wl_name_label')}</label>
          <input type="text" id="ewlName" value="${escapeHtml(wl.name)}" placeholder="${t('edit_wl_name_placeholder')}">
        </div>
        <div class="form-group">
          <label>${t('edit_wl_privacy_label')}</label>
          <div style="position:relative;">
            <select id="ewlPrivacy" style="${selStyle}">
              <option value="private" ${wl.privacy === 'private' ? 'selected' : ''}>${t('pr_private')}</option>
              <option value="public" ${wl.privacy === 'public' ? 'selected' : ''}>${t('pr_public')}</option>
              <option value="shared" ${wl.privacy === 'shared' ? 'selected' : ''}>${t('pr_shared')}</option>
            </select>
            <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);pointer-events:none;font-weight:900;">‚ñæ</span>
          </div>
        </div>
        <div class="form-group">
          <label>${t('edit_wl_cover_label')}</label>
          <div class="img-upload wl-add-img" id="ewlImgUpload" style="min-height:90px;">
            <input type="file" id="ewlImage" accept="image/*">
            <span id="ewlImgText" style="font-size:0.85rem;font-weight:700;text-transform:uppercase;">${t('btn_change_cover')}</span>
            <img id="ewlImgPreview" class="img-preview" style="display:${wl.image ? 'block' : 'none'};max-height:120px;" src="${wl.image || ''}" alt="">
          </div>
        </div>
        <div id="ewlExtras"></div>
        <div class="form-actions-split" style="margin-top:16px;">
          <button type="button" class="btn btn-outline" id="ewlCancel" style="flex:0.35;">${t('btn_cancel')}</button>
          <button type="button" class="btn btn-secondary" id="ewlSave" style="flex:0.65;">${t('btn_save')}</button>
        </div>
        ${isOwner(wl) ? `
        <div style="margin-top:24px;padding-top:16px;border-top:2px solid #000;">
          <button type="button" class="btn" id="ewlDelete" style="width:100%;background:#FF0000;color:#fff;">${t('btn_delete_wl')}</button>
        </div>` : ''}
        ${isCollab ? `
        <div style="margin-top:16px;">
          <button type="button" class="btn btn-outline" id="ewlLeave" style="width:100%;">${t('btn_leave_wl')}</button>
        </div>` : ''}
      `;

      let pendingImg = null;
      document.getElementById('ewlBackBtn').addEventListener('click', () => navigateTo('manageWishlists'));
      document.getElementById('ewlCancel').addEventListener('click', () => navigateTo('manageWishlists'));
      document.getElementById('ewlImgUpload').addEventListener('click', () => document.getElementById('ewlImage').click());
      document.getElementById('ewlImage').addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (f) fileToBase64(f).then((b) => resizeImageBase64(b, 400).then((b2) => {
          pendingImg = b2;
          document.getElementById('ewlImgPreview').src = b2;
          document.getElementById('ewlImgPreview').style.display = 'block';
          document.getElementById('ewlImgText').textContent = t('cover_selected');
        }));
      });
      document.getElementById('ewlSave').addEventListener('click', async () => {
        const name = document.getElementById('ewlName').value.trim();
        if (!name) return;
        wl.name = name;
        wl.privacy = document.getElementById('ewlPrivacy').value;
        if (pendingImg) wl.image = pendingImg;
        wl.updatedAt = Date.now();
        await saveWishlists();
        tg?.HapticFeedback?.notificationOccurred?.('success');
        navigateTo('manageWishlists');
      });
      if (isOwner(wl)) {
        document.getElementById('ewlDelete')?.addEventListener('click', async () => {
          tg?.HapticFeedback?.impactOccurred?.('heavy');
          // Telegram –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç confirm ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π UI
          const btn = document.getElementById('ewlDelete');
          if (btn.dataset.confirming) {
            btn.dataset.confirming = '';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.innerHTML = `<span class="css-loader" style="width:18px;height:18px;border-width:3px;border-color:rgba(255,255,255,0.3);border-top-color:#fff;border-right-color:#fff;display:inline-block;vertical-align:middle;margin-right:8px;"></span>${t('deleting')}`;
            await removeWlInManage(wlId);
            navigateTo('manageWishlists');
          } else {
            btn.dataset.confirming = '1';
            btn.style.background = '#cc0000';
            btn.textContent = t('btn_delete_wl_confirm');
            tg?.HapticFeedback?.notificationOccurred?.('warning');
            setTimeout(() => { if (btn.dataset.confirming) { btn.dataset.confirming = ''; btn.style.background = '#FF0000'; btn.textContent = t('btn_delete_wl'); } }, 3000);
          }
        });
      }
      if (isCollab) {
        document.getElementById('ewlLeave')?.addEventListener('click', async () => {
          await leaveWishlist(wlId);
          navigateTo('manageWishlists');
        });
      }
      // Extras: collaborators panel for shared wishlists
      if (wl.privacy === 'shared' && isOwner(wl)) {
        const extras = document.getElementById('ewlExtras');
        const coAuths = (wl.coAuthorIds || []).filter((id) => id !== (wl.ownerId || wl.owner_id));
        if (coAuths.length > 0 && useSupabase && sb) {
          Promise.all(coAuths.map(async (uid) => {
            const { data } = await sb.from('users').select('first_name, username').eq('id', uid).single();
            return { uid, name: data ? (data.username ? '@' + data.username : data.first_name || uid) : uid };
          })).then((members) => {
            extras.innerHTML = `
              <div class="form-group" style="margin-top:8px;">
                <label>${t('kick_collab_label')}</label>
                <select id="ewlRemoveCollab" style="${selStyle}">
                  <option value="">${t('kick_collab_placeholder')}</option>
                  ${members.map((m) => `<option value="${escapeHtml(m.uid)}">${escapeHtml(m.name)}</option>`).join('')}
                </select>
                <button type="button" class="btn btn-outline" id="ewlRemoveCollabBtn" style="margin-top:8px;width:100%;">${t('btn_kick')}</button>
              </div>`;
            document.getElementById('ewlRemoveCollabBtn').addEventListener('click', async () => {
              const uid = document.getElementById('ewlRemoveCollab').value;
              if (!uid) return;
              await removeCollaborator(wlId, uid);
              renderEditWishlist(wlId);
            });
          });
        }
      }
    }

    function renderManageWishlists() {
      const content = document.getElementById('content');
      content.innerHTML = `
        <div style="overflow-x:hidden;">
          <button class="btn" id="newSlayListBtn" style="width:100%;margin-bottom:16px;font-size:1rem;padding:14px;">
            ${t('btn_new_wishlist')}
          </button>
          <div id="wlManageList" style="padding-right:6px;"></div>
        </div>
      `;
      document.getElementById('newSlayListBtn').addEventListener('click', () => navigateTo('createWishlist'));
      refreshWlManageList();
    }

    function refreshWlManageList() {
      const list = document.getElementById('wlManageList') || document.getElementById('wlList');
      if (!list) return;
      if (wishlists.length === 0) {
        list.innerHTML = `<div class="empty-state"><p>${t('wl_empty')}</p><p style="font-size:0.8rem;color:#999;text-transform:none;">${t('wl_empty_hint')}</p></div>`;
        return;
      }
      list.innerHTML = wishlists.map((wl) => {
        const prClass = wl.privacy === 'private' ? 'private' : (wl.privacy === 'public' ? 'public' : 'shared');
        const prLabel = wl.privacy === 'private' ? t('pr_private') : (wl.privacy === 'public' ? t('pr_public') : t('pr_shared'));
        const shareBtn = wl.privacy === 'public' && isOwner(wl)
          ? `<button class="wl-chip wl-chip-btn action-share" data-wl-share="${escapeHtml(wl.id)}">${t('btn_share')}</button>`
          : '';
        const inviteBtn = wl.privacy === 'shared' && isOwner(wl)
          ? `<button class="wl-chip wl-chip-btn action-invite" data-wl-invite="${escapeHtml(wl.id)}">${t('btn_invite')}</button>`
          : '';
        const isCollab = wl.privacy === 'shared' && canEditWishlist(wl) && !isOwner(wl);
        const isFollowed = !!wl.isFollowedPublic;
        const removeOrLeave = (isCollab || isFollowed)
          ? `<button class="manage-icon-btn danger wl-item-leave" data-wl-id="${escapeHtml(wl.id)}" data-followed="${isFollowed}" title="${t('btn_leave')}" style="font-size:0.65rem;padding:4px;">${t('btn_leave')}</button>`
          : '';
        const editBtn = isFollowed ? '' : `<button class="manage-icon-btn wl-item-edit" data-wl-id="${escapeHtml(wl.id)}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚öô</button>`;
        const wlWishes = wishes.filter((w) => (w.wishlistIds || []).includes(wl.id));
        const imgEl = wl.image
          ? `<img class="manage-card-img" src="${escapeHtml(wl.image)}" alt="" onerror="this.style.background='#eee'">`
          : `<div class="manage-card-img" style="display:flex;align-items:center;justify-content:center;font-size:2rem;">üéÅ</div>`;
        return `
          <div class="manage-card" data-wl-id="${escapeHtml(wl.id)}">
            <!-- Row 1: name + actions -->
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <span class="manage-card-name">${escapeHtml(wl.name)}</span>
              <div class="manage-card-actions">${editBtn}${removeOrLeave}</div>
            </div>
            <!-- Row 2: privacy chip + action chip -->
            <div style="display:flex;align-items:center;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;margin-bottom:12px;">
              <span class="wl-chip privacy-${prClass}">${prLabel}</span>
              ${shareBtn}${inviteBtn}
            </div>
            <!-- Row 3: centered image with count badge on border -->
            <div style="display:flex;justify-content:center;">
              <div style="position:relative;display:inline-block;">
                ${imgEl}
                <span style="position:absolute;bottom:-11px;left:50%;transform:translateX(-50%);background:#000;color:var(--nb-yellow);border:2px solid #000;font-size:0.75rem;font-weight:900;padding:2px 10px;border-radius:100px;box-shadow:2px 2px 0 0 #000;white-space:nowrap;line-height:1.5;font-family:inherit;">${wlWishes.length}</span>
              </div>
            </div>
          </div>`;
      }).join('');

      list.querySelectorAll('.manage-card').forEach((el) => {
        const wlId = el.dataset.wlId;
        el.addEventListener('click', (e) => {
          if (!e.target.closest('.manage-card-actions, [data-wl-share], [data-wl-invite]')) navigateTo('wishlist', wlId);
        });
      });
      list.querySelectorAll('.wl-item-edit').forEach((el) => el.addEventListener('click', (e) => { e.stopPropagation(); navigateTo('editWishlist', el.dataset.wlId); }));
      list.querySelectorAll('.wl-item-remove').forEach((el) => el.addEventListener('click', async (e) => { e.stopPropagation(); await removeWlInManage(el.dataset.wlId); }));
      list.querySelectorAll('.wl-item-leave').forEach((el) => el.addEventListener('click', async (e) => {
        e.stopPropagation();
        const wlId = el.dataset.wlId;
        if (el.dataset.followed === 'true') {
          await leaveFollowedPublicWishlist(wlId);
          if (useSupabase && sb) { const r = await loadWishlistsFromSupabase(); if (r.data) wishlists = r.data; } else wishlists = wishlists.filter((x) => x.id !== wlId);
        } else {
          await leaveWishlist(wlId);
        }
        refreshWlManageList();
        render();
      }));
      list.querySelectorAll('[data-wl-share]').forEach((b) => b.addEventListener('click', (e) => { e.stopPropagation(); openShareModal(b.dataset.wlShare); }));
      list.querySelectorAll('[data-wl-invite]').forEach((b) => b.addEventListener('click', (e) => { e.stopPropagation(); openInviteModal(b.dataset.wlInvite); }));
    }

    function bindWlManageHandlers() {
      document.getElementById('addWlBtn')?.addEventListener('click', addWlInManage);
      document.getElementById('wlImage')?.addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f?.type?.startsWith('image/')) return;
        try {
          let b = await fileToBase64(f);
          b = await resizeImageBase64(b, 400);
          pendingWlImageBase64 = b;
          const prev = document.getElementById('wlImgPreview');
          const txt = document.getElementById('wlImgText');
          if (prev) { prev.src = b; prev.style.display = 'block'; }
          if (txt) txt.textContent = '–§–∞–π–ª –≤—ã–±—Ä–∞–Ω';
        } catch (_) {}
      });
      document.getElementById('wlImgUpload')?.addEventListener('click', () => document.getElementById('wlImage')?.click());
    }

    async function addWlInManage() {
      const nameEl = document.getElementById('newWlName');
      const name = nameEl?.value?.trim();
      if (!name || validateName(name)) return;
      const wl = { id: 'wl_' + Date.now(), name, image: pendingWlImageBase64 || null, privacy: document.getElementById('newWlPrivacy')?.value || 'private', ownerId: currentUserId, coAuthorIds: [currentUserId], updatedAt: Date.now() };
      wishlists.push(wl);
      await saveWishlists();
      pendingWlImageBase64 = null;
      tg?.HapticFeedback?.notificationOccurred?.('success');
      navigateTo('manageWishlists');
    }

    async function removeCollaborator(wlId, userId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl || !isOwner(wl)) return;
      if (useSupabase && sb) {
        await sb.from('wishlist_collaborators').delete().eq('wishlist_id', wlId).eq('user_id', userId);
      }
      if (wl.coAuthorIds) wl.coAuthorIds = wl.coAuthorIds.filter((id) => id !== userId);
      await saveWishlists();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    async function removeWlInManage(wlId) {
      wishes.forEach((w) => { const ids = Array.isArray(w.wishlistIds) ? w.wishlistIds : []; w.wishlistIds = ids.filter((id) => id !== wlId); });
      wishlists = wishlists.filter((x) => x.id !== wlId);
      await saveWishlists();
      await saveWishes();
      refreshWlManageList();
      render();
    }

    async function leaveWishlist(wlId) {
      if (useSupabase && sb) {
        await sb.from('wishlist_collaborators').delete().eq('wishlist_id', wlId).eq('user_id', currentUserId);
        const res = await loadWishlistsFromSupabase();
        wishlists = res.data || wishlists.filter((x) => x.id !== wlId);
      } else {
        const wl = wishlists.find((x) => x.id === wlId);
        if (wl?.coAuthorIds) wl.coAuthorIds = wl.coAuthorIds.filter((id) => id !== currentUserId);
        wishlists = wishlists.filter((x) => x.id !== wlId);
        await saveWishlists();
      }
      wishes.forEach((w) => { const ids = Array.isArray(w.wishlistIds) ? w.wishlistIds : []; w.wishlistIds = ids.filter((id) => id !== wlId); });
      await saveWishes();
      editingWlId = null;
      document.getElementById('wlAddForm').style.display = 'block';
      document.getElementById('wlEditForm').style.display = 'none';
      document.getElementById('wlEditForm').innerHTML = '';
      refreshWlManageList();
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    function openEditWlFormInManage(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl) return;
      editingWlId = wlId;
      document.getElementById('wlAddForm').style.display = 'none';
      let editForm = document.getElementById('wlEditForm');
      editForm.style.display = 'block';
      editForm.innerHTML = `
        <h3 style="margin-bottom:12px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏—à–ª–∏—Å—Ç</h3>
        <div class="form-group">
          <label><span class="required">*</span> –ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" id="editWlName" value="${escapeHtml(wl.name)}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏—à–ª–∏—Å—Ç–∞">
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
          <select id="editWlPrivacy">
            <option value="private" ${wl.privacy === 'private' ? 'selected' : ''}>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
            <option value="public" ${wl.privacy === 'public' ? 'selected' : ''}>–ü—É–±–ª–∏—á–Ω—ã–π</option>
            <option value="shared" ${wl.privacy === 'shared' ? 'selected' : ''}>–°–æ–≤–º–µ—Å—Ç–Ω—ã–π</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
          <div class="img-upload wl-add-img" id="wlImgUploadEdit">
            <input type="file" id="wlImageEdit" accept="image/*">
            <span id="wlImgTextEdit">–û–±–ª–æ–∂–∫–∞</span>
            <img id="wlImgPreviewEdit" class="img-preview" style="display:${wl.image ? 'block' : 'none'};max-height:120px;" src="${wl.image || ''}" alt="">
          </div>
        </div>
        <div id="wlEditFormExtrasManage"></div>
        <div class="form-actions" style="margin-top:16px;">
          <button type="button" class="btn btn-secondary" id="editWlCancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn" id="editWlSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      `;
      const extras = document.getElementById('wlEditFormExtrasManage');
      const isCollab = wl.privacy === 'shared' && canEditWishlist(wl) && !isOwner(wl);
      if (isCollab) {
        extras.innerHTML = '<button type="button" class="btn btn-secondary" id="editWlLeaveManage" style="margin-top:12px;">–ü–æ–∫–∏–Ω—É—Ç—å –≤–∏—à–ª–∏—Å—Ç</button>';
        document.getElementById('editWlLeaveManage').addEventListener('click', async () => { await leaveWishlist(wlId); });
      } else if (wl.privacy === 'shared' && isOwner(wl)) {
        const coAuths = (wl.coAuthorIds || []).filter((id) => id !== (wl.ownerId || wl.owner_id));
        if (coAuths.length > 0) {
          Promise.all(coAuths.map(async (uid) => {
            if (useSupabase && sb) {
              const { data } = await sb.from('users').select('first_name, username').eq('id', uid).single();
              return data ? (data.username ? '@' + data.username : data.first_name || uid) : uid;
            }
            return uid;
          })).then((names) => {
            extras.innerHTML = `
              <div class="form-group" style="margin-top:12px;">
                <label>–£–¥–∞–ª–∏—Ç—å —Å–æ–∞–≤—Ç–æ—Ä–∞</label>
                <select id="editWlRemoveCollabManage" style="width:100%;padding:8px 12px;margin-top:4px;border-radius:8px;background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border);">
                  <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                  ${coAuths.map((id, i) => `<option value="${escapeHtml(id)}">${escapeHtml(names[i] || id)}</option>`).join('')}
                </select>
                <button type="button" class="btn btn-secondary btn-sm" id="editWlRemoveCollabBtnManage" style="margin-top:8px;">–£–¥–∞–ª–∏—Ç—å</button>
              </div>`;
            document.getElementById('editWlRemoveCollabBtnManage').addEventListener('click', async () => {
              const uid = document.getElementById('editWlRemoveCollabManage').value;
              if (!uid) return;
              await removeCollaborator(wlId, uid);
              openEditWlFormInManage(wlId);
            });
          });
        }
      }
      document.getElementById('editWlName').focus();
      document.getElementById('editWlCancel').addEventListener('click', () => { editingWlId = null; document.getElementById('wlAddForm').style.display = 'block'; document.getElementById('wlEditForm').style.display = 'none'; document.getElementById('wlEditForm').innerHTML = ''; renderManageWishlists(); });
      document.getElementById('editWlSave').addEventListener('click', saveEditWlInManage);
      document.getElementById('wlImageEdit').addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (f) fileToBase64(f).then((b) => { document.getElementById('wlImgPreviewEdit').src = b; document.getElementById('wlImgPreviewEdit').style.display = 'block'; document.getElementById('wlImgTextEdit').textContent = '–§–∞–π–ª –≤—ã–±—Ä–∞–Ω'; pendingEditWlImage = b; });
      });
      document.getElementById('wlImgUploadEdit').addEventListener('click', () => document.getElementById('wlImageEdit').click());
    }

    let pendingEditWlImage = null;
    async function saveEditWlInManage() {
      const wl = wishlists.find((x) => x.id === editingWlId);
      if (!wl) return;
      const name = document.getElementById('editWlName')?.value?.trim();
      if (!name || validateName(name)) return;
      wl.name = name;
      wl.privacy = document.getElementById('editWlPrivacy')?.value || 'private';
      if (pendingEditWlImage) wl.image = pendingEditWlImage;
      wl.updatedAt = Date.now();
      pendingEditWlImage = null;
      await saveWishlists();
      editingWlId = null;
      renderManageWishlists();
    }

    function renderManageCategories() {
      const content = document.getElementById('content');
      // –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –∏–∑ –±–∞–∑—ã ‚Äî –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —É–±—Ä–∞–Ω—ã, –æ–Ω–∏ –±—ã–ª–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏

      content.innerHTML = `
        <div style="overflow-x:hidden; padding-right:6px;">
          <button class="btn" id="newTagBtn" style="width:100%;margin-bottom:16px;">
            ${t('btn_new_tag')}
          </button>
          <div id="newTagForm" style="display:none;margin-bottom:16px;gap:8px;align-items:stretch;" class="tag-form-row">
            <input type="text" id="newCatName" placeholder="${t('tag_placeholder')}" style="flex:1;padding:10px 14px;border:2px solid #000;border-radius:8px;box-shadow:2px 2px 0 0 #000;font-size:0.95rem;font-weight:600;outline:none;font-family:inherit;background:#fff;color:#000;caret-color:#000;">
            <button type="button" id="newTagCancel" class="btn btn-outline" style="padding:10px 12px;border-radius:8px;font-size:1.1rem;">‚úï</button>
            <button type="button" class="btn btn-secondary" id="addCatBtn" style="padding:10px 16px;">‚úì</button>
          </div>
          <div id="tagCloud" class="tag-cloud"></div>
          <div style="margin-top:20px;">
            <button type="button" id="tagTrashBtn" class="btn btn-outline" style="width:100%;">${t('btn_delete_tags')}</button>
          </div>
        </div>
      `;

      let deleteMode = false;

      const showNewTagForm = () => {
        document.getElementById('newTagForm').style.display = 'flex';
        document.getElementById('newTagBtn').style.display = 'none';
        document.getElementById('newCatName').value = '';
        document.getElementById('newCatName').focus();
      };
      const hideNewTagForm = () => {
        document.getElementById('newTagForm').style.display = 'none';
        document.getElementById('newTagBtn').style.display = 'block';
      };

      document.getElementById('newTagBtn').addEventListener('click', showNewTagForm);
      document.getElementById('newTagCancel').addEventListener('click', hideNewTagForm);
      document.getElementById('addCatBtn').addEventListener('click', async () => {
        const v = document.getElementById('newCatName').value.trim();
        if (!v || !/^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-_]+$/.test(v)) return;
        if (categories.includes(v)) return;
        categories.push(v);
        await saveCategories();
        hideNewTagForm();
        renderManageCategories();
      });
      document.getElementById('newCatName').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') document.getElementById('addCatBtn').click();
        if (e.key === 'Escape') hideNewTagForm();
      });

      const cloud = document.getElementById('tagCloud');
      if (categories.length === 0) {
        cloud.innerHTML = `<p style="color:rgba(255,255,255,0.4);font-size:0.8rem;font-weight:600;text-transform:uppercase;text-align:center;padding:20px 0;">${t('tags_empty')}</p>`;
      } else {
        cloud.innerHTML = categories.map((c) =>
          `<span class="tag-chip user-tag" data-cat="${escapeHtml(c)}">${escapeHtml(c)}</span>`
        ).join('');
      }

      const trashBtn = document.getElementById('tagTrashBtn');

      cloud.addEventListener('click', (e) => {
        const chip = e.target.closest('.tag-chip.user-tag');
        if (!chip) return;
        if (cloud.dataset.deleteMode !== '1') return;
        chip.classList.toggle('selected');
        tg?.HapticFeedback?.selectionChanged?.();
      });

      trashBtn.addEventListener('click', async () => {
        if (cloud.dataset.deleteMode !== '1') {
          cloud.dataset.deleteMode = '1';
          trashBtn.style.background = '#FF0000';
          trashBtn.style.color = '#fff';
          trashBtn.style.boxShadow = '4px 4px 0 0 #000';
          trashBtn.textContent = t('btn_delete_tags_select');
          cloud.querySelectorAll('.tag-chip.user-tag').forEach((c) => {
            c.style.animation = 'tagShake 0.3s ease-in-out infinite alternate';
          });
          tg?.HapticFeedback?.impactOccurred?.('medium');
          return;
        }
        const selected = [...cloud.querySelectorAll('.tag-chip.user-tag.selected')].map((el) => el.dataset.cat);
        if (selected.length === 0) {
          cloud.dataset.deleteMode = '';
          trashBtn.style.background = '';
          trashBtn.style.color = '';
          trashBtn.style.boxShadow = '';
          trashBtn.textContent = t('btn_delete_tags');
          cloud.querySelectorAll('.tag-chip').forEach((c) => {
            c.classList.remove('selected');
            c.style.animation = '';
          });
          return;
        }
        categories = categories.filter((x) => !selected.includes(x));
        await saveCategories();
        tg?.HapticFeedback?.notificationOccurred?.('success');
        renderManageCategories();
      });
    }

    function getMyWishes() {
      return wishes.filter((w) => {
        const ids = w.wishlistIds || [];
        if (ids.length === 0) return true;
        return ids.some((id) => { const wl = wishlists.find((x) => x.id === id); return wl && !wl.isFollowedPublic; });
      });
    }

    function renderManageWishes() {
      const content = document.getElementById('content');
      const myWishes = getMyWishes();
      const filterSelStyle = 'padding:6px 10px;border:2px solid #000;border-radius:100px;box-shadow:2px 2px 0 0 #000;background:#fff;color:#000;font-size:0.7rem;font-weight:700;text-transform:uppercase;outline:none;font-family:inherit;cursor:pointer;min-width:0;flex:1;';
      const myWls = wishlists.filter((wl) => !wl.isFollowedPublic);
      content.innerHTML = `
        <div style="display:flex;gap:6px;flex-wrap:nowrap;margin-bottom:12px;align-items:center;overflow-x:auto;-webkit-overflow-scrolling:touch;">
          <select id="wishesSortBy" style="${filterSelStyle}">
            <option value="date">${t('filter_by_date')}</option>
            <option value="alpha">${t('filter_az')}</option>
          </select>
          <select id="wishesFilterTag" style="${filterSelStyle}" ${categories.length === 0 ? 'disabled' : ''}>
            <option value="">${categories.length === 0 ? t('filter_no_tags') : t('filter_all_tags')}</option>
            ${categories.map((c) => `<option value="${escapeHtml(c)}">#${escapeHtml(c)}</option>`).join('')}
          </select>
          ${myWls.length > 0 ? `<select id="wishesFilterWl" style="${filterSelStyle}">
            <option value="">${t('filter_all_lists')}</option>
            ${myWls.map((wl) => `<option value="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</option>`).join('')}
          </select>` : ''}
        </div>
        <button class="btn btn-secondary" id="addWishBtn" style="width:100%;margin-bottom:16px;">${t('btn_add_wish')}</button>
        <div id="wishList" class="wish-grid"></div>
      `;
      document.getElementById('addWishBtn').addEventListener('click', () => openWishModal());

      const applySortFilter = () => {
        const sortBy = document.getElementById('wishesSortBy')?.value || 'date';
        const filterTag = document.getElementById('wishesFilterTag')?.value || '';
        const filterWl = document.getElementById('wishesFilterWl')?.value || '';
        let items = [...myWishes];
        if (filterTag) items = items.filter((w) => (w.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏') === filterTag);
        if (filterWl) items = items.filter((w) => (w.wishlistIds || []).includes(filterWl));
        if (sortBy === 'alpha') items.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        else items.sort((a, b) => (parseInt(String(b.id).replace(/\D/g, ''), 10) || 0) - (parseInt(String(a.id).replace(/\D/g, ''), 10) || 0));
        const list = document.getElementById('wishList');
        if (items.length === 0) {
          list.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p>${t('wishes_empty')}</p></div>`;
          return;
        }
        list.innerHTML = items.map((w) => renderCard(w, { type: 'standalone' }, null)).join('');
        list.querySelectorAll('.wish-grid-card').forEach((el) => el.addEventListener('click', () => openWishModal(el.dataset.id)));
      };

      applySortFilter();
      document.getElementById('wishesSortBy')?.addEventListener('change', applySortFilter);
      document.getElementById('wishesFilterTag')?.addEventListener('change', applySortFilter);
      document.getElementById('wishesFilterWl')?.addEventListener('change', applySortFilter);
    }

    async function renderWishlistDetail(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl) { navigateTo('main'); return; }
      if (wl.isFollowedPublic) {
        await renderFollowedPublicDetail(wlId);
        return;
      }
      const content = document.getElementById('content');
      const getIds = (w) => (Array.isArray(w.wishlistIds) ? w.wishlistIds : []);
      const wlWishes = wishes.filter((w) => getIds(w).includes(wlId));
      const byCat = {};
      const noCatLabel = t('wish_category_none');
      wlWishes.forEach((w) => { const c = w.category || noCatLabel; if (!byCat[c]) byCat[c] = []; byCat[c].push(w); });
      const catOrder = [...categories, noCatLabel].filter((c) => byCat[c]?.length);
      Object.keys(byCat).forEach((c) => { if (!catOrder.includes(c)) catOrder.push(c); });
      const pr = wl.privacy;
      const prLabel = pr === 'private' ? t('pr_private') : (pr === 'public' ? t('pr_public') : (pr === 'shared' ? t('pr_shared') : ''));
      const shareBtn = pr === 'public' && isOwner(wl) ? `<button class="wl-chip wl-chip-btn action-share" data-wl-share="${wl.id}">${t('btn_share_chip')}</button>` : '';
      const inviteBtn = pr === 'shared' && isOwner(wl) ? `<button class="wl-chip wl-chip-btn action-invite" data-wl-invite="${wl.id}">${t('btn_invite_chip')}</button>` : '';
      const sec = { type: 'wishlist', wl, wishes: wlWishes };

      const filterSelStyle = 'padding:6px 10px;border:2px solid #000;border-radius:100px;box-shadow:2px 2px 0 0 #000;background:#fff;color:#000;font-size:0.7rem;font-weight:700;text-transform:uppercase;outline:none;font-family:inherit;cursor:pointer;min-width:0;flex:1;';
      content.innerHTML = `
        <div style="margin-bottom:16px;">
          <!-- Row 1: image + title -->
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
            ${wl.image ? `<img src="${escapeHtml(wl.image)}" alt="" style="width:52px;height:52px;border:2px solid #000;border-radius:12px;object-fit:cover;flex-shrink:0;box-shadow:3px 3px 0 0 #000;">` : ''}
            <span style="font-size:1.05rem;font-weight:900;text-transform:uppercase;letter-spacing:-0.02em;color:#fff;line-height:1.2;word-break:break-word;">${escapeHtml(wl.name)}</span>
          </div>
          <!-- Row 2: unified chips -->
          <div style="display:flex;align-items:center;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:2px;">
            <button class="wl-chip wl-chip-btn back" id="wlDetailBackBtn">‚Üê ${t('btn_back')}</button>
            ${prLabel ? `<span class="wl-chip privacy-${pr}">${escapeHtml(prLabel)}</span>` : ''}
            ${shareBtn}${inviteBtn}
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:nowrap;margin-bottom:12px;align-items:center;overflow-x:auto;">
          <select id="wlSortBy" style="${filterSelStyle}">
            <option value="date">${t('filter_by_date')}</option>
            <option value="alpha">${t('filter_az')}</option>
          </select>
          ${categories.length > 0 ? `<select id="wlFilterTag" style="${filterSelStyle}">
            <option value="">${t('filter_all_tags')}</option>
            ${categories.map((c) => `<option value="${escapeHtml(c)}">#${escapeHtml(c)}</option>`).join('')}
          </select>` : ''}
        </div>
        <button class="btn" id="addWishToWl" style="width:100%;margin-bottom:16px;">${t('btn_add_wish_to_wl')}</button>
        <div id="wlWishlistCards" class="wish-grid"></div>
      `;
      document.getElementById('wlDetailBackBtn').addEventListener('click', () => navigateTo('manageWishlists'));

      const applySortFilter = () => {
        const sortBy = document.getElementById('wlSortBy')?.value || 'date';
        const filterTag = document.getElementById('wlFilterTag')?.value || '';
        let items = [...wlWishes];
        if (filterTag) items = items.filter((w) => (w.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏') === filterTag);
        if (sortBy === 'alpha') items.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        else items.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
        const cardsEl = document.getElementById('wlWishlistCards');
        if (!cardsEl) return;
        cardsEl.innerHTML = items.length === 0
          ? `<div class="empty-state" style="grid-column:1/-1;"><p>${t('wishes_empty')}</p></div>`
          : items.map((w) => renderCard(w, sec, null)).join('');
        cardsEl.querySelectorAll('.wish-grid-card').forEach((el) => el.addEventListener('click', () => openWishModal(el.dataset.id)));
      };

      applySortFilter();
      document.getElementById('wlSortBy')?.addEventListener('change', applySortFilter);
      document.getElementById('wlFilterTag')?.addEventListener('change', applySortFilter);

      content.querySelector('#addWishToWl')?.addEventListener('click', () => { openWishModal(null, wlId); });
      content.querySelectorAll('[data-wl-share]').forEach((b) => b.addEventListener('click', () => openShareModal(b.dataset.wlShare)));
      content.querySelectorAll('[data-wl-invite]').forEach((b) => b.addEventListener('click', () => openInviteModal(b.dataset.wlInvite)));
    }

    async function renderFollowedPublicDetail(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl?.isFollowedPublic) return;
      const getIds = (w) => (Array.isArray(w.wishlistIds) ? w.wishlistIds : []);
      const wlWishes = wishes.filter((w) => getIds(w).includes(wlId));
      let reservedCards = {};
      if (useSupabase && sb && wlWishes.length) {
        const wishIds = wlWishes.map((w) => w.id);
        const { data: resRows } = await sb.from('reservations').select('wish_id, user_id, user_name').in('wish_id', wishIds);
        (resRows || []).forEach((r) => { reservedCards[r.wish_id] = { userId: r.user_id, userName: r.user_name || '–ö—Ç–æ-—Ç–æ' }; });
      }
      const byCat = {};
      wlWishes.forEach((w) => { const c = w.category || t('wish_category_none'); if (!byCat[c]) byCat[c] = []; byCat[c].push(w); });
      const catOrder = Object.keys(byCat);
      const content = document.getElementById('content');
      const d = { wishlist: wl, wishes: wlWishes, reservedCards, ownerName: '' };
      content.innerHTML = `
        <button class="btn back-btn" data-nav-back>‚Üê ${t('btn_back')}</button>
        <div class="wl-section">
          <div class="wl-section-header">
            ${wl.image ? `<img class="wl-section-img" src="${escapeHtml(wl.image)}" alt="">` : ''}
            <span class="wl-section-title">${escapeHtml(wl.name || '–í–∏—à–ª–∏—Å—Ç')}</span>
          </div>
          <div class="wl-section-body view-readonly">
            ${catOrder.map((catName) => {
              const catItems = byCat[catName] || [];
              return `
                <div class="categories-section">
                  <div class="category-title"><span class="count">${catItems.length}</span> ${escapeHtml(catName)}</div>
                  <div class="wishlist">${catItems.map((w) => renderCard(w, null, { reserved: reservedCards, items: d })).join('')}</div>
                </div>`;
            }).join('')}
          </div>
        </div>`;
      content.querySelector('[data-nav-back]').addEventListener('click', () => navigateTo('main'));
      content.querySelectorAll('.btn-reserve').forEach((b) => b.addEventListener('click', () => reserveCardInFollowed(wlId, b.dataset.cardId)));
      content.querySelectorAll('.btn-unreserve').forEach((b) => b.addEventListener('click', () => unreserveCardInFollowed(wlId, b.dataset.cardId)));
    }

    async function reserveCardInFollowed(wlId, cardId) {
      if (!useSupabase || !sb) return;
      const u = tg?.initDataUnsafe?.user;
      const userId = u?.id ? 'tg_' + u.id : 'anon_' + Date.now();
      const userName = u?.first_name || '–ö—Ç–æ-—Ç–æ';
      await sb.from('reservations').upsert({ wish_id: cardId, user_id: userId, user_name: userName }, { onConflict: 'wish_id' });
      tg?.HapticFeedback?.notificationOccurred?.('success');
      renderWishlistDetail(wlId);
    }

    async function unreserveCardInFollowed(wlId, cardId) {
      if (!useSupabase || !sb) return;
      const u = tg?.initDataUnsafe?.user;
      const userId = u?.id ? 'tg_' + u.id : null;
      const { data: r } = await sb.from('reservations').select('user_id').eq('wish_id', cardId).single();
      if (!r || (userId && r.user_id !== userId)) return;
      await sb.from('reservations').delete().eq('wish_id', cardId);
      tg?.HapticFeedback?.notificationOccurred?.('success');
      renderWishlistDetail(wlId);
    }

    function renderPublicView() {
      const d = publicViewData;
      const content = document.getElementById('content');
      const wl = d.wishlist || {};
      const items = d.wishes || [];
      const reserved = d.reservedCards || {};
      const byCat = {};
      items.forEach((w) => {
        const c = w.category || t('wish_category_none');
        if (!byCat[c]) byCat[c] = [];
        byCat[c].push(w);
      });
      const catOrder = Object.keys(byCat);
      content.innerHTML = `
        <button class="btn back-btn" id="publicViewHomeBtn" style="margin-bottom:16px;">üè† ${t('nav_home')}</button>
        <div class="wl-section">
          <div class="wl-section-header">
            ${wl.image ? `<img class="wl-section-img" src="${escapeHtml(wl.image)}" alt="">` : ''}
            <span class="wl-section-title">${escapeHtml(wl.name || '–í–∏—à–ª–∏—Å—Ç')}</span>
          </div>
          <div class="wl-section-body view-readonly">
            ${catOrder.map((catName) => {
              const catItems = byCat[catName] || [];
              return `
                <div class="categories-section">
                  <div class="category-title"><span class="count">${catItems.length}</span> ${escapeHtml(catName)}</div>
                  <div class="wishlist">${catItems.map((w) => renderCard(w, null, { reserved, items: d })).join('')}</div>
                </div>`;
            }).join('')}
          </div>
        </div>`;
      content.querySelector('#publicViewHomeBtn')?.addEventListener('click', () => {
        sessionStorage.setItem('publicViewGoHome', '1');
        history.replaceState(null, '', window.location.pathname);
        window.location.reload();
      });
      content.querySelectorAll('.btn-reserve').forEach((b) => b.addEventListener('click', () => reserveCard(b.dataset.cardId)));
      content.querySelectorAll('.btn-unreserve').forEach((b) => b.addEventListener('click', () => unreserveCard(b.dataset.cardId)));
    }

    async function reserveCard(cardId) {
      if (!publicViewData) return;
      const u = tg?.initDataUnsafe?.user;
      const userId = u?.id ? 'tg_' + u.id : 'anon_' + Date.now();
      const userName = u?.first_name || '–ö—Ç–æ-—Ç–æ';
      const reserved = { ...(publicViewData.reservedCards || {}) };
      reserved[cardId] = { userId, userName };
      publicViewData.reservedCards = reserved;
      const base = window.location.origin + window.location.pathname;
      const hash = window.location.hash.slice(1);
      if (hash.startsWith('w/') && useSupabase && sb) {
        await sb.from('reservations').upsert({ wish_id: cardId, user_id: userId, user_name: userName }, { onConflict: 'wish_id' });
        history.replaceState(null, '', base + '#' + hash);
      } else {
        await ensureLzString();
        history.replaceState(null, '', base + '#' + packPayload(publicViewData));
      }
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    async function unreserveCard(cardId) {
      if (!publicViewData) return;
      const u = tg?.initDataUnsafe?.user;
      const userId = u?.id ? 'tg_' + u.id : null;
      const reserved = publicViewData.reservedCards?.[cardId];
      if (!reserved || (userId && reserved.userId !== userId)) return;
      const next = { ...(publicViewData.reservedCards || {}) };
      delete next[cardId];
      publicViewData.reservedCards = next;
      const base = window.location.origin + window.location.pathname;
      const hash = window.location.hash.slice(1);
      if (hash.startsWith('w/') && useSupabase && sb) {
        await sb.from('reservations').delete().eq('wish_id', cardId);
        history.replaceState(null, '', base + '#' + hash);
      } else {
        await ensureLzString();
        history.replaceState(null, '', base + '#' + packPayload(publicViewData));
      }
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    document.addEventListener('click', () => closeMoveMenus());

    function toggleMoveMenu(e, wishId) {
      e.stopPropagation();
      closeMoveMenus();
      const btn = document.querySelector(`.btn-move[data-id="${wishId}"]`);
      if (!btn) return;
      const wrap = btn.closest('.card-move-wrap');
      const w = wishes.find((x) => x.id === wishId);
      const ids = Array.isArray(w?.wishlistIds) ? w.wishlistIds : [];
      const menu = document.createElement('div');
      menu.className = 'card-move-menu';
      wishlists.filter((wl) => !wl.isFollowedPublic).forEach((wl) => {
        const inList = ids.includes(wl.id);
        const opt = document.createElement('button');
        opt.textContent = inList ? `‚úì –£–±—Ä–∞—Ç—å –∏–∑ ¬´${wl.name}¬ª` : `–î–æ–±–∞–≤–∏—Ç—å –≤ ¬´${wl.name}¬ª`;
        opt.addEventListener('click', async (e2) => { e2.stopPropagation(); await toggleWishWishlist(wishId, wl.id); closeMoveMenus(); });
        menu.appendChild(opt);
      });
      if (menu.children.length === 0) return;
      wrap.appendChild(menu);
    }

    function closeMoveMenus() {
      document.querySelectorAll('.card-move-menu').forEach((m) => m.remove());
    }

    async function toggleWishWishlist(wishId, wlId) {
      const w = wishes.find((x) => x.id === wishId);
      if (!w) return;
      const ids = Array.isArray(w.wishlistIds) ? [...w.wishlistIds] : [];
      const idx = ids.indexOf(wlId);
      if (idx >= 0) ids.splice(idx, 1);
      else ids.push(wlId);
      w.wishlistIds = ids;
      const wl = wishlists.find((x) => x.id === wlId);
      if (wl) wl.updatedAt = Date.now();
      await saveWishes();
      await saveWishlists();
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    function renderCard(w, section, publicViewOpts) {
      const priceStr = formatPrice(w.price, w.currency);
      const isPublicView = !!publicViewOpts;
      const reserved = publicViewOpts?.reserved?.[w.id];
      const reservedClass = reserved ? ' card-reserved' : '';
      const isReservedByMe = reserved && reserved.userId === currentUserId;

      // Grid-card view: square image, badges overlay, click = edit
      if (!isPublicView) {
        return `
          <div class="card wish-grid-card${reservedClass}" data-id="${w.id}" style="cursor:pointer;position:relative;border-radius:10px;overflow:hidden;aspect-ratio:1;">
            ${w.image
              ? `<img src="${escapeHtml(w.image)}" alt="" loading="lazy" style="width:100%;height:100%;object-fit:cover;display:block;" onerror="this.style.display='none'">`
              : `<div style="width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;font-size:2.8rem;">üéÅ</div>`}
            ${priceStr ? `<div style="position:absolute;top:7px;right:7px;background:#FFFF00;border:1.5px solid #000;padding:2px 7px;font-size:0.68rem;font-weight:800;box-shadow:2px 2px 0 0 rgba(0,0,0,0.7);line-height:1.4;max-width:80%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(priceStr)}</div>` : ''}
            <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.55);padding:7px 8px;">
              <div style="color:#fff;font-size:0.8rem;font-weight:900;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3;text-shadow:0 0 6px #000,1px 1px 0 #000,-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000;">${escapeHtml(w.name)}</div>
            </div>
            ${reserved ? `<div style="position:absolute;top:7px;left:7px;background:#FF00FF;border:1.5px solid #000;padding:2px 6px;font-size:0.6rem;font-weight:700;color:#fff;">üîñ</div>` : ''}
          </div>`;
      }

      // Public view: with reserve/unreserve button
      let reserveBtn = '';
      if (!reserved) reserveBtn = `<button class="btn btn-sm btn-reserve" data-card-id="${w.id}" style="background:#00FFFF;color:#000;width:100%;">${t('btn_reserve')}</button>`;
      else if (isReservedByMe) reserveBtn = `<button class="btn btn-sm btn-secondary btn-unreserve" data-card-id="${w.id}" style="width:100%;">${t('btn_unreserve')}</button>`;

      return `
        <div class="card${reservedClass}" data-id="${w.id}" style="position:relative;border-radius:10px;overflow:hidden;">
          ${w.image
            ? `<img style="width:100%;aspect-ratio:1;object-fit:cover;display:block;border-bottom:1.5px solid rgba(0,0,0,0.15);" src="${escapeHtml(w.image)}" alt="" loading="lazy" onerror="this.style.display='none'">`
            : `<div style="width:100%;aspect-ratio:1;background:#eee;display:flex;align-items:center;justify-content:center;font-size:2.8rem;">üéÅ</div>`}
          ${priceStr ? `<div style="position:absolute;top:7px;right:7px;background:#FFFF00;border:1.5px solid #000;padding:2px 7px;font-size:0.68rem;font-weight:800;box-shadow:2px 2px 0 0 rgba(0,0,0,0.7);">${escapeHtml(priceStr)}</div>` : ''}
          <div style="position:absolute;bottom:${reserved ? '44px' : '0'};left:0;right:0;background:rgba(0,0,0,0.65);padding:5px 8px;">
            <div style="color:#fff;font-size:0.68rem;font-weight:800;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(w.name)}</div>
          </div>
          ${reserved ? `<div style="background:#fff;border-top:1.5px solid #000;padding:6px 8px;">${reserveBtn}</div>` : ''}
          ${reserveBtn && !reserved ? `<div style="background:#fff;border-top:1.5px solid #000;padding:6px 8px;">${reserveBtn}</div>` : ''}
        </div>`;
    }

    function openWishModalFromLink(extractedData, link) {
      window._wishFromLink = true;
      window._wishFromImage = false;
      window._stashedImageFromPhoto = null;
      _imageFromPhotoForSave = null;
      tg?.HapticFeedback?.impactOccurred?.('light');
      const imgSrc = extractedData?.imageBase64 || extractedData?.image || null;
      pendingImageBase64 = extractedData?.imageBase64 || extractedData?.image || null;
      const form = document.getElementById('wishForm');
      form.reset();
      document.getElementById('wishId').value = '';
      const imgPreview = document.getElementById('imgPreview');
      if (imgSrc) {
        imgPreview.src = imgSrc;
        imgPreview.style.display = 'block';
        imgPreview.onerror = () => { imgPreview.style.display = 'none'; pendingImageBase64 = null; };
        document.getElementById('imgUploadText').textContent = t('wish_image_change');
      } else {
        imgPreview.style.display = 'none';
        document.getElementById('imgUploadText').textContent = t('wish_image_placeholder');
      }
      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });
      document.getElementById('wishModalTitle').textContent = t('modal_from_link');
      document.getElementById('wishLink').value = link || extractedData?.link || '';
      updateClosingConfirmation();
      const autoFilled = new Set();
      if (extractedData?.name) {
        document.getElementById('wishName').value = extractedData.name;
        autoFilled.add('name');
      }
      if (extractedData?.price != null) {
        document.getElementById('wishPrice').value = String(extractedData.price);
        autoFilled.add('price');
      }
      if (extractedData?.currency) {
        const normalized = normalizeCurrency(extractedData.currency);
        if (normalized) {
          document.getElementById('wishCurrency').value = normalized;
          autoFilled.add('currency');
        }
      }
      if (extractedData?.size) {
        document.getElementById('wishSize').value = extractedData.size;
        autoFilled.add('size');
      }
      const sel = document.getElementById('wishCategory');
      sel.innerHTML = `<option value="">${t('wish_category_none')}</option>` +
        categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      const wlSelect = document.getElementById('wishWishlistSelect');
      const selectedIds = new Set();
      const editableWishlists = wishlists.filter((wl) => !wl.isFollowedPublic);
      wlSelect.innerHTML = editableWishlists.length === 0
        ? `<span style="color:var(--text-secondary);font-size:0.9rem;">${t('wish_wl_empty')}</span>`
        : `<div class="multiselect-trigger" id="wlMultiselectTrigger"></div>
           <div class="multiselect-panel" id="wlMultiselectPanel">
             ${editableWishlists.map((wl) => `<div class="multiselect-option" data-id="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</div>`).join('')}
           </div>`;
      const trig = document.getElementById('wlMultiselectTrigger');
      const pan = document.getElementById('wlMultiselectPanel');
      if (trig && pan) {
        const renderMultiselect = () => {
          const names = editableWishlists.filter((wl) => selectedIds.has(wl.id)).map((wl) => wl.name);
          trig.innerHTML = names.length > 0
            ? names.map((n) => `<span class="multiselect-chip">${escapeHtml(n)}</span>`).join('')
            : `<span class="multiselect-placeholder">${t('wish_wl_placeholder')}</span>`;
          pan.querySelectorAll('.multiselect-option').forEach((opt) => opt.classList.toggle('selected', selectedIds.has(opt.dataset.id)));
        };
        trig.addEventListener('click', (e) => { e.stopPropagation(); wlSelect.classList.toggle('open'); });
        pan.querySelectorAll('.multiselect-option').forEach((opt) => {
          opt.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = opt.dataset.id;
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            renderMultiselect();
          });
        });
        document.addEventListener('click', () => wlSelect.classList.remove('open'), { once: true });
        wlSelect._getSelectedIds = () => [...selectedIds];
        renderMultiselect();
      }
      document.querySelectorAll('.form-group label').forEach((label) => {
        const inputId = label.getAttribute('for');
        if (!inputId) return;
        const fieldName = inputId.replace('wish', '').toLowerCase();
        if (autoFilled.has(fieldName) || (fieldName === 'link' && link)) {
          label.style.color = 'var(--accent)';
          label.innerHTML = label.textContent.replace(/\s*\(–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ\)/g, '').replace(new RegExp('\\s*\\(' + t('autofilled').replace(/[()]/g,'\\$&') + '\\)', 'g'), '') + ` <span style="font-size:0.7rem;opacity:0.7;">${t('autofilled')}</span>`;
        }
      });
      updateCounters();
      document.getElementById('wishModal').classList.add('open');
    }

    function openWishModalFromText(extractedData) {
      window._wishFromLink = true;
      window._wishFromImage = false;
      window._stashedImageFromPhoto = null;
      _imageFromPhotoForSave = null;
      tg?.HapticFeedback?.impactOccurred?.('light');
      pendingImageBase64 = PLACEHOLDER_IMAGE;
      const form = document.getElementById('wishForm');
      form.reset();
      document.getElementById('wishId').value = '';
      const imgPreview = document.getElementById('imgPreview');
      imgPreview.src = PLACEHOLDER_IMAGE;
      imgPreview.style.display = 'block';
      imgPreview.onerror = () => { imgPreview.style.display = 'none'; pendingImageBase64 = null; };
      document.getElementById('imgUploadText').textContent = t('wish_image_change');
      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });
      document.getElementById('wishModalTitle').textContent = t('modal_from_text');
      document.getElementById('wishLink').value = '';
      updateClosingConfirmation();
      const autoFilled = new Set();
      if (extractedData?.name) {
        document.getElementById('wishName').value = extractedData.name;
        autoFilled.add('name');
      }
      if (extractedData?.price != null) {
        document.getElementById('wishPrice').value = String(extractedData.price);
        autoFilled.add('price');
      }
      if (extractedData?.currency) {
        const normalized = normalizeCurrency(extractedData.currency);
        if (normalized) {
          document.getElementById('wishCurrency').value = normalized;
          autoFilled.add('currency');
        }
      }
      if (extractedData?.size) {
        document.getElementById('wishSize').value = extractedData.size;
        autoFilled.add('size');
      }
      const sel = document.getElementById('wishCategory');
      sel.innerHTML = `<option value="">${t('wish_category_none')}</option>` +
        categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      const wlSelect = document.getElementById('wishWishlistSelect');
      const selectedIds = new Set();
      const editableWishlists = wishlists.filter((wl) => !wl.isFollowedPublic);
      wlSelect.innerHTML = editableWishlists.length === 0
        ? `<span style="color:var(--text-secondary);font-size:0.9rem;">${t('wish_wl_empty')}</span>`
        : `<div class="multiselect-trigger" id="wlMultiselectTrigger"></div>
           <div class="multiselect-panel" id="wlMultiselectPanel">
             ${editableWishlists.map((wl) => `<div class="multiselect-option" data-id="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</div>`).join('')}
           </div>`;
      const trig = document.getElementById('wlMultiselectTrigger');
      const pan = document.getElementById('wlMultiselectPanel');
      if (trig && pan) {
        const renderMultiselect = () => {
          const names = editableWishlists.filter((wl) => selectedIds.has(wl.id)).map((wl) => wl.name);
          trig.innerHTML = names.length > 0
            ? names.map((n) => `<span class="multiselect-chip">${escapeHtml(n)}</span>`).join('')
            : `<span class="multiselect-placeholder">${t('wish_wl_placeholder')}</span>`;
          pan.querySelectorAll('.multiselect-option').forEach((opt) => opt.classList.toggle('selected', selectedIds.has(opt.dataset.id)));
        };
        trig.addEventListener('click', (e) => { e.stopPropagation(); wlSelect.classList.toggle('open'); });
        pan.querySelectorAll('.multiselect-option').forEach((opt) => {
          opt.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = opt.dataset.id;
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            renderMultiselect();
          });
        });
        document.addEventListener('click', () => wlSelect.classList.remove('open'), { once: true });
        wlSelect._getSelectedIds = () => [...selectedIds];
        renderMultiselect();
      }
      document.querySelectorAll('.form-group label').forEach((label) => {
        const inputId = label.getAttribute('for');
        if (!inputId) return;
        const fieldName = inputId.replace('wish', '').toLowerCase();
        if (autoFilled.has(fieldName)) {
          label.style.color = 'var(--accent)';
          label.innerHTML = label.textContent.replace(/\s*\(–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ\)/g, '').replace(new RegExp('\\s*\\(' + t('autofilled').replace(/[()]/g,'\\$&') + '\\)', 'g'), '') + ` <span style="font-size:0.7rem;opacity:0.7;">${t('autofilled')}</span>`;
        }
      });
      updateCounters();
      document.getElementById('wishModal').classList.add('open');
    }

    function openWishModalFromImage(imageBase64, extractedData) {
      window._wishFromLink = false;
      window._wishFromImage = true;
      const hasRealImage = imageBase64 && imageBase64 !== PLACEHOLDER_IMAGE;
      const imageToUse = hasRealImage ? imageBase64 : null;
      window._stashedImageFromPhoto = imageToUse;
      _imageFromPhotoForSave = imageToUse;
      pendingImageBase64 = imageToUse;
      tg?.HapticFeedback?.impactOccurred?.('light');
      const form = document.getElementById('wishForm');
      form.reset();
      document.getElementById('wishId').value = '';
      const imgPreview = document.getElementById('imgPreview');
      if (hasRealImage) {
        imgPreview.src = imageBase64;
        imgPreview.style.display = 'block';
        imgPreview.onerror = () => { imgPreview.style.display = 'none'; };
        document.getElementById('imgUploadText').textContent = t('wish_image_change');
      } else {
        imgPreview.style.display = 'none';
        imgPreview.removeAttribute('src');
        document.getElementById('imgUploadText').textContent = t('wish_image_placeholder');
      }
      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });
      document.getElementById('wishModalTitle').textContent = t('modal_from_image');
      
      // –í–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã —Å –¥–∞–Ω–Ω—ã–º–∏
      updateClosingConfirmation();
      
      const autoFilled = new Set();
      if (extractedData.name) {
        document.getElementById('wishName').value = extractedData.name;
        autoFilled.add('name');
      }
      if (extractedData.price) {
        document.getElementById('wishPrice').value = String(extractedData.price);
        autoFilled.add('price');
      }
      if (extractedData.currency) {
        const normalized = normalizeCurrency(extractedData.currency);
        if (normalized) {
          document.getElementById('wishCurrency').value = normalized;
          autoFilled.add('currency');
        }
      }
      if (extractedData.size) {
        document.getElementById('wishSize').value = extractedData.size;
        autoFilled.add('size');
      }
      
      const sel = document.getElementById('wishCategory');
      sel.innerHTML = `<option value="">${t('wish_category_none')}</option>` +
        categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

      const wlSelect = document.getElementById('wishWishlistSelect');
      const selectedIds = new Set();
      const editableWishlists = wishlists.filter((wl) => !wl.isFollowedPublic);
      const renderMultiselect = () => {
        const names = editableWishlists.filter((wl) => selectedIds.has(wl.id)).map((wl) => wl.name);
        trigger.innerHTML = names.length > 0
          ? names.map((n) => `<span class="multiselect-chip">${escapeHtml(n)}</span>`).join('')
          : '<span class="multiselect-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏—à–ª–∏—Å—Ç—ã</span>';
        panel.querySelectorAll('.multiselect-option').forEach((opt) => opt.classList.toggle('selected', selectedIds.has(opt.dataset.id)));
      };
      wlSelect.innerHTML = editableWishlists.length === 0
        ? `<span style="color:var(--text-secondary);font-size:0.9rem;">${t('wish_wl_empty')}</span>`
        : `<div class="multiselect-trigger" id="wlMultiselectTrigger"></div>
           <div class="multiselect-panel" id="wlMultiselectPanel">
             ${editableWishlists.map((wl) => `<div class="multiselect-option" data-id="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</div>`).join('')}
           </div>`;
      const trigger = document.getElementById('wlMultiselectTrigger');
      const panel = document.getElementById('wlMultiselectPanel');
      if (trigger && panel) {
        trigger.addEventListener('click', (e) => { e.stopPropagation(); wlSelect.classList.toggle('open'); });
        panel.querySelectorAll('.multiselect-option').forEach((opt) => {
          opt.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = opt.dataset.id;
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            renderMultiselect();
          });
        });
        document.addEventListener('click', () => wlSelect.classList.remove('open'), { once: true });
        wlSelect._getSelectedIds = () => [...selectedIds];
        renderMultiselect();
      }
      
      document.querySelectorAll('.form-group label').forEach((label) => {
        const inputId = label.getAttribute('for');
        if (!inputId) return;
        const fieldName = inputId.replace('wish', '').toLowerCase();
        if (autoFilled.has(fieldName)) {
          label.style.color = 'var(--accent)';
          label.innerHTML = label.textContent + ` <span style="font-size:0.7rem;opacity:0.7;">${t('autofilled')}</span>`;
        }
      });
      
      updateCounters();
      document.getElementById('wishModal').classList.add('open');
      // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert ‚Äî –ø–æ–ø–∞–ø –∞–Ω–∞–ª–∏–∑–∞ –µ—â—ë –æ—Ç–∫—Ä—ã—Ç, —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É
    }

    function openWishModal(editId = null, defaultWlId = null) {
      window._wishFromLink = false;
      window._wishFromImage = false;
      window._stashedImageFromPhoto = null;
      _imageFromPhotoForSave = null;
      tg?.HapticFeedback?.impactOccurred?.('light');
      pendingImageBase64 = null;
      const form = document.getElementById('wishForm');
      form.reset();
      document.getElementById('wishId').value = '';
      document.getElementById('imgPreview').style.display = 'none';
      document.getElementById('imgUploadText').textContent = t('wish_image_placeholder');
      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });
      document.getElementById('wishModalTitle').textContent = editId ? t('modal_edit_wish') : t('modal_add_wish');
      const delSection = document.getElementById('wishDeleteSection');
      if (delSection) {
        delSection.style.display = editId ? 'block' : 'none';
        const delBtn = document.getElementById('wishDeleteBtn');
        if (delBtn) {
          delBtn.onclick = async () => {
            if (!confirm(t('confirm_delete_wish'))) return;
            closeWishModal();
            await deleteWish(editId);
            render();
          };
        }
      }
      
      // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—É—Å—Ç–æ–π —Ñ–æ—Ä–º—ã (–±—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –ø—Ä–∏ –≤–≤–æ–¥–µ –¥–∞–Ω–Ω—ã—Ö)
      updateClosingConfirmation();
      
      document.querySelectorAll('.form-group label').forEach((label) => {
        label.style.color = '';
        const text = label.textContent.replace(/\s*\(–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ\)/g, '').replace(new RegExp('\\s*\\(' + t('autofilled').replace(/[()]/g,'\\$&') + '\\)', 'g'), '');
        label.textContent = text;
      });

      const sel = document.getElementById('wishCategory');
      sel.innerHTML = `<option value="">${t('wish_category_none')}</option>` +
        categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

      const wlSelect = document.getElementById('wishWishlistSelect');
      const initialIds = editId ? (wishes.find((x) => x.id === editId)?.wishlistIds || []) : (defaultWlId ? [defaultWlId] : []);
      const selectedIds = new Set(Array.isArray(initialIds) ? initialIds : []);
      const editableWishlists = wishlists.filter((wl) => !wl.isFollowedPublic);
      const renderMultiselect = () => {
        const names = editableWishlists.filter((wl) => selectedIds.has(wl.id)).map((wl) => wl.name);
        trigger.innerHTML = names.length > 0
          ? names.map((n) => `<span class="multiselect-chip">${escapeHtml(n)}</span>`).join('')
          : '<span class="multiselect-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏—à–ª–∏—Å—Ç—ã</span>';
        panel.querySelectorAll('.multiselect-option').forEach((opt) => opt.classList.toggle('selected', selectedIds.has(opt.dataset.id)));
      };
      wlSelect.innerHTML = editableWishlists.length === 0
        ? `<span style="color:var(--text-secondary);font-size:0.9rem;">${t('wish_wl_empty')}</span>`
        : `<div class="multiselect-trigger" id="wlMultiselectTrigger"></div>
           <div class="multiselect-panel" id="wlMultiselectPanel">
             ${editableWishlists.map((wl) => `<div class="multiselect-option" data-id="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</div>`).join('')}
           </div>`;
      const trigger = document.getElementById('wlMultiselectTrigger');
      const panel = document.getElementById('wlMultiselectPanel');
      if (trigger && panel) {
        trigger.addEventListener('click', (e) => { e.stopPropagation(); wlSelect.classList.toggle('open'); });
        panel.querySelectorAll('.multiselect-option').forEach((opt) => {
          opt.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = opt.dataset.id;
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            renderMultiselect();
          });
        });
        document.addEventListener('click', () => wlSelect.classList.remove('open'), { once: true });
        wlSelect._getSelectedIds = () => [...selectedIds];
        renderMultiselect();
      }

      if (editId) {
        const w = wishes.find((x) => x.id === editId);
        if (w) {
          document.getElementById('wishId').value = w.id;
          document.getElementById('wishName').value = w.name || '';
          document.getElementById('wishPrice').value = w.price || '';
          document.getElementById('wishCurrency').value = w.currency || '';
          document.getElementById('wishSize').value = w.size || '';
          document.getElementById('wishLink').value = w.link || '';
          document.getElementById('wishComment').value = w.comment || '';
          document.getElementById('wishCategory').value = w.category || '';
          if (w.image) {
            pendingImageBase64 = w.image;
            document.getElementById('imgPreview').src = w.image;
            document.getElementById('imgPreview').style.display = 'block';
            document.getElementById('imgUploadText').textContent = t('wish_image_change');
          }
        }
      }
      updateCounters();
      document.getElementById('wishModal').classList.add('open');
    }

    function closeWishModal() {
      document.getElementById('wishModal').classList.remove('open');
      window._wishFromImage = false;
      window._stashedImageFromPhoto = null;
      _imageFromPhotoForSave = null;
      updateClosingConfirmation();
    }

    function updateCounters() {
      try {
        const nameEl = document.getElementById('nameCounter');
        const commentEl = document.getElementById('commentCounter');
        const wishName = document.getElementById('wishName');
        const wishComment = document.getElementById('wishComment');
        if (nameEl && wishName) nameEl.textContent = `${(wishName.value || '').length}/100`;
        if (commentEl && wishComment) commentEl.textContent = `${(wishComment.value || '').length}/500`;
      } catch (_) {}
    }

    document.getElementById('wishName')?.addEventListener('input', () => { updateCounters(); updateClosingConfirmation(); });
    document.getElementById('wishComment')?.addEventListener('input', () => { updateCounters(); updateClosingConfirmation(); });
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—è—Ö —Ñ–æ—Ä–º—ã –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
    ['wishLink', 'wishPrice', 'wishSize', 'wishWishlist'].forEach((id) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', updateClosingConfirmation);
        el.addEventListener('change', updateClosingConfirmation);
      }
    });
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.getElementById('wishImage')?.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        updateClosingConfirmation();
      }
    });

    document.getElementById('imgUpload').addEventListener('click', () => document.getElementById('wishImage').click());
    document.getElementById('imgUpload').addEventListener('dragover', (e) => { e.preventDefault(); document.getElementById('imgUpload').classList.add('dragover'); });
    document.getElementById('imgUpload').addEventListener('dragleave', () => document.getElementById('imgUpload').classList.remove('dragover'));
    document.getElementById('imgUpload').addEventListener('drop', (e) => {
      e.preventDefault();
      document.getElementById('imgUpload').classList.remove('dragover');
      const f = e.dataTransfer?.files?.[0];
      if (f && f.type.startsWith('image/')) handleImageFile(f);
    });
    document.getElementById('wishImage').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) handleImageFile(f);
    });

    async function handleImageFile(file) {
      document.getElementById('imgError').style.display = 'none';
      try {
        let b64 = await fileToBase64(file);
        b64 = await resizeImageBase64(b64, 960, 0.8);
        pendingImageBase64 = b64;
        if (window._wishFromImage) { window._stashedImageFromPhoto = b64; _imageFromPhotoForSave = b64; }
        document.getElementById('imgPreview').src = b64;
        document.getElementById('imgPreview').style.display = 'block';
        document.getElementById('imgUploadText').textContent = t('wish_image_change');
        updateClosingConfirmation();
      } catch (e) {
        document.getElementById('imgError').textContent = t('err_image_upload');
        document.getElementById('imgError').style.display = 'block';
      }
    }

    document.getElementById('wishForm').addEventListener('submit', (async (e) => {
      e.preventDefault();
      const id = document.getElementById('wishId').value;
      const isNew = !id;
      const capturedImageFromPhoto = window._wishFromImage ? (_imageFromPhotoForSave || window._stashedImageFromPhoto || null) : null;
      const name = document.getElementById('wishName').value.trim();
      const price = document.getElementById('wishPrice').value;
      const currency = document.getElementById('wishCurrency').value;
      const size = document.getElementById('wishSize').value.trim();
      const link = document.getElementById('wishLink').value.trim();
      const comment = document.getElementById('wishComment').value.trim();
      const category = document.getElementById('wishCategory').value || undefined;
      const wlSel = document.getElementById('wishWishlistSelect');
      const wishlistIds = wlSel?._getSelectedIds ? wlSel._getSelectedIds() : [];

      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });

      const hasValidImage = (pendingImageBase64 && pendingImageBase64 !== PLACEHOLDER_IMAGE) || (window._wishFromImage && (capturedImageFromPhoto || window._stashedImageFromPhoto || _imageFromPhotoForSave));
      if (isNew && window._wishFromImage && !hasValidImage) {
        document.getElementById('imgError').textContent = t('err_image_required_photo');
        document.getElementById('imgError').style.display = 'block';
        return;
      }
      if (isNew && !hasValidImage && !window._wishFromLink) {
        document.getElementById('imgError').textContent = t('err_image_required');
        document.getElementById('imgError').style.display = 'block';
        return;
      }
      const nameErr = validateName(name);
      if (nameErr) {
        document.getElementById('nameError').textContent = nameErr;
        document.getElementById('nameError').style.display = 'block';
        return;
      }
      const linkErr = validateLink(link);
      if (linkErr) {
        document.getElementById('linkError').textContent = linkErr;
        document.getElementById('linkError').style.display = 'block';
        return;
      }
      const priceErr = validatePrice(price);
      if (priceErr && price) {
        document.getElementById('priceError').textContent = priceErr;
        document.getElementById('priceError').style.display = 'block';
        return;
      }
      const sizeErr = validateSize(size);
      if (sizeErr) {
        document.getElementById('sizeError').textContent = sizeErr;
        document.getElementById('sizeError').style.display = 'block';
        return;
      }

      let imageForSave = (window._wishFromImage && capturedImageFromPhoto)
        ? capturedImageFromPhoto
        : (window._wishFromImage && (_imageFromPhotoForSave || window._stashedImageFromPhoto))
          ? (_imageFromPhotoForSave || window._stashedImageFromPhoto)
          : (pendingImageBase64 && pendingImageBase64 !== PLACEHOLDER_IMAGE)
            ? pendingImageBase64
            : (wishes.find((x) => x.id === id)?.image);
      if (imageForSave && typeof imageForSave === 'string' && imageForSave.startsWith('data:image/') && useSupabase && sb) {
        const uploadedUrl = await uploadImageToSupabaseStorage(imageForSave);
        if (uploadedUrl) imageForSave = uploadedUrl;
      }
      const payload = {
        id: id || 'w_' + Date.now(),
        name,
        image: imageForSave,
        price: price ? (() => { const n = parseFloat(String(price).replace(',', '.')); return isNaN(n) ? undefined : String(Math.round(n * 100) / 100); })() : undefined,
        currency: currency || undefined,
        size: size || undefined,
        link: link || undefined,
        comment: comment || undefined,
        category,
        wishlistIds,
      };

      const idx = wishes.findIndex((x) => x.id === payload.id);
      if (idx >= 0) wishes[idx] = { ...wishes[idx], ...payload };
      else wishes.push(payload);

      wishlistIds.forEach((wlId) => { const wl = wishlists.find((x) => x.id === wlId); if (wl) wl.updatedAt = Date.now(); });
      try {
        await saveWishes();
        await saveWishlists();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
        tg?.showAlert?.(t('err_save_network'));
        return;
      }
      if (window._wishFromImage) _imageFromPhotoForSave = null;
      render();
      closeWishModal();
      updateClosingConfirmation();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }));

    async function deleteWish(id) {
      tg?.HapticFeedback?.impactOccurred?.('medium');
      wishes = wishes.filter((x) => x.id !== id);
      await saveWishes();
      render();
    }

    document.getElementById('wishCancel').addEventListener('click', closeWishModal);
    document.getElementById('wishModal').addEventListener('click', (e) => {
      if (e.target.id === 'wishModal') closeWishModal();
    });

    function openCatsModal() {
      tg?.HapticFeedback?.impactOccurred?.('light');
      const list = document.getElementById('catList');
      list.innerHTML = categories.length === 0
        ? '<div class="empty-cats">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç. –î–æ–±–∞–≤—å —Å–≤–æ—é.</div>'
        : categories.map((c) => `
            <div class="cat-item" data-cat="${escapeHtml(c)}">
              <span>${escapeHtml(c)}</span>
              <span class="cat-item-remove" data-cat="${escapeHtml(c)}">‚úï</span>
            </div>`).join('');
      list.querySelectorAll('.cat-item-remove').forEach((el) => {
        el.addEventListener('click', async () => {
          categories = categories.filter((x) => x !== el.dataset.cat);
          await saveCategories();
          openCatsModal();
        });
      });
      document.getElementById('newCatName').value = '';
      document.getElementById('catsModal').classList.add('open');
    }

    document.getElementById('catsClose').addEventListener('click', () => document.getElementById('catsModal').classList.remove('open'));
    document.getElementById('catsModal').addEventListener('click', (e) => {
      if (e.target.id === 'catsModal') e.target.classList.remove('open');
    });

    document.getElementById('addCatBtn').addEventListener('click', async () => {
      const v = document.getElementById('newCatName').value.trim();
      if (!v) return;
      const re = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-_]+$/;
      if (!re.test(v)) return;
      if (categories.includes(v)) return;
      categories.push(v);
      await saveCategories();
      document.getElementById('newCatName').value = '';
      openCatsModal();
    });

    document.getElementById('newCatName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('addCatBtn').click();
    });

    function openWlModal() {
      tg?.HapticFeedback?.impactOccurred?.('light');
      document.getElementById('wlAddForm').style.display = 'block';
      document.getElementById('wlEditForm').style.display = 'none';
      editingWlId = null;
      pendingWlImageBase64 = null;
      document.getElementById('wlImgPreview').style.display = 'none';
      document.getElementById('wlImgText').textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
      const list = document.getElementById('wlList');
      list.innerHTML = wishlists.length === 0
        ? '<div class="empty-cats">–í–∏—à–ª–∏—Å—Ç–æ–≤ –Ω–µ—Ç. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π.</div>'
        : wishlists.map((wl) => {
            const pr = wl.privacy === 'private' ? '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π' : (wl.privacy === 'public' ? '–ü—É–±–ª–∏—á–Ω—ã–π' : '–°–æ–≤–º–µ—Å—Ç–Ω—ã–π');
            const isCollab = wl.privacy === 'shared' && canEditWishlist(wl) && !isOwner(wl);
            const isFollowed = !!wl.isFollowedPublic;
            const removeOrLeave = (isCollab || isFollowed)
              ? `<span class="wl-item-leave" data-wl-id="${escapeHtml(wl.id)}" data-followed="${isFollowed}" style="color:var(--accent);cursor:pointer;padding:4px;font-size:0.85rem;">–ü–æ–∫–∏–Ω—É—Ç—å</span>`
              : (isOwner(wl) ? `<span class="wl-item-remove" data-wl-id="${escapeHtml(wl.id)}">‚úï</span>` : '');
            const editBtn = isFollowed ? '' : `<span class="wl-item-edit" data-wl-id="${escapeHtml(wl.id)}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</span>`;
            return `
            <div class="wl-item" data-wl-id="${escapeHtml(wl.id)}">
              ${wl.image ? `<img class="wl-item-img" src="${escapeHtml(wl.image)}" alt="">` : '<div class="wl-item-img" style="background:var(--border);flex-shrink:0;"></div>'}
              <div class="wl-item-body">
                <div>${escapeHtml(wl.name)}</div>
                <span class="privacy-badge" style="font-size:0.7rem;margin-top:4px;display:inline-block;">${escapeHtml(pr)}</span>
              </div>
              ${editBtn}
              ${removeOrLeave}
            </div>`;
          }).join('');
      list.querySelectorAll('.wl-item-edit').forEach((el) => {
        el.addEventListener('click', () => openEditWlForm(el.dataset.wlId));
      });
      list.querySelectorAll('.wl-item-leave').forEach((el) => {
        el.addEventListener('click', async () => {
          const wlId = el.dataset.wlId;
          if (el.dataset.followed === 'true') {
            await leaveFollowedPublicWishlist(wlId);
            if (useSupabase && sb) { const r = await loadWishlistsFromSupabase(); if (r.data) wishlists = r.data; } else wishlists = wishlists.filter((x) => x.id !== wlId);
          } else {
            await leaveWishlist(el.dataset.wlId);
          }
          openWlModal();
        });
      });
      list.querySelectorAll('.wl-item-remove').forEach((el) => {
        el.addEventListener('click', async () => {
          const wlId = el.dataset.wlId;
          wishes.forEach((w) => {
            const ids = Array.isArray(w.wishlistIds) ? w.wishlistIds : [];
            w.wishlistIds = ids.filter((id) => id !== wlId);
          });
          wishlists = wishlists.filter((x) => x.id !== wlId);
          await saveWishlists();
          await saveWishes();
          openWlModal();
        });
      });
      document.getElementById('newWlName').value = '';
      document.getElementById('wlModal').classList.add('open');
    }

    document.getElementById('wlClose').addEventListener('click', () => document.getElementById('wlModal').classList.remove('open'));
    document.getElementById('wlModal').addEventListener('click', (e) => {
      if (e.target.id === 'wlModal') e.target.classList.remove('open');
    });

    document.getElementById('wlImgUpload').addEventListener('click', () => document.getElementById('wlImage').click());
    document.getElementById('wlImage').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f || !f.type.startsWith('image/')) return;
      try {
        let b64 = await fileToBase64(f);
        b64 = await resizeImageBase64(b64, 400);
        pendingWlImageBase64 = b64;
        document.getElementById('wlImgPreview').src = b64;
        document.getElementById('wlImgPreview').style.display = 'block';
        document.getElementById('wlImgText').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É';
      } catch (_) {}
    });

    document.getElementById('addWlBtn').addEventListener('click', async () => {
      const name = document.getElementById('newWlName').value.trim();
      if (!name) return;
      const wl = {
        id: 'wl_' + Date.now(),
        name,
        image: pendingWlImageBase64 || undefined,
        privacy: document.getElementById('newWlPrivacy').value || 'private',
        ownerId: currentUserId,
        coAuthorIds: [currentUserId],
      };
      wishlists.push(wl);
      await saveWishlists();
      pendingWlImageBase64 = null;
      document.getElementById('newWlName').value = '';
      document.getElementById('wlImgPreview').style.display = 'none';
      document.getElementById('wlImgText').textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
      document.getElementById('wlImage').value = '';
      openWlModal();
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    });

    async function openEditWlForm(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl) return;
      editingWlId = wlId;
      pendingEditWlImage = null;
      document.getElementById('wlAddForm').style.display = 'none';
      document.getElementById('wlEditForm').style.display = 'block';
      document.getElementById('editWlName').value = wl.name || '';
      document.getElementById('editWlPrivacy').value = wl.privacy || 'private';
      document.getElementById('wlImgPreviewEdit').style.display = 'none';
      document.getElementById('wlImgTextEdit').textContent = '–û–±–ª–æ–∂–∫–∞';
      if (wl.image) {
        document.getElementById('wlImgPreviewEdit').src = wl.image;
        document.getElementById('wlImgPreviewEdit').style.display = 'block';
        document.getElementById('wlImgTextEdit').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É';
      }
      const extras = document.getElementById('wlEditFormExtras');
      extras.innerHTML = '';
      const isCollab = wl.privacy === 'shared' && canEditWishlist(wl) && !isOwner(wl);
      if (isCollab) {
        extras.innerHTML = '<button type="button" class="btn btn-secondary" id="editWlLeave" style="margin-top:12px;">–ü–æ–∫–∏–Ω—É—Ç—å –≤–∏—à–ª–∏—Å—Ç</button>';
        document.getElementById('editWlLeave').addEventListener('click', async () => { await leaveWishlist(wlId); document.getElementById('wlModal').classList.remove('open'); openWlModal(); });
      } else if (wl.privacy === 'shared' && isOwner(wl)) {
        const coAuths = (wl.coAuthorIds || []).filter((id) => id !== (wl.ownerId || wl.owner_id));
        if (coAuths.length > 0) {
          const names = await Promise.all(coAuths.map(async (uid) => {
            if (useSupabase && sb) {
              const { data } = await sb.from('users').select('first_name, username').eq('id', uid).single();
              return data ? (data.username ? '@' + data.username : data.first_name || uid) : uid;
            }
            return uid;
          }));
          extras.innerHTML = `
            <div class="form-group" style="margin-top:12px;">
              <label>–£–¥–∞–ª–∏—Ç—å —Å–æ–∞–≤—Ç–æ—Ä–∞</label>
              <select id="editWlRemoveCollab" style="width:100%;padding:8px 12px;margin-top:4px;border-radius:8px;background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border);">
                <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                ${coAuths.map((id, i) => `<option value="${escapeHtml(id)}">${escapeHtml(names[i] || id)}</option>`).join('')}
              </select>
              <button type="button" class="btn btn-secondary btn-sm" id="editWlRemoveCollabBtn" style="margin-top:8px;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>`;
          document.getElementById('editWlRemoveCollabBtn').addEventListener('click', async () => {
            const uid = document.getElementById('editWlRemoveCollab').value;
            if (!uid) return;
            await removeCollaborator(wlId, uid);
            openEditWlForm(wlId);
          });
        }
      }
    }

    document.getElementById('editWlCancel').addEventListener('click', () => {
      editingWlId = null;
      document.getElementById('wlAddForm').style.display = 'block';
      document.getElementById('wlEditForm').style.display = 'none';
      openWlModal();
    });

    document.getElementById('editWlSave').addEventListener('click', async () => {
      if (!editingWlId) return;
      const wl = wishlists.find((x) => x.id === editingWlId);
      if (!wl) return;
      const name = document.getElementById('editWlName').value.trim();
      if (!name) return;
      wl.name = name;
      wl.privacy = document.getElementById('editWlPrivacy').value || 'private';
      if (pendingEditWlImage) wl.image = pendingEditWlImage;
      await saveWishlists();
      editingWlId = null;
      document.getElementById('wlAddForm').style.display = 'block';
      document.getElementById('wlEditForm').style.display = 'none';
      openWlModal();
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    });

    document.getElementById('wlImgUploadEdit').addEventListener('click', () => document.getElementById('wlImageEdit').click());
    document.getElementById('wlImageEdit').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f || !f.type.startsWith('image/')) return;
      try {
        let b64 = await fileToBase64(f);
        b64 = await resizeImageBase64(b64, 400);
        pendingEditWlImage = b64;
        document.getElementById('wlImgPreviewEdit').src = b64;
        document.getElementById('wlImgPreviewEdit').style.display = 'block';
        document.getElementById('wlImgTextEdit').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É';
      } catch (_) {}
    });

    async function buildShareUrl(type, wlId, payload) {
      if (TELEGRAM_BOT && TELEGRAM_APP) {
        const param = type === 'share' ? 'w_' + wlId : 'i_' + wlId;
        return 'https://t.me/' + TELEGRAM_BOT + '/' + TELEGRAM_APP + '?startapp=' + param;
      }
      const base = window.location.origin + window.location.pathname;
      if (useSupabase && sb) return base + (type === 'share' ? '#w/' : '#i/') + wlId;
      await ensureLzString();
      return base + '#' + packPayload(payload);
    }

    async function openShareModal(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl || wl.privacy !== 'public') return;
      const ownerName = tg?.initDataUnsafe?.user?.username ? '@' + tg.initDataUnsafe.user.username : (tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      const url = await buildShareUrl('share', wlId, { type: 'public', wishlist: wl, wishes: wishes.filter((w) => (w.wishlistIds || []).includes(wlId)), reservedCards: {}, ownerName });
      if (tg?.openTelegramLink) {
        const text = t('tg_share_msg').replace('{name}', wl.name || 'Wishlist');
        tg.openTelegramLink('https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(text));
      } else {
        document.getElementById('shareWlLink').textContent = url;
        document.getElementById('shareWlHint').style.display = (TELEGRAM_BOT && TELEGRAM_APP) ? 'none' : 'block';
        document.getElementById('shareWlModal').classList.add('open');
      }
    }

    async function openInviteModal(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl || wl.privacy !== 'shared') return;
      const invOwnerName = tg?.initDataUnsafe?.user?.username ? '@' + tg.initDataUnsafe.user.username : (tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      const url = await buildShareUrl('invite', wlId, { type: 'invite', wishlist: { ...wl, coAuthorIds: wl.coAuthorIds || [wl.ownerId] }, wishes: wishes.filter((w) => (w.wishlistIds || []).includes(wlId)), ownerName: invOwnerName });
      if (tg?.openTelegramLink) {
        const text = t('tg_invite_msg').replace('{name}', wl.name || 'Wishlist');
        tg.openTelegramLink('https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(text));
      } else {
        document.getElementById('inviteWlLink').textContent = url;
        document.getElementById('inviteWlHint').style.display = (TELEGRAM_BOT && TELEGRAM_APP) ? 'none' : 'block';
        document.getElementById('inviteWlModal').classList.add('open');
      }
    }

    document.getElementById('shareWlClose').addEventListener('click', () => document.getElementById('shareWlModal').classList.remove('open'));
    document.getElementById('shareWlCopy').addEventListener('click', () => {
      navigator.clipboard?.writeText(document.getElementById('shareWlLink').textContent);
      tg?.HapticFeedback?.notificationOccurred?.('success');
      document.getElementById('shareWlCopy').textContent = t('copied');
      setTimeout(() => { document.getElementById('shareWlCopy').textContent = t('btn_copy'); }, 2000);
    });
    document.getElementById('shareWlModal').addEventListener('click', (e) => { if (e.target.id === 'shareWlModal') e.target.classList.remove('open'); });

    document.getElementById('shareWelcomeOk').addEventListener('click', () => {
      document.getElementById('shareWelcomeModal').classList.remove('open');
    });

    document.getElementById('inviteConsentAccept').addEventListener('click', async () => {
      if (!pendingInviteData) return;
      const next = { ...pendingInviteData };
      pendingInviteData = null;
      document.getElementById('inviteConsentModal').classList.remove('open');
      if (next.fullPayload && !useSupabase) {
        await handleInviteJoin(next.fullPayload);
      } else if (useSupabase && sb) {
        await ensureUser();
        await sb.from('wishlist_collaborators').upsert({ wishlist_id: next.wlId, user_id: currentUserId }, { onConflict: 'wishlist_id,user_id' });
        sessionStorage.setItem('accepted_invite_' + next.wlId, '1');
      }
      window.location.reload();
    });

    document.getElementById('inviteConsentDecline').addEventListener('click', () => {
      if (!pendingInviteData) return;
      const wlId = pendingInviteData.wlId;
      pendingInviteData = null;
      document.getElementById('inviteConsentModal').classList.remove('open');
      sessionStorage.setItem('declined_invite_' + wlId, '1');
      window.location.reload();
    });

    document.getElementById('inviteWlClose').addEventListener('click', () => document.getElementById('inviteWlModal').classList.remove('open'));
    document.getElementById('inviteWlCopy').addEventListener('click', () => {
      navigator.clipboard?.writeText(document.getElementById('inviteWlLink').textContent);
      tg?.HapticFeedback?.notificationOccurred?.('success');
      document.getElementById('inviteWlCopy').textContent = t('copied');
      setTimeout(() => { document.getElementById('inviteWlCopy').textContent = t('btn_copy'); }, 2000);
    });
    document.getElementById('inviteWlModal').addEventListener('click', (e) => { if (e.target.id === 'inviteWlModal') e.target.classList.remove('open'); });

    (function(){var h=document.getElementById('mainHeader');if(h){var t=0,n=0;h.addEventListener('click',function(){var now=Date.now();if(now-t>1200)n=0;t=now;n++;if(n>=5){n=0;if(typeof loadEruda==='function')loadEruda();}});}})();

    // Splash screen: hide after Logo Animation plays (‚âà2.5s) or on load complete
    (function initSplash() {
      const splash = document.getElementById('splashScreen');
      if (!splash) return;
      const hideSplash = () => {
        if (splash._hidden) return;
        splash._hidden = true;
        splash.classList.add('fade-out');
        setTimeout(() => { splash.style.display = 'none'; }, 500);
      };
      // Hide after animation duration or max 3s
      // CSS –∞–Ω–∏–º–∞—Ü–∏—è —Å–ø–ª–µ—à–∞ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 2—Å
      setTimeout(hideSplash, 2000);
    })();

    (async function init() {
      detectLang();
      applyStaticI18n();
      let content;
      try {
        content = document.getElementById('content');
        if (!content) { document.body.insertAdjacentHTML('beforeend', '<div id="content" style="padding:16px;"></div>'); content = document.getElementById('content'); }
        currentView = 'main';
        if (!Array.isArray(wishlists)) wishlists = [];
        if (!Array.isArray(wishes)) wishes = [];
        if (!Array.isArray(categories)) categories = [];
        bindActionButtons();
        document.getElementById('tabHome')?.classList.add('active');
        render();
      } catch (e) {
        console.error('Init/render error:', e);
        const c = document.getElementById('content');
        if (c) c.innerHTML = `<p style="padding:24px;color:var(--accent);">${t('err_save')} ${String(e && e.message || e).slice(0, 100)}</p><button class="btn" onclick="location.reload()">${t('btn_refresh')}</button>`;
        return;
      }
      const fallbackToLocal = function() {
        publicViewData = null;
        currentView = 'main';
        if (useSupabase) {
          wishes = []; wishlists = []; categories = [];
        } else {
          try { wishes = JSON.parse(safeGetItem(WISHES_KEY) || '[]').map(migrateWish); } catch (_) { wishes = []; }
          try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
          try { const r = safeGetItem(CATS_KEY); categories = r ? JSON.parse(r) : []; } catch (_) { categories = []; }
        }
        if (!Array.isArray(wishlists)) wishlists = [];
        if (!Array.isArray(wishes)) wishes = [];
        if (!Array.isArray(categories)) categories = [];
      };
      try {
        const loadPromise = loadAll();
        const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 5000));
        await Promise.race([loadPromise, timeout]);
      } catch (e) {
        console.error('Load error:', e);
        fallbackToLocal();
      }
      isLoading = false;
      currentView = 'main';
      if (window._supabaseLoadError) {
        const raw = String(window._supabaseLoadError);
        const msg = raw.length > 200 ? raw.slice(0, 200) + '‚Ä¶' : raw;
        const safe = msg.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
        content.innerHTML = `<p style="text-align:center;padding:24px;color:var(--accent);">${t('err_supabase')} ${safe}</p><p style="text-align:center;font-size:0.85rem;color:var(--text-secondary);">–ü—Ä–æ–≤–µ—Ä—å RLS: –≤—ã–ø–æ–ª–Ω–∏ supabase-disable-rls.sql –≤ SQL Editor.</p><button class="btn" style="margin:16px auto;display:block;" onclick="location.reload()">${t('btn_refresh')}</button>`;
        return;
      }
      try {
        render();
      } catch (e) {
        console.error('Render error:', e);
        fallbackToLocal();
        try { render(); } catch (_) {
          content.innerHTML = `<p style="text-align:center;padding:24px;color:var(--text-secondary);">${t('err_load')}</p><button class="btn" style="margin:0 auto;display:block;" onclick="location.reload()">${t('btn_refresh')}</button>`;
        }
      }
    })();
  </script>
</body>
</html>
