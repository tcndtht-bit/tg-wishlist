<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–í–∏—à–ª–∏—Å—Ç</title>
  <link rel="icon" href="data:,">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    function loadEruda(){try{localStorage.setItem('eruda','1');var e=document.createElement('script');e.src='https://cdn.jsdelivr.net/npm/eruda';e.onload=function(){eruda.init();};document.head.appendChild(e);}catch(x){}}
    if(/eruda=true/.test(location.href)||/#eruda/.test(location.hash)||localStorage.getItem('eruda'))loadEruda();
  </script>
  <style>
    /* --- Design: I Want That So Bad ‚Äî Gen-Z, Y2K, SLAY --- */
    :root {
      /* Light theme: lime, lavender, pink, neon */
      --bg-primary: #fef9fc;
      --bg-secondary: #fff;
      --bg-card: rgba(255,255,255,0.85);
      --accent: #ff4d8d;
      --accent-lime: #c8ff00;
      --accent-lavender: #b8a9ff;
      --accent-pink: #ff9ed2;
      --accent-neon: #ff2d92;
      --text-primary: #1d1d24;
      --text-secondary: #5c5c6d;
      --border: rgba(184,169,255,0.3);
      --shadow: 0 4px 24px rgba(255,77,141,0.15);
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 20px;
      --radius-blob: 60% 40% 30% 70% / 55% 45% 55% 45%;
      --font-display: 'Segoe UI', system-ui, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-display);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      position: relative;
      overflow-x: hidden;
    }
    /* Dynamic background ‚Äî gradient blobs */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: -2;
      background: linear-gradient(135deg, rgba(200,255,0,0.08) 0%, rgba(184,169,255,0.12) 40%, rgba(255,158,210,0.1) 70%, rgba(255,77,141,0.06) 100%);
      pointer-events: none;
    }
    body::after {
      content: '';
      position: fixed; top: -20%; right: -10%; width: 50%; height: 60%;
      border-radius: var(--radius-blob); background: radial-gradient(circle, rgba(184,169,255,0.25) 0%, transparent 70%);
      pointer-events: none; z-index: -1;
    }
    body.light {
      --bg-primary: #fef9fc;
      --bg-secondary: #fff;
      --bg-card: rgba(255,255,255,0.9);
      --accent: #ff4d8d;
      --accent-neon: #ff2d92;
      --text-primary: #1d1d24;
      --text-secondary: #5c5c6d;
      --border: rgba(184,169,255,0.35);
      --shadow: 0 4px 24px rgba(255,77,141,0.12);
    }
    body:not(.light) {
      --bg-primary: #1a1624;
      --bg-secondary: #252033;
      --bg-card: rgba(37,32,51,0.85);
      --accent: #ff7bab;
      --accent-lime: #b8e64d;
      --accent-lavender: #9b8bcc;
      --accent-pink: #e88bb8;
      --accent-neon: #ff5a9d;
      --text-primary: #f0edf5;
      --text-secondary: #a09bb5;
      --border: rgba(184,169,255,0.2);
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
    }
    .app-shell { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding-bottom: 72px; }
    .container { max-width: 480px; margin: 0 auto; padding: 16px; flex: 1; }
    #content { animation: contentIn 0.3s ease-out; }
    @keyframes contentIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    header.app-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 16px 16px 12px;
      border: none;
      background: linear-gradient(180deg, rgba(255,255,255,0.6) 0%, transparent 100%);
      backdrop-filter: blur(8px);
    }
    body:not(.light) header.app-header { background: linear-gradient(180deg, rgba(37,32,51,0.7) 0%, transparent 100%); }
    h1.app-title { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.02em; color: var(--text-primary); }
    .app-slogan { font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; opacity: 0.9; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 12px 0 20px; border-bottom: 1px solid var(--border); }
    h1 { font-size: 1.5rem; font-weight: 700; }
    /* Tab bar */
    .tab-bar {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 480px;
      display: flex; justify-content: space-around; align-items: center;
      padding: 10px 8px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.9); backdrop-filter: blur(12px);
      border-top: 1px solid var(--border); z-index: 100;
      box-shadow: 0 -4px 20px rgba(255,77,141,0.08);
    }
    body:not(.light) .tab-bar { background: rgba(37,32,51,0.95); }
    .tab-item {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      padding: 6px 12px; border-radius: var(--radius-sm);
      color: var(--text-secondary); font-size: 0.7rem; font-weight: 600;
      text-decoration: none; cursor: pointer; transition: all 0.2s;
      border: none; background: none;
    }
    .tab-item:active { transform: scale(0.95); }
    .tab-item.active { color: var(--accent-neon); }
    .tab-item svg { width: 24px; height: 24px; opacity: 0.9; }
    .tab-item.active svg { filter: drop-shadow(0 0 6px rgba(255,45,146,0.5)); }

    .btn {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-neon) 100%);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(255,77,141,0.35);
    }
    .btn:hover { box-shadow: 0 6px 16px rgba(255,77,141,0.4); }
    .btn:active { transform: scale(0.97); }
    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .btn-sm { font-size: 0.8rem; padding: 6px 12px; }
    .btn-icon {
      width: 40px; height: 40px; padding: 0;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .edit-cats-btn, .edit-wl-btn {
      font-size: 0.8rem;
      padding: 6px 10px;
      color: var(--text-secondary);
      background: transparent;
      border: 1px dashed var(--border);
    }
    .wl-section {
      margin-bottom: 24px;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      background: var(--bg-card);
    }
    .wl-section-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      min-height: 52px;
    }
    .wl-section-img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 8px;
      background: var(--bg-secondary);
    }
    .wl-section-title { font-weight: 600; font-size: 1rem; }
    .wl-section-body { padding: 12px 16px; }
    .categories-section { margin: 20px 0; }
    .category-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .category-title .count { font-weight: 600; color: var(--text-primary); }
    .wishlist { margin-top: 12px; }
    /* Masonry / tile grid –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .wish-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
      padding: 0 0 24px;
    }
    .wish-grid .card { margin-bottom: 0; }
    .wish-grid .card:nth-child(3n+1) { grid-column: span 1; }
    .wish-grid .card.tile-wide { grid-column: span 2; }
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius-md);
      padding: 0;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:active { transform: scale(0.98); }
    .card-img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background: linear-gradient(135deg, var(--accent-lavender) 0%, var(--accent-pink) 100%);
    }
    .card .card-body { padding: 10px 12px; }
    .card .card-title, .card .card-price, .card .card-meta, .card .card-link, .card .card-comment, .card .card-actions { padding: 0 12px; }
    .card .card-title { padding-top: 10px; }
    .card-title { font-size: 1rem; font-weight: 600; margin-bottom: 6px; word-break: break-word; }
    .card-meta { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; }
    .card-price { font-size: 1.2rem; font-weight: 700; color: var(--accent); margin-bottom: 6px; }
    .card-link {
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-decoration: none;
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .card-comment { font-size: 0.9rem; margin-top: 8px; opacity: 0.9; }
    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .card-move-wrap { position: relative; }
    .card-move-btn { padding: 6px 10px; font-size: 0.8rem; }
    .card-move-menu {
      position: absolute;
      bottom: 100%;
      left: 0;
      margin-bottom: 4px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px 0;
      min-width: 160px;
      z-index: 10;
      box-shadow: var(--shadow);
    }
    .card-move-menu button {
      display: block;
      width: 100%;
      padding: 8px 12px;
      text-align: left;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
    }
    .card-move-menu button:hover { background: var(--bg-card); }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    .empty-state p { margin-bottom: 16px; }
    .empty-cats { font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px; }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: 0.3s;
    }
    .modal-overlay.open { opacity: 1; visibility: visible; }
    .modal {
      background: var(--bg-secondary);
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
      transform: translateY(100%);
      transition: transform 0.3s;
    }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal h2 { margin-bottom: 20px; font-size: 1.25rem; }
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .form-group label .required { color: var(--accent); }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 1rem;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: flex; gap: 12px; }
    .form-actions-split { display: flex; gap: 12px; margin-top: 24px; }
    .form-actions-split .btn { flex: 1; }
    .form-row .form-group { flex: 1; }
    .form-row .form-group:last-child { flex: 0 0 100px; }
    .img-upload {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .img-upload:hover, .img-upload.dragover { border-color: var(--accent); }
    .img-upload input { display: none; }
    .img-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 12px;
      margin-top: 12px;
    }
    .form-actions { display: flex; gap: 12px; margin-top: 24px; }
    .form-actions .btn { flex: 1; }
    .error-msg { font-size: 0.8rem; color: var(--accent); margin-top: 4px; }
    .cat-list { margin-top: 12px; }
    .cat-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
    }
    .cat-item-remove { color: var(--accent); cursor: pointer; padding: 4px; }
    .cat-add { display: flex; gap: 8px; margin-top: 12px; }
    .cat-add input { flex: 1; }
    /* Tag cloud */
    .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; padding: 16px 0; justify-content: center; }
    .tag-chip {
      padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
      background: linear-gradient(135deg, rgba(184,169,255,0.3) 0%, rgba(255,158,210,0.3) 100%);
      border: 1px solid var(--border); color: var(--text-primary); cursor: pointer;
      transition: transform 0.2s; user-select: none;
    }
    .tag-chip:hover, .tag-chip.selected { transform: scale(1.08); }
    .tag-chip.selected { background: linear-gradient(135deg, var(--accent-lavender) 0%, var(--accent-pink) 100%); color: #fff; }
    .trash-zone {
      margin-top: 24px; padding: 20px; border: 2px dashed var(--border);
      border-radius: var(--radius-md); text-align: center; color: var(--text-secondary);
      min-height: 60px; transition: all 0.2s;
    }
    .trash-zone.drag-over { border-color: var(--accent); background: rgba(255,77,141,0.1); }
    .tag-form-row { display: flex; }

    .wl-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--bg-card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius-md);
      margin-bottom: 10px;
      border: 1px solid var(--border);
    }
    .wl-item-img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 8px;
      background: var(--bg-secondary);
    }
    .wl-item-body { flex: 1; }
    .wl-item-remove { color: var(--accent); cursor: pointer; padding: 4px; }
    .wl-item-edit { color: var(--text-secondary); cursor: pointer; padding: 4px; font-size: 0.9rem; }
    .wl-add-img { min-height: 80px; overflow: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .wl-add-img .img-preview { max-width: 100%; max-height: 120px; object-fit: contain; margin-top: 0; }
    .wl-header-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }
    .privacy-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 6px; background: var(--border); color: var(--text-secondary); }
    .card-reserved { opacity: 0.85; border-left: 3px solid var(--accent); }
    .card-reserved-badge { font-size: 0.8rem; color: var(--accent); margin-top: 6px; }
    .view-readonly .btn-edit, .view-readonly .btn-del, .view-readonly .btn-move { display: none !important; }
    /* Action buttons ‚Äî —Å–ø—Ä–∞–≤–∞ */
    .action-buttons {
      position: fixed; top: 100px; right: 12px; z-index: 50;
      display: flex; flex-direction: column; gap: 10px;
    }
    .action-btn {
      width: 48px; height: 48px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-lavender) 0%, var(--accent-pink) 100%);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
      box-shadow: 0 4px 14px rgba(184,169,255,0.5);
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s; animation: float 3s ease-in-out infinite;
    }
    .action-btn:nth-child(2) { animation-delay: 0.5s; background: linear-gradient(135deg, var(--accent-lime) 0%, #a8e063 100%); }
    .action-btn:active { transform: scale(0.9); }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }

    /* Feed ‚Äî TikTok-style */
    .feed-container {
      padding: 12px 0 24px; max-height: 50vh; overflow-y: auto;
    }
    .feed-item {
      padding: 14px 16px; margin-bottom: 10px;
      background: var(--bg-card); backdrop-filter: blur(8px);
      border-radius: var(--radius-md); border: 1px solid var(--border);
      font-size: 0.9rem; line-height: 1.4; color: var(--text-primary);
      animation: feedIn 0.4s ease-out;
    }
    @keyframes feedIn { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }

    .main-buttons { display: flex; flex-direction: column; gap: 12px; margin-bottom: 32px; }
    .main-buttons .btn { width: 100%; justify-content: center; }
    .section-title { font-size: 1rem; color: var(--text-secondary); margin-bottom: 12px; }
    .recent-list { display: flex; flex-direction: column; gap: 8px; }
    .recent-item {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 16px; background: var(--bg-card); border-radius: 12px;
      border: 1px solid var(--border); cursor: pointer; transition: transform 0.1s;
    }
    .recent-item:active { transform: scale(0.98); }
    .recent-item img { width: 44px; height: 44px; object-fit: cover; border-radius: 8px; }
    .back-btn { background: transparent; color: var(--text-secondary); padding: 8px 0; margin-bottom: 16px; }
    .multiselect-wrap { position: relative; }
    .multiselect-trigger {
      display: flex; align-items: center; flex-wrap: wrap; gap: 6px; min-height: 44px;
      padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border);
      border-radius: 8px; cursor: pointer; font-size: 0.9rem;
    }
    .multiselect-trigger:focus { outline: none; border-color: var(--accent); }
    .multiselect-trigger.open { border-color: var(--accent); }
    .multiselect-placeholder { color: var(--text-secondary); }
    .multiselect-chip { background: var(--bg-card); padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; }
    .multiselect-panel {
      display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px;
      max-height: 200px; overflow-y: auto; background: var(--bg-card);
      border: 1px solid var(--border); border-radius: 8px; z-index: 100;
    }
    .multiselect-wrap.open .multiselect-panel { display: block; }
    .multiselect-option {
      padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border);
    }
    .multiselect-option:last-child { border-bottom: none; }
    .multiselect-option:hover, .multiselect-option.selected { background: rgba(233,69,96,0.2); }
    .skeleton { background: linear-gradient(90deg, var(--bg-card) 25%, var(--border) 50%, var(--bg-card) 75%); background-size: 200% 100%; animation: skeleton 1.2s ease-in-out infinite; border-radius: 12px; }
    .skeleton-text { height: 16px; margin-bottom: 8px; }
    .skeleton-btn { height: 44px; }
    .skeleton-recent { height: 44px; margin-bottom: 8px; }
    @keyframes skeleton { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .card { content-visibility: auto; contain-intrinsic-size: auto 280px; }
    .wl-item { content-visibility: auto; contain-intrinsic-size: auto 72px; }
    .analysis-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
      display: none; align-items: center; justify-content: center; flex-direction: column; gap: 16px;
    }
    .analysis-overlay.visible { display: flex; }
    .analysis-spinner {
      width: 48px; height: 48px; border: 3px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .analysis-overlay span { color: var(--text-primary); font-size: 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (min-width: 480px) {
      .modal { border-radius: 24px; margin: auto 16px 16px; }
    }
  </style>
</head>
<body>
  <!-- v:2025-02-15-4 design -->
  <div class="app-shell">
    <header class="app-header" id="mainHeader">
      <h1 class="app-title">I Want That So Bad</h1>
      <span class="app-slogan" id="headerSlogan">–ñ–µ–ª–∞–π, –∫–∞–∫ –Ω–∏–∫–æ–≥–¥–∞ –ø—Ä–µ–∂–¥–µ</span>
    </header>

    <div class="action-buttons" id="actionButtons">
      <button type="button" class="action-btn" id="addByPhotoBtn" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ —Ñ–æ—Ç–æ">üì∏</button>
      <button type="button" class="action-btn" id="addByLinkBtn" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ">üîó</button>
    </div>
    <input type="file" id="addByPhotoInput" accept="image/*" capture="environment" style="display:none">

    <div class="container">
    <div id="content">
      <div class="main-buttons">
        <button class="btn" data-nav="manageWishlists" onclick="window.__nav&&window.__nav('manageWishlists')">–í–∏—à–ª–∏—Å—Ç—ã</button>
        <button class="btn btn-secondary" data-nav="manageCategories" onclick="window.__nav&&window.__nav('manageCategories')">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
        <button class="btn btn-secondary" data-nav="manageWishes" onclick="window.__nav&&window.__nav('manageWishes')">–ñ–µ–ª–∞–Ω–∏—è</button>
      </div>
      <h3 class="section-title">–ù–µ–¥–∞–≤–Ω–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ</h3>
      <div class="recent-list"><p style="color:var(--text-secondary);font-size:0.9rem;">–ù–µ—Ç –≤–∏—à–ª–∏—Å—Ç–æ–≤</p></div>
    </div>
    </div>
  </div>

  <nav class="tab-bar" id="tabBar">
    <button type="button" class="tab-item" data-nav="main" id="tabHome" aria-label="–î–æ–º–æ–π">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      –î–æ–º–æ–π
    </button>
    <button type="button" class="tab-item" data-nav="manageWishlists" id="tabWishlists" aria-label="–í–∏—à–ª–∏—Å—Ç—ã">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
      –í–∏—à–ª–∏—Å—Ç—ã
    </button>
    <button type="button" class="tab-item" data-nav="manageCategories" id="tabTags" aria-label="–¢–µ–≥–∏">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/></svg>
      –¢–µ–≥–∏
    </button>
    <button type="button" class="tab-item" data-nav="manageWishes" id="tabWishes" aria-label="–ñ–µ–ª–∞–Ω–∏—è">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
      –ñ–µ–ª–∞–Ω–∏—è
    </button>
  </nav>

  <div class="analysis-overlay" id="analysisOverlay">
    <div class="analysis-spinner"></div>
    <span id="analysisOverlayText">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ‚Ä¶</span>
  </div>

  <!-- Wish modal -->
  <div class="modal-overlay" id="wishModal">
    <div class="modal">
      <h2 id="wishModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∂–µ–ª–∞–Ω–∏–µ</h2>
      <form id="wishForm">
        <input type="hidden" id="wishId">
        <div class="form-group">
          <label><span class="required">*</span> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
          <div class="img-upload" id="imgUpload">
            <input type="file" id="wishImage" accept="image/*" capture="environment">
            <span id="imgUploadText">–ù–∞–∂–º–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ —Ñ–æ—Ç–æ</span>
            <img id="imgPreview" class="img-preview" style="display:none;" alt="">
          </div>
          <div id="imgError" class="error-msg" style="display:none;"></div>
        </div>
        <div class="form-group">
          <label><span class="required">*</span> –ù–∞–∑–≤–∞–Ω–∏–µ <span id="nameCounter">0/100</span></label>
          <input type="text" id="wishName" maxlength="100" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∂–µ–ª–∞–Ω–∏—è">
          <div id="nameError" class="error-msg" style="display:none;"></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>–°—Ç–æ–∏–º–æ—Å—Ç—å</label>
            <input type="number" id="wishPrice" min="0" max="9999999" step="0.01" placeholder="0">
            <div id="priceError" class="error-msg" style="display:none;"></div>
          </div>
          <div class="form-group">
            <label>–í–∞–ª—é—Ç–∞</label>
            <select id="wishCurrency">
              <option value="">‚Äî</option>
              <option value="‚Ç¨">‚Ç¨</option>
              <option value="$">$</option>
              <option value="Br">Br</option>
              <option value="‚ÇΩ">‚ÇΩ</option>
              <option value="‚Ç∏">‚Ç∏</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>–†–∞–∑–º–µ—Ä</label>
          <input type="text" id="wishSize" placeholder="M, 42, XL">
          <div id="sizeError" class="error-msg" style="display:none;"></div>
        </div>
        <div class="form-group">
          <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç</label>
          <input type="url" id="wishLink" placeholder="https://...">
          <div id="linkError" class="error-msg" style="display:none;"></div>
        </div>
        <div class="form-group">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π <span id="commentCounter">0/500</span></label>
          <textarea id="wishComment" maxlength="500" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏"></textarea>
        </div>
        <div class="form-group">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="wishCategory">
            <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          </select>
        </div>
        <div class="form-group">
          <label>–í–∏—à–ª–∏—Å—Ç—ã</label>
          <div class="multiselect-wrap" id="wishWishlistSelect"></div>
          <small style="color:var(--text-secondary);font-size:0.8rem;">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏—à–ª–∏—Å—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞</small>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="wishCancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Categories modal -->
  <div class="modal-overlay" id="catsModal">
    <div class="modal">
      <h2>–ü—Ä–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
      <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
        –£–¥–∞–ª—è–π –Ω–µ–Ω—É–∂–Ω—ã–µ –∏ –¥–æ–±–∞–≤–ª—è–π —Å–≤–æ–∏. –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.
      </p>
      <div class="cat-list" id="catList"></div>
      <div class="cat-add">
        <input type="text" id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
        <button type="button" class="btn" id="addCatBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="form-actions" style="margin-top:20px;">
        <button type="button" class="btn btn-secondary" id="catsClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Wishlists modal -->
  <div class="modal-overlay" id="wlModal">
    <div class="modal">
      <h2>–ü—Ä–∞–≤–∏—Ç—å –≤–∏—à–ª–∏—Å—Ç—ã</h2>
      <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
        –í–∏—à–ª–∏—Å—Ç ‚Äî –ø–∞–ø–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∂–µ–ª–∞–Ω–∏–π. –î–æ–±–∞–≤–ª—è–π, —É–¥–∞–ª—è–π, –ø–µ—Ä–µ–Ω–æ—Å–∏ –∫–∞—Ä—Ç–æ—á–∫–∏.
      </p>
      <div class="cat-list" id="wlList"></div>
      <div style="margin-top:16px;" id="wlAddForm">
        <div class="form-group">
          <label><span class="required">*</span> –ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" id="newWlName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏—à–ª–∏—Å—Ç–∞">
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
          <select id="newWlPrivacy">
            <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π ‚Äî —Ç–æ–ª—å–∫–æ –≤—ã</option>
            <option value="public">–ü—É–±–ª–∏—á–Ω—ã–π ‚Äî –ª—é–±–æ–π –ø–æ —Å—Å—ã–ª–∫–µ –º–æ–∂–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</option>
            <option value="shared">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π ‚Äî —Å–æ–∞–≤—Ç–æ—Ä—ã –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
          <div class="img-upload wl-add-img" id="wlImgUpload">
            <input type="file" id="wlImage" accept="image/*">
            <span id="wlImgText">–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
            <img id="wlImgPreview" class="img-preview" style="display:none;max-height:120px;" alt="">
          </div>
        </div>
        <button type="button" class="btn" id="addWlBtn">–î–æ–±–∞–≤–∏—Ç—å –≤–∏—à–ª–∏—Å—Ç</button>
      </div>
      <div id="wlEditForm" style="display:none;">
        <div class="form-group">
          <label><span class="required">*</span> –ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" id="editWlName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏—à–ª–∏—Å—Ç–∞">
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
          <select id="editWlPrivacy">
            <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
            <option value="public">–ü—É–±–ª–∏—á–Ω—ã–π</option>
            <option value="shared">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
          <div class="img-upload wl-add-img" id="wlImgUploadEdit">
            <input type="file" id="wlImageEdit" accept="image/*">
            <span id="wlImgTextEdit">–û–±–ª–æ–∂–∫–∞</span>
            <img id="wlImgPreviewEdit" class="img-preview" style="display:none;max-height:120px;" alt="">
          </div>
        </div>
        <div id="wlEditFormExtras"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="editWlCancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn" id="editWlSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div class="form-actions" style="margin-top:20px;">
        <button type="button" class="btn btn-secondary" id="wlClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="shareWlModal">
    <div class="modal">
      <h2>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤–∏—à–ª–∏—Å—Ç–æ–º</h2>
      <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:12px;">–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –≤ Telegram ‚Äî –æ–Ω–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±–æ—Ç–µ. –ö—Ç–æ —É–≥–æ–¥–Ω–æ –ø–æ —Å—Å—ã–ª–∫–µ —É–≤–∏–¥–∏—Ç –≤–∏—à–ª–∏—Å—Ç –∏ —Å–º–æ–∂–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏.</p>
      <div class="share-link" id="shareWlLink" style="word-break:break-all;padding:12px;background:var(--bg-card);border-radius:8px;font-size:0.85rem;"></div>
      <p id="shareWlHint" style="display:none;color:var(--accent);font-size:0.8rem;margin-top:8px;">–ß—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞—Å—å –≤ –±–æ—Ç–µ, —É–∫–∞–∂–∏ <code>wantthat_bot</code> –∏ <code>wantthat</code> –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞.</p>
      <div class="form-actions" style="margin-top:16px;">
        <button type="button" class="btn btn-secondary" id="shareWlClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button type="button" class="btn" id="shareWlCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="shareWelcomeModal">
    <div class="modal">
      <h2>–ü–æ–¥–µ–ª–∏–ª–∏—Å—å —Å –≤–∞–º–∏</h2>
      <p id="shareWelcomeText" style="color:var(--text-secondary);font-size:0.95rem;margin-bottom:20px;"></p>
      <button type="button" class="btn" id="shareWelcomeOk">–ü–æ–Ω—è–ª</button>
    </div>
  </div>

  <div class="modal-overlay" id="inviteConsentModal">
    <div class="modal">
      <h2>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</h2>
      <p id="inviteConsentText" style="color:var(--text-secondary);font-size:0.95rem;margin-bottom:20px;"></p>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="inviteConsentDecline">–û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
        <button type="button" class="btn" id="inviteConsentAccept">–ü—Ä–∏–Ω—è—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="inviteWlModal">
    <div class="modal">
      <h2>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–æ–∞–≤—Ç–æ—Ä–∞</h2>
      <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:12px;">–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –≤ Telegram ‚Äî –æ–Ω–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±–æ—Ç–µ, —á–µ–ª–æ–≤–µ–∫ —Å—Ç–∞–Ω–µ—Ç —Å–æ–∞–≤—Ç–æ—Ä–æ–º –∏ —Å–º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏—à–ª–∏—Å—Ç.</p>
      <div class="share-link" id="inviteWlLink" style="word-break:break-all;padding:12px;background:var(--bg-card);border-radius:8px;font-size:0.85rem;"></div>
      <p id="inviteWlHint" style="display:none;color:var(--accent);font-size:0.8rem;margin-top:8px;">–ß—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞—Å—å –≤ –±–æ—Ç–µ, —É–∫–∞–∂–∏ <code>TELEGRAM_BOT</code> –∏ <code>TELEGRAM_APP</code> –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞.</p>
      <div class="form-actions" style="margin-top:16px;">
        <button type="button" class="btn btn-secondary" id="inviteWlClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button type="button" class="btn" id="inviteWlCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // --- Supabase: –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –∏–∑ GitHub Secrets (SUPABASE_URL, SUPABASE_ANON_KEY) ---
    const SUPABASE_URL = '__SUPABASE_URL__';
    const SUPABASE_ANON_KEY = '__SUPABASE_ANON_KEY__';
    let sb = null;
    // --- API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å –≥–ª–∞–≤–Ω–æ–π (–ø–æ —Ñ–æ—Ç–æ / –ø–æ —Å—Å—ã–ª–∫–µ): –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –∏–∑ GitHub Secret LINK_SCRAPER_URL ---
    const _apiFromDeploy = ('__LINK_SCRAPER_URL__'.indexOf('__') === 0 ? '' : '__LINK_SCRAPER_URL__'.replace(/\/$/, ''));
    const _apiFromQuery = (() => { const p = new URLSearchParams(location.search); const u = p.get('api'); return (u && u.startsWith('http')) ? u.replace(/\/$/, '') : ''; })();
    const _raw = _apiFromDeploy || _apiFromQuery;
    const API_BASE_URL = _raw ? (_raw.startsWith('http://') ? 'https' + _raw.slice(4) : _raw) : '';
    function ensureHttps(u) { return (u && u.startsWith('http://')) ? 'https' + u.slice(4) : u; }
    const useSupabase = !!(SUPABASE_URL && SUPABASE_ANON_KEY);
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        if (document.querySelector('script[src="' + src + '"]')) { resolve(); return; }
        const s = document.createElement('script'); s.src = src;
        s.onload = () => resolve(); s.onerror = reject;
        document.head.appendChild(s);
      });
    }
    const WISH_IMAGES_BUCKET = 'wish-images';
    async function uploadImageToSupabaseStorage(dataUrl) {
      if (!sb || !dataUrl || typeof dataUrl !== 'string' || !dataUrl.startsWith('data:image/')) return null;
      try {
        const m = dataUrl.match(/^data:(image\/\w+);base64,(.+)$/);
        if (!m) return null;
        const type = m[1];
        const base64 = m[2];
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        const blob = new Blob([bytes], { type: type });
        const ext = type === 'image/png' ? 'png' : 'jpg';
        const path = `${(currentUserId || 'user').replace(/\s/g, '_')}_${Date.now()}_${Math.random().toString(36).slice(2, 10)}.${ext}`;
        const { error } = await sb.storage.from(WISH_IMAGES_BUCKET).upload(path, blob, { contentType: type, upsert: false });
        if (error) return null;
        const { data: urlData } = sb.storage.from(WISH_IMAGES_BUCKET).getPublicUrl(path);
        return urlData?.publicUrl || null;
      } catch (e) {
        return null;
      }
    }

    async function loadSupabase() {
      if (sb) return;
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;
      await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });
    }
    let _lzReady = null;
    async function ensureLzString() {
      if (typeof LZString !== 'undefined') return;
      if (_lzReady) return _lzReady;
      _lzReady = loadScript('https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js');
      await _lzReady;
    }

    // --- Telegram Bot: –¥–ª—è —Å—Å—ã–ª–æ–∫ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª / ¬´–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å¬ª ‚Äî —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã–≤–∞–ª–∏—Å—å –≤ –±–æ—Ç–µ ---
    // –£–∫–∞–∂–∏ username –±–æ—Ç–∞ (–±–µ–∑ @) –∏ short_name Mini App –∏–∑ BotFather
    const TELEGRAM_BOT = 'wantthat_bot';
    const TELEGRAM_APP = 'wantthat';

    const tg = window.Telegram?.WebApp;
    const _savedStartParam = (() => {
      const h = window.location.hash.slice(1);
      if (h) { try { const p = new URLSearchParams(h); const sp = p.get('tgWebAppStartParam'); if (sp) return sp; } catch (_) {} }
      return tg?.initDataUnsafe?.start_param || '';
    })();
    const WISHES_KEY = 'wishlist_wishes';
    const CATS_KEY = 'wishlist_categories';
    const WISHLISTS_KEY = 'wishlist_folders';
    const DEFAULT_CATS = [];
    const PLACEHOLDER_IMAGE = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300"><rect fill="#c8c8c8" width="400" height="300"/><text x="200" y="155" fill="white" font-family="sans-serif" font-size="28" font-weight="bold" text-anchor="middle">PLACEHOLDER</text><line x1="0" y1="0" x2="400" y2="300" stroke="white" stroke-width="8"/><line x1="400" y1="0" x2="0" y2="300" stroke="white" stroke-width="8"/></svg>');
    const PRIVACY_VALUES = ['private', 'public', 'shared'];
    const NAME_RE = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-_.,!?()'"&/\x7C\u00A6\u2016\u2223\u2758\u2026]*$/;
    const SIZE_RE = /^[a-zA-Z0-9\s\-.]*$/;
    const URL_RE = /^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w\-./?%&=]*)?$/i;

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function hasUnsavedData() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –º–æ–¥–∞–ª–∫–∞ —Ñ–æ—Ä–º—ã –∂–µ–ª–∞–Ω–∏—è
      const wishModal = document.getElementById('wishModal');
      if (wishModal && wishModal.classList.contains('open')) {
        const form = document.getElementById('wishForm');
        const name = document.getElementById('wishName')?.value?.trim();
        const comment = document.getElementById('wishComment')?.value?.trim();
        const link = document.getElementById('wishLink')?.value?.trim();
        const price = document.getElementById('wishPrice')?.value?.trim();
        const size = document.getElementById('wishSize')?.value?.trim();
        const wishlistId = document.getElementById('wishWishlist')?.value;
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if (name || comment || link || price || size || wishlistId || pendingImageBase64) {
          return true;
        }
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥–∞–ª–∫–∏ —Å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      // (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º)
      
      return false;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
    function updateClosingConfirmation() {
      if (tg && typeof tg.enableClosingConfirmation === 'function' && typeof tg.disableClosingConfirmation === 'function') {
        if (hasUnsavedData()) {
          tg.enableClosingConfirmation();
        } else {
          tg.disableClosingConfirmation();
        }
      }
    }

    try {
      if (tg) {
        tg.ready();
        tg.expand();
        // –ù–µ –≤–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å—Ä–∞–∑—É - –±—É–¥–µ–º –≤–∫–ª—é—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        updateClosingConfirmation();
        document.body.style.background = tg.themeParams?.bg_color || 'var(--bg-primary)';
        if (tg.themeParams?.text_color) document.body.style.color = tg.themeParams.text_color;
        if (tg.themeParams?.secondary_bg_color) document.documentElement.style.setProperty('--bg-secondary', tg.themeParams.secondary_bg_color);
        document.body.classList.toggle('light', tg.colorScheme === 'light');
        tg.setHeaderColor(tg.themeParams?.bg_color || '#1a1a2e');
      }
    } catch (_) {}

    const CLIENT_ID_KEY = 'wishlist_client_id';
    function packPayload(obj) {
      const s = JSON.stringify(obj);
      if (typeof LZString !== 'undefined') return LZString.compressToEncodedURIComponent(s);
      return btoa(unescape(encodeURIComponent(s)));
    }
    function unpackPayload(str) {
      if (!str) return null;
      try {
        if (typeof LZString !== 'undefined') {
          const d = LZString.decompressFromEncodedURIComponent(str);
          if (d) return JSON.parse(d);
        }
        return JSON.parse(decodeURIComponent(escape(atob(str))));
      } catch (_) { return null; }
    }
    function unpackStartParam(b64) {
      if (!b64) return null;
      try {
        return JSON.parse(atob(b64));
      } catch (_) { return null; }
    }
    let _memStorage = {};
    let _anonClientId = null;
    function safeGetItem(key) {
      if (useSupabase && key !== CLIENT_ID_KEY) return null;
      try { return localStorage.getItem(key); } catch (_) { return _memStorage[key] ?? null; }
    }
    function safeSetItem(key, val) {
      if (useSupabase && key !== CLIENT_ID_KEY) return;
      try { localStorage.setItem(key, val); } catch (_) { _memStorage[key] = val; }
    }
    function getCurrentUserId() {
      const u = tg?.initDataUnsafe?.user;
      if (u?.id) return 'tg_' + u.id;
      if (useSupabase) {
        if (!_anonClientId) _anonClientId = 'anon_' + Date.now() + '_' + Math.random().toString(36).slice(2);
        return _anonClientId;
      }
      let cid = safeGetItem(CLIENT_ID_KEY);
      if (!cid) { cid = 'anon_' + Date.now() + '_' + Math.random().toString(36).slice(2); safeSetItem(CLIENT_ID_KEY, cid); }
      return cid;
    }
    let currentUserId;
    try { currentUserId = getCurrentUserId(); } catch (_) { currentUserId = 'anon_' + Date.now(); }

    let wishes = [];
    let categories = [];
    let wishlists = [];
    let pendingImageBase64 = null;
    let pendingWlImageBase64 = null;
    let _imageFromPhotoForSave = null;
    let publicViewData = null;
    let pendingInviteData = null;
    let shareWelcomeShown = false;
    let editingWlId = null;
    let currentView = 'main';
    let selectedWlId = null;
    let isLoading = true;

    function migrateWish(w) {
      const ids = Array.isArray(w.wishlistIds) ? w.wishlistIds : (w.wishlistId ? [w.wishlistId] : []);
      const { wishlistId, ...rest } = w;
      return { ...rest, wishlistIds: ids };
    }

    async function ensureUser() {
      const u = tg?.initDataUnsafe?.user;
      if (!u?.id || !useSupabase) return { error: null };
      const { error } = await sb.from('users').upsert({ id: 'tg_' + u.id, first_name: u.first_name, username: u.username }, { onConflict: 'id' });
      return { error };
    }

    function decodeImageUrl(encoded) {
      try {
        return decodeURIComponent(encoded);
      } catch {
        return null;
      }
    }

    function safeShowAlert(message) {
      try {
        tg?.showAlert?.(message);
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ popup —É–∂–µ –æ—Ç–∫—Ä—ã—Ç, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        console.log(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å alert (popup —É–∂–µ –æ—Ç–∫—Ä—ã—Ç): ${message}`);
      }
    }

    async function loadWishesFromSupabase(wlIdSet) {
      const wlIds = wlIdSet || new Set(wishlists.map((w) => w.id));
      const { data: items } = wlIds.size > 0 ? await sb.from('wishlist_items').select('wishlist_id, wish_id').in('wishlist_id', [...wlIds]) : { data: [] };
      const wishIds = new Set((items || []).map((i) => i.wish_id));
      const { data: ownRows } = await sb.from('wishes').select('*').eq('user_id', currentUserId);
      (ownRows || []).forEach((r) => wishIds.add(r.id));
      if (wishIds.size === 0) return [];
      const { data: rows } = await sb.from('wishes').select('*').in('id', [...wishIds]);
      const byWish = {};
      (items || []).forEach((i) => {
        if (!wlIds.has(i.wishlist_id)) return;
        if (!byWish[i.wish_id]) byWish[i.wish_id] = [];
        byWish[i.wish_id].push(i.wishlist_id);
      });
      return (rows || []).map((r) => ({
        id: r.id, name: r.name, image: r.image, price: r.price, currency: r.currency,
        size: r.size, link: r.link, comment: r.comment, category: r.category,
        wishlistIds: byWish[r.id] || [],
      }));
    }

    async function loadWishlistsFromSupabase() {
      const [ownedRes, collabRes, followedRes] = await Promise.all([
        sb.from('wishlists').select('*').eq('owner_id', currentUserId),
        sb.from('wishlist_collaborators').select('wishlist_id').eq('user_id', currentUserId),
        sb.from('followed_public_wishlists').select('wishlist_id').eq('user_id', currentUserId)
      ]);
      if (ownedRes.error) return { data: [], error: ownedRes.error };
      const owned = ownedRes.data || [];
      const collab = collabRes.data || [];
      const followedRows = followedRes.data || [];
      const collabIds = collab.map((c) => c.wishlist_id);
      const byId = {};
      owned.forEach((w) => { byId[w.id] = { ...w, ownerId: w.owner_id, coAuthorIds: [w.owner_id] }; });
      const [sharedRes, allCollabRes] = await Promise.all([
        collabIds.length ? sb.from('wishlists').select('*').in('id', collabIds) : { data: [] },
        Object.keys(byId).length ? sb.from('wishlist_collaborators').select('wishlist_id, user_id').in('wishlist_id', Object.keys(byId)) : { data: [] }
      ]);
      const shared = sharedRes.data || [];
      const allCollab = allCollabRes.data || [];
      shared.forEach((w) => {
        if (!byId[w.id]) byId[w.id] = { ...w, ownerId: w.owner_id, coAuthorIds: [w.owner_id] };
        if (!byId[w.id].coAuthorIds.includes(currentUserId)) byId[w.id].coAuthorIds.push(currentUserId);
      });
      allCollab.forEach((c) => {
        if (byId[c.wishlist_id] && !byId[c.wishlist_id].coAuthorIds.includes(c.user_id)) byId[c.wishlist_id].coAuthorIds.push(c.user_id);
      });
      const followedIds = followedRows.map((r) => r.wishlist_id).filter((id) => !byId[id]);
      if (followedIds.length > 0) {
        const { data: followedWls } = await sb.from('wishlists').select('*').in('id', followedIds).eq('privacy', 'public');
        (followedWls || []).forEach((w) => { byId[w.id] = { ...w, ownerId: w.owner_id, isFollowedPublic: true }; });
      }
      return { data: Object.values(byId).map(migrateWishlist), error: null };
    }

    async function loadCategoriesFromSupabase() {
      const { data } = await sb.from('categories').select('name').eq('user_id', currentUserId);
      return (data || []).map((r) => r.name);
    }

    async function fetchPublicWishlistFromSupabase(wlId) {
      const { data: wlRow, error: e1 } = await sb.from('wishlists').select('*').eq('id', wlId).eq('privacy', 'public').single();
      if (e1 || !wlRow) return null;
      const wl = { ...wlRow, ownerId: wlRow.owner_id };
      const { data: ownerRow } = await sb.from('users').select('first_name, username').eq('id', wl.owner_id).single();
      const ownerName = ownerRow?.username ? '@' + ownerRow.username : (ownerRow?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      const { data: items } = await sb.from('wishlist_items').select('wish_id').eq('wishlist_id', wlId);
      const wishIds = (items || []).map((i) => i.wish_id);
      const { data: wishRows } = wishIds.length ? await sb.from('wishes').select('*').in('id', wishIds) : { data: [] };
      const wishes = (wishRows || []).map((r) => ({ ...r, wishlistIds: [wlId] }));
      const { data: resRows } = await sb.from('reservations').select('wish_id, user_id, user_name').in('wish_id', wishIds);
      const reservedCards = {};
      (resRows || []).forEach((r) => { reservedCards[r.wish_id] = { userId: r.user_id, userName: r.user_name || '–ö—Ç–æ-—Ç–æ' }; });
      return { type: 'public', wishlist: wl, wishes, reservedCards, ownerName };
    }

    async function addFollowedPublicWishlist(wlId) {
      if (!useSupabase || !sb || !currentUserId) return;
      try {
        const { data: wl } = await sb.from('wishlists').select('owner_id, privacy').eq('id', wlId).single();
        if (!wl || wl.privacy !== 'public' || wl.owner_id === currentUserId) return;
        await sb.from('followed_public_wishlists').upsert({ user_id: currentUserId, wishlist_id: wlId }, { onConflict: 'user_id,wishlist_id' });
      } catch (_) {}
    }

    async function removeFollowedPublicWishlist(wlId) {
      if (!useSupabase || !sb) return;
      await sb.from('followed_public_wishlists').delete().eq('user_id', currentUserId).eq('wishlist_id', wlId);
      const { data: items } = await sb.from('wishlist_items').select('wish_id').eq('wishlist_id', wlId);
      const wishIds = (items || []).map((i) => i.wish_id);
      if (wishIds.length) await sb.from('reservations').delete().eq('user_id', currentUserId).in('wish_id', wishIds);
    }

    async function fetchInviteWishlistFromSupabase(wlId) {
      const { data: wlRow, error: e1 } = await sb.from('wishlists').select('*').eq('id', wlId).eq('privacy', 'shared').single();
      if (e1 || !wlRow) return null;
      const { data: ownerRow } = await sb.from('users').select('first_name, username').eq('id', wlRow.owner_id).single();
      const ownerName = ownerRow?.username ? '@' + ownerRow.username : (ownerRow?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      return { wishlist: { ...wlRow, name: wlRow.name }, ownerName };
    }

    function loadWishesSync() {
      const hash = window.location.hash.slice(1);
      if (hash) {
        const data = unpackPayload(hash);
        if (data?.type === 'public') { publicViewData = data; return []; }
        if (data) {
          const arr = Array.isArray(data.wishes) ? data.wishes : (Array.isArray(data) ? data : []);
          return arr.map(migrateWish);
        }
      }
      publicViewData = null;
      try {
        return JSON.parse(safeGetItem(WISHES_KEY) || '[]').map(migrateWish);
      } catch (_) { return []; }
    }

    async function handleInviteJoin(data) {
      const wl = data.wishlist;
      const wlWishes = data.wishes || [];
      if (!wl?.id) return;
      if (useSupabase) {
        await ensureUser();
        await sb.from('wishlist_collaborators').upsert({ wishlist_id: wl.id, user_id: currentUserId }, { onConflict: 'wishlist_id,user_id' });
      } else {
        const wls = JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]');
        const wis = JSON.parse(safeGetItem(WISHES_KEY) || '[]').map(migrateWish);
        const existing = wls.find((x) => x.id === wl.id);
        const coAuthorIds = Array.isArray(wl.coAuthorIds) ? [...wl.coAuthorIds] : (wl.ownerId ? [wl.ownerId] : []);
        if (!coAuthorIds.includes(currentUserId)) coAuthorIds.push(currentUserId);
        const mergedWl = { ...wl, coAuthorIds };
        let newWls = existing ? wls.map((x) => x.id === wl.id ? { ...x, ...mergedWl, coAuthorIds: [...new Set([...(x.coAuthorIds || []), currentUserId])] } : x) : [...wls, mergedWl];
        const newWis = [...wis];
        wlWishes.forEach((w) => {
          const mw = migrateWish({ ...w, wishlistIds: [...(Array.isArray(w.wishlistIds) ? w.wishlistIds : []), wl.id].filter((x, i, a) => a.indexOf(x) === i) });
          const ei = newWis.findIndex((x) => x.id === mw.id);
          if (ei >= 0) { if (!newWis[ei].wishlistIds?.includes(wl.id)) newWis[ei].wishlistIds = [...(newWis[ei].wishlistIds || []), wl.id]; }
          else newWis.push(mw);
        });
        safeSetItem(WISHLISTS_KEY, JSON.stringify(newWls));
        safeSetItem(WISHES_KEY, JSON.stringify(newWis));
      }
      window.location.hash = '';
      window.location.reload();
    }

    function getStartParam() {
      if (_savedStartParam) return _savedStartParam;
      const urlParams = new URLSearchParams(window.location.search);
      const urlStartParam = urlParams.get('start_param');
      if (urlStartParam) return urlStartParam;
      const h = window.location.hash.slice(1);
      if (h) {
        try {
          const hashParams = new URLSearchParams(h);
          const sp = hashParams.get('tgWebAppStartParam') || hashParams.get('start_param');
          if (sp) return sp;
        } catch (e) {}
        if (h.startsWith('start_param=')) return decodeURIComponent(h.split('=').slice(1).join('='));
      }
      if (tg?.initData) {
        try {
          const initDataStartParam = new URLSearchParams(tg.initData).get('start_param');
          if (initDataStartParam) return initDataStartParam;
        } catch (e) {}
      }
      return tg?.initDataUnsafe?.start_param || '';
    }

    async function loadAll() {
      if (useSupabase) await loadSupabase();
      let hash = window.location.hash.slice(1);
      const goHome = sessionStorage.getItem('publicViewGoHome');
      if (goHome) { sessionStorage.removeItem('publicViewGoHome'); hash = ''; }
      const startParam = goHome ? '' : getStartParam();
      if (startParam && startParam.startsWith('img_')) {
        const payload = unpackStartParam(startParam.slice(4));
        if (!payload || !payload.n) {
          isLoading = false; currentView = 'main'; render(); return;
        }
        isLoading = false; currentView = 'main'; render();
        const extracted = { name: payload.n || 'N/A', price: payload.p ?? null, currency: payload.c ?? null, size: payload.s ?? null };
        const overlay = document.getElementById('analysisOverlay');
        const overlayText = document.getElementById('analysisOverlayText');
        if (overlay) overlay.classList.add('visible');
        if (overlayText) overlayText.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É‚Ä¶';
        const loadDataThenOpen = async () => {
          try {
            await Promise.race([
              (async () => {
                await ensureUser();
                if (useSupabase && sb) {
                  const wlRes = await loadWishlistsFromSupabase();
                  if (wlRes.data) wishlists = wlRes.data;
                  wishes = await loadWishesFromSupabase(new Set(wishlists.map((w) => w.id)));
                  wishes = Array.isArray(wishes) ? wishes : [];
                  const cats = await loadCategoriesFromSupabase();
                  categories = Array.isArray(cats) && cats.length ? cats : [];
                } else {
                  wishes = loadWishesSync(); wishes = Array.isArray(wishes) ? wishes : [];
                  try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
                  wishlists = Array.isArray(wishlists) ? wishlists : [];
                  try { const raw = safeGetItem(CATS_KEY); categories = raw ? JSON.parse(raw) : []; } catch (_) { categories = []; }
                  categories = Array.isArray(categories) ? categories : [];
                }
              })(),
              new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 8000))
            ]);
          } catch (_) {}
          isLoading = false; render();
          try {
            const imageSrc = (payload.i && typeof payload.i === 'string')
              ? (payload.i.startsWith('http') ? payload.i : 'data:image/jpeg;base64,' + payload.i)
              : null;
            openWishModalFromImage(imageSrc, extracted);
          } finally {
            document.getElementById('analysisOverlay')?.classList.remove('visible');
          }
        };
        requestAnimationFrame(() => loadDataThenOpen());
        return;
      }
      if (startParam && startParam.startsWith('text_')) {
        const payload = unpackStartParam(startParam.slice(5));
        if (!payload || !payload.n) { isLoading = false; currentView = 'main'; render(); return; }
        isLoading = false; currentView = 'main'; render();
        const extracted = { name: payload.n || '–ñ–µ–ª–∞–Ω–∏–µ', price: payload.p ?? null, currency: payload.c ?? null, size: payload.s ?? null };
        const overlay = document.getElementById('analysisOverlay');
        const overlayText = document.getElementById('analysisOverlayText');
        if (overlay) overlay.classList.add('visible');
        if (overlayText) overlayText.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É‚Ä¶';
        const loadDataThenOpen = async () => {
          try {
            await Promise.race([
              (async () => {
                await ensureUser();
                if (useSupabase && sb) {
                  const wlRes = await loadWishlistsFromSupabase();
                  if (wlRes.data) wishlists = wlRes.data;
                  wishes = await loadWishesFromSupabase(new Set(wishlists.map((w) => w.id)));
                  wishes = Array.isArray(wishes) ? wishes : [];
                  const cats = await loadCategoriesFromSupabase();
                  categories = Array.isArray(cats) && cats.length ? cats : [];
                } else {
                  wishes = loadWishesSync(); wishes = Array.isArray(wishes) ? wishes : [];
                  try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
                  try { const raw = safeGetItem(CATS_KEY); categories = raw ? JSON.parse(raw) : []; } catch (_) { categories = []; }
                }
              })(),
              new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 8000))
            ]);
          } catch (_) {}
          isLoading = false; render();
          try {
            openWishModalFromText(extracted);
          } finally {
            document.getElementById('analysisOverlay')?.classList.remove('visible');
          }
        };
        requestAnimationFrame(() => loadDataThenOpen());
        return;
      }
      if (startParam && startParam.startsWith('link_')) {
        const payload = unpackStartParam(startParam.slice(5));
        if (!payload || !payload.l) { isLoading = false; currentView = 'main'; render(); return; }
        const targetUrl = payload.l;
        isLoading = false; currentView = 'main'; render();
        const extracted = {
          name: payload.n || 'N/A',
          price: payload.p ?? null,
          currency: payload.c ?? null,
          size: payload.s ?? null,
          link: targetUrl,
          image: payload.i || null,
          imageBase64: null
        };
        const overlay = document.getElementById('analysisOverlay');
        const overlayText = document.getElementById('analysisOverlayText');
        if (overlay) overlay.classList.add('visible');
        if (overlayText) overlayText.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É‚Ä¶';
        const loadDataThenOpen = async () => {
          try {
            await Promise.race([
              (async () => {
                await ensureUser();
                if (useSupabase && sb) {
                  const wlRes = await loadWishlistsFromSupabase();
                  if (wlRes.data) wishlists = wlRes.data;
                  wishes = await loadWishesFromSupabase(new Set(wishlists.map((w) => w.id)));
                  wishes = Array.isArray(wishes) ? wishes : [];
                  const cats = await loadCategoriesFromSupabase();
                  categories = Array.isArray(cats) && cats.length ? cats : [];
                } else {
                  wishes = loadWishesSync(); wishes = Array.isArray(wishes) ? wishes : [];
                  try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
                  try { const raw = safeGetItem(CATS_KEY); categories = raw ? JSON.parse(raw) : []; } catch (_) { categories = []; }
                }
              })(),
              new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 8000))
            ]);
          } catch (_) {}
          isLoading = false; render();
          try {
            openWishModalFromLink(extracted, targetUrl);
          } finally {
            document.getElementById('analysisOverlay')?.classList.remove('visible');
          }
        };
        requestAnimationFrame(() => loadDataThenOpen());
        return;
      }
      if (startParam && (startParam.startsWith('w_') || startParam.startsWith('i_'))) {
        hash = startParam.replace('_', '/');
      }
      if (hash) {
        const shortW = /^w\/(.+)$/.exec(hash);
        const shortI = /^i\/(.+)$/.exec(hash);
        if (shortW && useSupabase && sb) {
          publicViewData = await fetchPublicWishlistFromSupabase(shortW[1]);
          if (publicViewData) {
            await ensureUser();
            await addFollowedPublicWishlist(shortW[1]);
            wishes = []; categories = []; wishlists = [];
            history.replaceState(null, '', window.location.pathname + '#w/' + shortW[1]);
            isLoading = false;
            return;
          }
        }
        if (shortI && useSupabase && sb) {
          const wlId = shortI[1];
          try {
            if (sessionStorage.getItem('accepted_invite_' + wlId)) {
              sessionStorage.removeItem('accepted_invite_' + wlId);
              hash = '';
            } else if (sessionStorage.getItem('declined_invite_' + wlId)) {
              sessionStorage.removeItem('declined_invite_' + wlId);
              hash = '';
            } else {
              const info = await fetchInviteWishlistFromSupabase(wlId);
              if (info) {
                pendingInviteData = { wlId, ownerName: info.ownerName, wlName: info.wishlist?.name || '–í–∏—à–ª–∏—Å—Ç' };
                isLoading = false;
                return;
              }
            }
          } catch (_) {}
        }
        await ensureLzString();
        const data = unpackPayload(hash);
        if (data?.type === 'public' && data?.wishlist?.id) {
          publicViewData = data;
          if (useSupabase && sb) { await ensureUser(); await addFollowedPublicWishlist(data.wishlist.id); }
          wishes = []; categories = []; wishlists = [];
          isLoading = false;
          return;
        }
        if (data?.type === 'invite' && data?.wishlist?.id) {
          pendingInviteData = {
            wlId: data.wishlist.id,
            ownerName: data.ownerName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            wlName: data.wishlist.name || '–í–∏—à–ª–∏—Å—Ç',
            fullPayload: data
          };
          isLoading = false;
          return;
        }
      }
      publicViewData = null;
      if (useSupabase && sb) {
        const userRes = await ensureUser();
        if (userRes.error) {
          window._supabaseLoadError = userRes.error.message || JSON.stringify(userRes.error);
          isLoading = false;
          return;
        }
        const wlRes = await loadWishlistsFromSupabase();
        if (wlRes.error) {
          window._supabaseLoadError = wlRes.error.message || JSON.stringify(wlRes.error);
          isLoading = false;
          return;
        }
        wishlists = Array.isArray(wlRes.data) ? wlRes.data : [];
        const wlIdSet = new Set(wishlists.map((w) => w.id));
        const [wishesRes, catsRes] = await Promise.all([
          loadWishesFromSupabase(wlIdSet),
          loadCategoriesFromSupabase()
        ]);
        wishes = Array.isArray(wishesRes) ? wishesRes : [];
        const cats = Array.isArray(catsRes) ? catsRes : [];
        categories = cats.length ? cats : [];
      } else {
        wishes = loadWishesSync();
        wishes = Array.isArray(wishes) ? wishes : [];
        try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
        wishlists = Array.isArray(wishlists) ? wishlists : [];
        try { const raw = safeGetItem(CATS_KEY); categories = raw ? JSON.parse(raw) : []; } catch (_) { categories = []; }
        categories = Array.isArray(categories) ? categories : [];
      }
    }

    async function saveWishes() {
      if (useSupabase) {
        for (const w of wishes) {
          const row = { id: w.id, name: w.name, image: w.image, price: w.price, currency: w.currency, size: w.size, link: w.link, comment: w.comment, category: w.category, user_id: currentUserId };
          await sb.from('wishes').upsert(row, { onConflict: 'id' });
          await sb.from('wishlist_items').delete().eq('wish_id', w.id);
          for (const wlId of (w.wishlistIds || [])) await sb.from('wishlist_items').insert({ wishlist_id: wlId, wish_id: w.id });
        }
        const { data: dbRows } = await sb.from('wishes').select('id').eq('user_id', currentUserId);
        const localIds = new Set(wishes.map((w) => w.id));
        for (const r of (dbRows || [])) { if (!localIds.has(r.id)) await sb.from('wishes').delete().eq('id', r.id); }
      } else {
        try { safeSetItem(WISHES_KEY, JSON.stringify(wishes)); } catch (e) { tg?.showAlert?.('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.'); }
      }
    }

    async function saveCategories() {
      if (useSupabase) {
        await sb.from('categories').delete().eq('user_id', currentUserId);
        for (const name of categories) await sb.from('categories').insert({ user_id: currentUserId, name });
      } else {
        safeSetItem(CATS_KEY, JSON.stringify(categories));
      }
    }

    function migrateWishlist(wl) {
      if (!wl.ownerId) wl.ownerId = wl.owner_id || currentUserId;
      if (!Array.isArray(wl.coAuthorIds) && wl.ownerId) wl.coAuthorIds = [wl.ownerId];
      if (!wl.privacy) wl.privacy = wl.privacy || 'private';
      if (wl.updatedAt == null) wl.updatedAt = wl.updated_at ? new Date(wl.updated_at).getTime() : 0;
      return wl;
    }

    function updateHeaderForView() {
      const slogan = document.getElementById('headerSlogan');
      if (!slogan) return;
      const titles = {
        main: '–ñ–µ–ª–∞–π, –∫–∞–∫ –Ω–∏–∫–æ–≥–¥–∞ –ø—Ä–µ–∂–¥–µ',
        manageWishlists: '–ú–æ–∏ ‚ú®Wish lists‚ú®',
        manageCategories: '–¢–µ–≥–∏ üè∑',
        manageWishes: '–ñ–µ–ª–∞–Ω–∏—è',
        wishlist: selectedWlId ? (wishlists.find((w) => w.id === selectedWlId)?.name || '–í–∏—à–ª–∏—Å—Ç') : '',
        createWishlist: '–ù–æ–≤—ã–π ‚ú®Wish list‚ú®'
      };
      slogan.textContent = titles[currentView] || titles.main;
    }

    function navigateTo(view, wlId = null) {
      currentView = view;
      selectedWlId = wlId;
      document.querySelectorAll('.tab-item').forEach((t) => t.classList.remove('active'));
      const tabMap = { main: 'tabHome', manageWishlists: 'tabWishlists', manageCategories: 'tabTags', manageWishes: 'tabWishes', createWishlist: 'tabWishlists', wishlist: 'tabWishlists' };
      const tabId = tabMap[view];
      if (tabId) document.getElementById(tabId)?.classList.add('active');
      const actionBtns = document.getElementById('actionButtons');
      if (actionBtns) actionBtns.style.display = (view === 'main') ? 'flex' : 'none';
      updateHeaderForView();
      render();
    }
    window.__nav = navigateTo;
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-nav]');
      if (btn) { e.preventDefault(); try { navigateTo(btn.dataset.nav); } catch (err) { console.error('nav err:', err); } return; }
      const back = e.target.closest('[data-nav-back]');
      if (back) { e.preventDefault(); navigateTo(back.dataset.navBack || 'main'); return; }
      const recent = e.target.closest('.recent-item[data-wl-id]');
      if (recent) { e.preventDefault(); navigateTo('wishlist', recent.dataset.wlId); }
    });

    function getFeedEvents() {
      const events = [];
      const visibleWishlists = wishlists.filter((wl) => {
        if (wl.privacy === 'private') return wl.ownerId === currentUserId;
        if (wl.privacy === 'shared') return canEditWishlist(wl);
        return true;
      });
      visibleWishlists.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      for (const wl of visibleWishlists.slice(0, 5)) {
        const wlWishes = wishes.filter((w) => (w.wishlistIds || []).includes(wl.id));
        if (wlWishes.length > 0) {
          const w = wlWishes[0];
          events.push({ text: '–í—ã –¥–æ–±–∞–≤–∏–ª–∏ ' + escapeHtml(w.name) + ' –≤ –≤–∏—à–ª–∏—Å—Ç ' + escapeHtml(wl.name) + ' ‚ú®', wlId: wl.id });
        }
      }
      if (events.length === 0) {
        events.push({ text: '–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –∂–µ–ª–∞–Ω–∏–µ –ø–æ —Ñ–æ—Ç–æ –∏–ª–∏ —Å—Å—ã–ª–∫–µ üíÖ', wlId: null });
      }
      return events.slice(0, 8);
    }

    function renderMain() {
      const content = document.getElementById('content');
      const feedEvents = getFeedEvents();

      content.innerHTML = `
        <div class="feed-container" id="feedContainer">
          ${isLoading
            ? '<div class="skeleton skeleton-recent" style="height:80px;margin-bottom:10px;"></div><div class="skeleton skeleton-recent" style="height:80px;margin-bottom:10px;"></div><div class="skeleton skeleton-recent" style="height:80px;"></div>'
            : feedEvents.map((ev, i) => `
              <div class="feed-item" data-wl-id="${ev.wlId || ''}" style="animation-delay:${i * 0.05}s">
                ${ev.text}
              </div>
            `).join('')}
        </div>
      `;

      content.querySelectorAll('.feed-item[data-wl-id]').forEach((el) => {
        const wlId = el.dataset.wlId;
        if (wlId) { el.style.cursor = 'pointer'; el.addEventListener('click', () => navigateTo('wishlist', wlId)); }
      });
    }

    function bindActionButtons() {
      if (window._actionButtonsBound) return;
      window._actionButtonsBound = true;
      const addByPhotoBtn = document.getElementById('addByPhotoBtn');
      const addByPhotoInput = document.getElementById('addByPhotoInput');
      const addByLinkBtn = document.getElementById('addByLinkBtn');
      if (addByPhotoBtn && addByPhotoInput) {
        addByPhotoBtn.addEventListener('click', () => addByPhotoInput.click());
        addByPhotoInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          e.target.value = '';
          if (!file?.type?.startsWith('image/')) return;
          try {
            const overlay = document.getElementById('analysisOverlay');
            const overlayText = document.getElementById('analysisOverlayText');
            if (overlay) overlay.classList.add('visible');
            if (overlayText) overlayText.textContent = '–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é —Ñ–æ—Ç–æ‚Ä¶';
            let imageBase64 = await fileToBase64(file);
            if (overlayText) overlayText.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é —Ñ–æ—Ç–æ‚Ä¶';
            imageBase64 = await resizeImageBase64(imageBase64, 960, 0.8);
            let extracted = { name: '', price: null, currency: null, size: null };
            if (API_BASE_URL && API_BASE_URL.startsWith('http')) {
              if (overlayText) overlayText.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é‚Ä¶';
              try {
                const b64 = imageBase64.includes(',') ? imageBase64.split(',')[1] : imageBase64;
                const r = await fetch(ensureHttps(API_BASE_URL) + '/analyze-image', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ image: b64 }),
                });
                if (r.ok) {
                  const data = await r.json();
                  extracted = { name: data.name || '', price: data.price ?? null, currency: data.currency ?? null, size: data.size ?? null };
                } else {
                  console.warn('analyze-image:', r.status);
                }
              } catch (e) {
                console.warn('analyze-image fetch:', e);
              }
              if (overlay) overlay.classList.remove('visible');
            } else if (!API_BASE_URL) {
              console.warn('API_BASE_URL –Ω–µ –∑–∞–¥–∞–Ω (LINK_SCRAPER_URL –≤ GitHub Secrets?)');
            }
            openWishModalFromImage(imageBase64, extracted);
          } catch (err) {
            document.getElementById('analysisOverlay')?.classList.remove('visible');
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', err);
            safeShowAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
          }
        });
      }
      if (addByLinkBtn) {
        addByLinkBtn.addEventListener('click', async () => {
          const url = (prompt('–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä:') || '').trim();
          if (!url || !url.startsWith('https://')) {
            if (url) safeShowAlert('–£–∫–∞–∂–∏ —Å—Å—ã–ª–∫—É, –Ω–∞—á–∏–Ω–∞—é—â—É—é—Å—è —Å https://');
            return;
          }
          let extracted = { name: '', price: null, currency: null, size: null, link: url, image: null };
          if (API_BASE_URL && API_BASE_URL.startsWith('http')) {
            const overlay = document.getElementById('analysisOverlay');
            const overlayText = document.getElementById('analysisOverlayText');
            if (overlay) { overlay.classList.add('visible'); overlayText && (overlayText.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É‚Ä¶'); }
            try {
              const r = await fetch(ensureHttps(API_BASE_URL) + '/?url=' + encodeURIComponent(url), { signal: AbortSignal.timeout(45000) });
              if (r.ok) {
                const data = await r.json();
                extracted = {
                  name: data.name || '',
                  price: data.price ?? null,
                  currency: data.currency ?? null,
                  size: data.size ?? null,
                  link: url,
                  image: data.image || null,
                  imageBase64: data.imageBase64 || null,
                };
              } else {
                console.warn('parse url:', r.status);
              }
            } catch (e) {
              console.warn('parse url fetch:', e);
            }
            if (overlay) overlay.classList.remove('visible');
          } else if (!API_BASE_URL) {
            console.warn('API_BASE_URL –Ω–µ –∑–∞–¥–∞–Ω (LINK_SCRAPER_URL –≤ GitHub Secrets?)');
          }
          openWishModalFromLink(extracted, url);
        });
      }
    }

    function canEditWishlist(wl) {
      if (!wl) return false;
      return wl.ownerId === currentUserId || (Array.isArray(wl.coAuthorIds) && wl.coAuthorIds.includes(currentUserId));
    }

    function isOwner(wl) {
      return wl?.ownerId === currentUserId;
    }

    async function saveWishlists() {
      if (useSupabase) {
        const ourIds = new Set(wishlists.map((w) => w.id));
        const { data: owned } = await sb.from('wishlists').select('id').eq('owner_id', currentUserId);
        for (const r of (owned || [])) {
          if (!ourIds.has(r.id)) await sb.from('wishlists').delete().eq('id', r.id);
        }
        for (const wl of wishlists) {
          const row = { id: wl.id, name: wl.name, image: wl.image, privacy: wl.privacy || 'private', owner_id: wl.ownerId || currentUserId };
          if (wl.updatedAt) row.updated_at = new Date(wl.updatedAt).toISOString();
          await sb.from('wishlists').upsert(row, { onConflict: 'id' });
          await sb.from('wishlist_collaborators').delete().eq('wishlist_id', wl.id);
          for (const uid of (wl.coAuthorIds || [])) {
            if (uid !== (wl.ownerId || wl.owner_id)) await sb.from('wishlist_collaborators').insert({ wishlist_id: wl.id, user_id: uid });
          }
        }
      } else {
        safeSetItem(WISHLISTS_KEY, JSON.stringify(wishlists));
      }
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s ?? '';
      return d.innerHTML;
    }

    /** –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –æ—Ç–≤–µ—Ç API (—Ä—É–±, RUB, Br –∏ —Ç.–¥.) –≤ value —Å–µ–ª–µ–∫—Ç–∞ –≤–∞–ª—é—Ç—ã: ‚ÇΩ, Br, $, ‚Ç¨, ‚Ç∏ */
    function normalizeCurrency(raw) {
      if (!raw || typeof raw !== 'string') return '';
      const s = raw.trim().toLowerCase().replace(/\.$/, '');
      const map = {
        '—Ä—É–±': '‚ÇΩ', '—Ä—É–±–ª–µ–π': '‚ÇΩ', 'rub': '‚ÇΩ', '‚ÇΩ': '‚ÇΩ',
        '–±—É–Ω': 'Br', 'byn': 'Br', 'br': 'Br',
        '–¥–æ–ª–ª': '$', 'usd': '$', '$': '$',
        '–µ–≤—Ä': '‚Ç¨', 'eur': '‚Ç¨', '‚Ç¨': '‚Ç¨',
        '—Ç–≥': '‚Ç∏', 'kzt': '‚Ç∏', '‚Ç∏': '‚Ç∏'
      };
      return map[s] || (map[s.replace(/\s+/g, '')] ?? '');
    }

    function resizeImageBase64(base64, maxW = 800, quality = 0.8) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const w = img.width, h = img.height;
          if (w <= maxW) { resolve(base64); return; }
          const canvas = document.createElement('canvas');
          canvas.width = maxW;
          canvas.height = (h / w) * maxW;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = () => resolve(base64);
        img.src = base64;
      });
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function validateName(v) {
      if (!v || !v.trim()) return '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ';
      if (v.length > 100) return '–ú–∞–∫—Å. 100 —Å–∏–º–≤–æ–ª–æ–≤';
      if (!NAME_RE.test(v)) return '–î–æ–ø—É—Å—Ç–∏–º—ã –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –∑–Ω–∞–∫–∏: - _ . , ! ? ( ) \' " & / | ‚Ä¶';
      return null;
    }

    function validateLink(v) {
      if (!v?.trim()) return null;
      if (!URL_RE.test(v.trim())) return '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞';
      return null;
    }

    function validatePrice(v) {
      if (!v) return null;
      const n = parseFloat(String(v).replace(',', '.'));
      if (isNaN(n) || n < 0 || n > 9999999) return '–ß–∏—Å–ª–æ –æ—Ç 0 –¥–æ 9999999';
      if (/\.\d{3,}/.test(String(v))) return '–î–æ —Å–æ—Ç—ã—Ö –¥–æ–ª–µ–π (–º–∞–∫—Å. 2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π)';
      return null;
    }

    function validateSize(v) {
      if (!v?.trim()) return null;
      if (!SIZE_RE.test(v.trim())) return '–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞ –∏ —Ü–∏—Ñ—Ä—ã';
      return null;
    }

    function validateComment(v) {
      if (!v?.trim()) return null;
      if (v.length > 500) return '–ú–∞–∫—Å. 500 —Å–∏–º–≤–æ–ª–æ–≤';
      return null;
    }

    function formatPrice(price, currency) {
      if (!price) return '';
      const n = parseFloat(String(price).replace(',', '.'));
      if (isNaN(n)) return price;
      const fmt = new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(n);
      return currency ? `${fmt} ${currency}` : fmt;
    }

    function render() {
      if (!Array.isArray(wishlists)) wishlists = [];
      if (!Array.isArray(wishes)) wishes = [];
      if (!Array.isArray(categories)) categories = [];
      if (pendingInviteData) {
        document.getElementById('inviteConsentText').textContent = `${pendingInviteData.ownerName} –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤–∞—Å —Å—Ç–∞—Ç—å —Å–æ–∞–≤—Ç–æ—Ä–æ–º –≤–∏—à–ª–∏—Å—Ç–∞ ¬´${pendingInviteData.wlName}¬ª. –í—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∂–µ–ª–∞–Ω–∏—è.`;
        document.getElementById('inviteConsentModal').classList.add('open');
        return;
      }
      if (publicViewData) {
        renderPublicView();
        if (!shareWelcomeShown) {
          const owner = publicViewData.ownerName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
          const wlName = publicViewData.wishlist?.name || '–í–∏—à–ª–∏—Å—Ç';
          document.getElementById('shareWelcomeText').textContent = `${owner} –ø–æ–¥–µ–ª–∏–ª—Å—è —Å –≤–∞–º–∏ –≤–∏—à–ª–∏—Å—Ç–æ–º ¬´${wlName}¬ª. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–µ –∂–µ–ª–∞–Ω–∏–µ.`;
          document.getElementById('shareWelcomeModal').classList.add('open');
          shareWelcomeShown = true;
        }
        return;
      }
      const content = document.getElementById('content');
      if (!content) return;
      updateHeaderForView();
      if (currentView === 'main') {
        renderMain();
        return;
      }
      if (currentView === 'manageWishlists') {
        renderManageWishlists();
        return;
      }
      if (currentView === 'manageCategories') {
        renderManageCategories();
        return;
      }
      if (currentView === 'manageWishes') {
        renderManageWishes();
        return;
      }
      if (currentView === 'wishlist' && selectedWlId) {
        renderWishlistDetail(selectedWlId);
        return;
      }
      if (currentView === 'createWishlist') {
        renderCreateWishlist();
        return;
      }
      renderMain();
    }

    function renderCreateWishlist() {
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="form-group" style="margin-bottom:16px;">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏—à–ª–∏—Å—Ç–∞</label>
          <input type="text" id="newWlName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Birthday üéÇ">
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>–û–±–ª–æ–∂–∫–∞</label>
          <div class="img-upload wl-add-img" id="wlImgUpload">
            <input type="file" id="wlImage" accept="image/*">
            <span id="wlImgText">–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É</span>
            <img id="wlImgPreview" class="img-preview" style="display:none;max-height:120px;" alt="">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:20px;">
          <label>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
          <select id="newWlPrivacy">
            <option value="private">üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
            <option value="public">üëÅ –ü—É–±–ª–∏—á–Ω—ã–π</option>
            <option value="shared">ü§ù –°–æ–≤–º–µ—Å—Ç–Ω—ã–π</option>
          </select>
        </div>
        <div class="form-row form-actions-split">
          <button type="button" class="btn btn-secondary" id="createWlBack" style="flex:0.3;">–ù–∞–∑–∞–¥</button>
          <button type="button" class="btn" id="createWlSubmit" style="flex:0.7;">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
      `;
      document.getElementById('createWlBack').addEventListener('click', () => navigateTo('manageWishlists'));
      document.getElementById('createWlSubmit').addEventListener('click', addWlInManage);
      document.getElementById('wlImgUpload').addEventListener('click', () => document.getElementById('wlImage').click());
      document.getElementById('wlImage').addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f?.type?.startsWith('image/')) return;
        try {
          let b = await fileToBase64(f);
          b = await resizeImageBase64(b, 400);
          pendingWlImageBase64 = b;
          document.getElementById('wlImgPreview').src = b;
          document.getElementById('wlImgPreview').style.display = 'block';
          document.getElementById('wlImgText').textContent = '–û–±–ª–æ–∂–∫–∞ –≤—ã–±—Ä–∞–Ω–∞';
        } catch (_) {}
      });
    }

    function renderManageWishlists() {
      const content = document.getElementById('content');
      content.innerHTML = `
        <button class="btn btn-slay" data-nav="createWishlist" style="margin-bottom:20px;width:100%;">–¢–≤–æ–π –Ω–æ–≤—ã–π SLAY-LISTüíÖ</button>
        <div id="wlManageList" class="wl-manage-list"></div>
      `;
      content.querySelector('.btn-slay').addEventListener('click', () => navigateTo('createWishlist'));
      refreshWlManageList();
    }

    function refreshWlManageList() {
      const list = document.getElementById('wlManageList') || document.getElementById('wlList');
      if (!list) return;
      list.innerHTML = wishlists.length === 0
        ? '<div class="empty-cats">–í–∏—à–ª–∏—Å—Ç–æ–≤ –Ω–µ—Ç. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π.</div>'
        : wishlists.map((wl) => {
            const pr = wl.privacy === 'private' ? '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π' : (wl.privacy === 'public' ? '–ü—É–±–ª–∏—á–Ω—ã–π' : '–°–æ–≤–º–µ—Å—Ç–Ω—ã–π');
            const shareBtn = wl.privacy === 'public' && isOwner(wl) ? `<button class="btn btn-sm btn-secondary" data-wl-share="${escapeHtml(wl.id)}">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>` : '';
            const inviteBtn = wl.privacy === 'shared' && isOwner(wl) ? `<button class="btn btn-sm btn-secondary" data-wl-invite="${escapeHtml(wl.id)}">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>` : '';
            const isCollab = wl.privacy === 'shared' && canEditWishlist(wl) && !isOwner(wl);
            const isFollowed = !!wl.isFollowedPublic;
            const removeOrLeave = (isCollab || isFollowed)
              ? `<span class="wl-item-leave" data-wl-id="${escapeHtml(wl.id)}" data-followed="${isFollowed}" style="color:var(--accent);cursor:pointer;padding:4px;font-size:0.85rem;">–ü–æ–∫–∏–Ω—É—Ç—å</span>`
              : (isOwner(wl) ? `<span class="wl-item-remove" data-wl-id="${escapeHtml(wl.id)}">‚úï</span>` : '');
            const editBtn = isFollowed ? '' : `<button type="button" class="wl-item-edit" data-wl-id="${escapeHtml(wl.id)}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" style="background:none;border:none;padding:6px;cursor:pointer;font-size:1.1rem;">‚öôÔ∏è</button>`;
            const prIcon = wl.privacy === 'private' ? 'üîí' : (wl.privacy === 'public' ? 'üëÅ' : 'ü§ù');
            return `
              <div class="wl-item" data-wl-id="${escapeHtml(wl.id)}">
                ${wl.image ? `<img class="wl-item-img" src="${escapeHtml(wl.image)}" alt="">` : '<div class="wl-item-img" style="background:var(--border);flex-shrink:0;"></div>'}
                <div class="wl-item-body">
                  <div style="font-weight:600;">${escapeHtml(wl.name)}</div>
                  <div style="display:flex;align-items:center;justify-content:space-between;margin-top:6px;font-size:0.85rem;color:var(--text-secondary);">
                    <span>${prIcon} ${escapeHtml(pr)}</span>
                    <span>${shareBtn}${inviteBtn}</span>
                  </div>
                </div>
                ${editBtn}
                ${removeOrLeave}
              </div>`;
          }).join('');
      list.querySelectorAll('.wl-item').forEach((el) => {
        const wlId = el.dataset.wlId;
        el.style.cursor = 'pointer';
        el.addEventListener('click', (e) => { if (!e.target.closest('.wl-item-edit, .wl-item-remove, .wl-item-leave, [data-wl-share], [data-wl-invite]')) navigateTo('wishlist', wlId); });
      });
      list.querySelectorAll('.wl-item-edit').forEach((el) => el.addEventListener('click', (e) => { e.stopPropagation(); openWlModal(); requestAnimationFrame(() => openEditWlForm(el.dataset.wlId)); }));
      list.querySelectorAll('.wl-item-remove').forEach((el) => el.addEventListener('click', async (e) => { e.stopPropagation(); await removeWlInManage(el.dataset.wlId); }));
      list.querySelectorAll('.wl-item-leave').forEach((el) => el.addEventListener('click', async (e) => {
        e.stopPropagation();
        const wlId = el.dataset.wlId;
        if (el.dataset.followed === 'true') {
          await leaveFollowedPublicWishlist(wlId);
          if (useSupabase && sb) { const r = await loadWishlistsFromSupabase(); if (r.data) wishlists = r.data; } else wishlists = wishlists.filter((x) => x.id !== wlId);
        } else {
          await leaveWishlist(wlId);
        }
        refreshWlManageList();
        render();
      }));
      list.querySelectorAll('[data-wl-share]').forEach((b) => b.addEventListener('click', (e) => { e.stopPropagation(); openShareModal(b.dataset.wlShare); }));
      list.querySelectorAll('[data-wl-invite]').forEach((b) => b.addEventListener('click', (e) => { e.stopPropagation(); openInviteModal(b.dataset.wlInvite); }));
    }

    function bindWlManageHandlers() {
      document.getElementById('addWlBtn')?.addEventListener('click', addWlInManage);
      document.getElementById('wlImage')?.addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f?.type?.startsWith('image/')) return;
        try {
          let b = await fileToBase64(f);
          b = await resizeImageBase64(b, 400);
          pendingWlImageBase64 = b;
          const prev = document.getElementById('wlImgPreview');
          const txt = document.getElementById('wlImgText');
          if (prev) { prev.src = b; prev.style.display = 'block'; }
          if (txt) txt.textContent = '–§–∞–π–ª –≤—ã–±—Ä–∞–Ω';
        } catch (_) {}
      });
      document.getElementById('wlImgUpload')?.addEventListener('click', () => document.getElementById('wlImage')?.click());
    }

    async function addWlInManage() {
      const nameEl = document.getElementById('newWlName');
      const name = nameEl?.value?.trim();
      if (!name || validateName(name)) return;
      const wl = { id: 'wl_' + Date.now(), name, image: pendingWlImageBase64 || null, privacy: document.getElementById('newWlPrivacy')?.value || 'private', ownerId: currentUserId, coAuthorIds: [currentUserId], updatedAt: Date.now() };
      wishlists.push(wl);
      await saveWishlists();
      pendingWlImageBase64 = null;
      tg?.HapticFeedback?.notificationOccurred?.('success');
      navigateTo('manageWishlists');
    }

    async function removeCollaborator(wlId, userId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl || !isOwner(wl)) return;
      if (useSupabase && sb) {
        await sb.from('wishlist_collaborators').delete().eq('wishlist_id', wlId).eq('user_id', userId);
      }
      if (wl.coAuthorIds) wl.coAuthorIds = wl.coAuthorIds.filter((id) => id !== userId);
      await saveWishlists();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    async function removeWlInManage(wlId) {
      wishes.forEach((w) => { const ids = Array.isArray(w.wishlistIds) ? w.wishlistIds : []; w.wishlistIds = ids.filter((id) => id !== wlId); });
      wishlists = wishlists.filter((x) => x.id !== wlId);
      await saveWishlists();
      await saveWishes();
      refreshWlManageList();
      render();
    }

    async function leaveWishlist(wlId) {
      if (useSupabase && sb) {
        await sb.from('wishlist_collaborators').delete().eq('wishlist_id', wlId).eq('user_id', currentUserId);
        const res = await loadWishlistsFromSupabase();
        wishlists = res.data || wishlists.filter((x) => x.id !== wlId);
      } else {
        const wl = wishlists.find((x) => x.id === wlId);
        if (wl?.coAuthorIds) wl.coAuthorIds = wl.coAuthorIds.filter((id) => id !== currentUserId);
        wishlists = wishlists.filter((x) => x.id !== wlId);
        await saveWishlists();
      }
      wishes.forEach((w) => { const ids = Array.isArray(w.wishlistIds) ? w.wishlistIds : []; w.wishlistIds = ids.filter((id) => id !== wlId); });
      await saveWishes();
      editingWlId = null;
      document.getElementById('wlAddForm').style.display = 'block';
      document.getElementById('wlEditForm').style.display = 'none';
      document.getElementById('wlEditForm').innerHTML = '';
      refreshWlManageList();
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    function openEditWlFormInManage(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl) return;
      editingWlId = wlId;
      document.getElementById('wlAddForm').style.display = 'none';
      let editForm = document.getElementById('wlEditForm');
      editForm.style.display = 'block';
      editForm.innerHTML = `
        <h3 style="margin-bottom:12px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏—à–ª–∏—Å—Ç</h3>
        <div class="form-group">
          <label><span class="required">*</span> –ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" id="editWlName" value="${escapeHtml(wl.name)}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏—à–ª–∏—Å—Ç–∞">
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
          <select id="editWlPrivacy">
            <option value="private" ${wl.privacy === 'private' ? 'selected' : ''}>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
            <option value="public" ${wl.privacy === 'public' ? 'selected' : ''}>–ü—É–±–ª–∏—á–Ω—ã–π</option>
            <option value="shared" ${wl.privacy === 'shared' ? 'selected' : ''}>–°–æ–≤–º–µ—Å—Ç–Ω—ã–π</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
          <div class="img-upload wl-add-img" id="wlImgUploadEdit">
            <input type="file" id="wlImageEdit" accept="image/*">
            <span id="wlImgTextEdit">–û–±–ª–æ–∂–∫–∞</span>
            <img id="wlImgPreviewEdit" class="img-preview" style="display:${wl.image ? 'block' : 'none'};max-height:120px;" src="${wl.image || ''}" alt="">
          </div>
        </div>
        <div id="wlEditFormExtrasManage"></div>
        <div class="form-actions" style="margin-top:16px;">
          <button type="button" class="btn btn-secondary" id="editWlCancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn" id="editWlSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      `;
      const extras = document.getElementById('wlEditFormExtrasManage');
      const isCollab = wl.privacy === 'shared' && canEditWishlist(wl) && !isOwner(wl);
      if (isCollab) {
        extras.innerHTML = '<button type="button" class="btn btn-secondary" id="editWlLeaveManage" style="margin-top:12px;">–ü–æ–∫–∏–Ω—É—Ç—å –≤–∏—à–ª–∏—Å—Ç</button>';
        document.getElementById('editWlLeaveManage').addEventListener('click', async () => { await leaveWishlist(wlId); });
      } else if (wl.privacy === 'shared' && isOwner(wl)) {
        const coAuths = (wl.coAuthorIds || []).filter((id) => id !== (wl.ownerId || wl.owner_id));
        if (coAuths.length > 0) {
          Promise.all(coAuths.map(async (uid) => {
            if (useSupabase && sb) {
              const { data } = await sb.from('users').select('first_name, username').eq('id', uid).single();
              return data ? (data.username ? '@' + data.username : data.first_name || uid) : uid;
            }
            return uid;
          })).then((names) => {
            extras.innerHTML = `
              <div class="form-group" style="margin-top:12px;">
                <label>–£–¥–∞–ª–∏—Ç—å —Å–æ–∞–≤—Ç–æ—Ä–∞</label>
                <select id="editWlRemoveCollabManage" style="width:100%;padding:8px 12px;margin-top:4px;border-radius:8px;background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border);">
                  <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                  ${coAuths.map((id, i) => `<option value="${escapeHtml(id)}">${escapeHtml(names[i] || id)}</option>`).join('')}
                </select>
                <button type="button" class="btn btn-secondary btn-sm" id="editWlRemoveCollabBtnManage" style="margin-top:8px;">–£–¥–∞–ª–∏—Ç—å</button>
              </div>`;
            document.getElementById('editWlRemoveCollabBtnManage').addEventListener('click', async () => {
              const uid = document.getElementById('editWlRemoveCollabManage').value;
              if (!uid) return;
              await removeCollaborator(wlId, uid);
              openEditWlFormInManage(wlId);
            });
          });
        }
      }
      document.getElementById('editWlName').focus();
      document.getElementById('editWlCancel').addEventListener('click', () => { editingWlId = null; document.getElementById('wlAddForm').style.display = 'block'; document.getElementById('wlEditForm').style.display = 'none'; document.getElementById('wlEditForm').innerHTML = ''; renderManageWishlists(); });
      document.getElementById('editWlSave').addEventListener('click', saveEditWlInManage);
      document.getElementById('wlImageEdit').addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (f) fileToBase64(f).then((b) => { document.getElementById('wlImgPreviewEdit').src = b; document.getElementById('wlImgPreviewEdit').style.display = 'block'; document.getElementById('wlImgTextEdit').textContent = '–§–∞–π–ª –≤—ã–±—Ä–∞–Ω'; pendingEditWlImage = b; });
      });
      document.getElementById('wlImgUploadEdit').addEventListener('click', () => document.getElementById('wlImageEdit').click());
    }

    let pendingEditWlImage = null;
    async function saveEditWlInManage() {
      const wl = wishlists.find((x) => x.id === editingWlId);
      if (!wl) return;
      const name = document.getElementById('editWlName')?.value?.trim();
      if (!name || validateName(name)) return;
      wl.name = name;
      wl.privacy = document.getElementById('editWlPrivacy')?.value || 'private';
      if (pendingEditWlImage) wl.image = pendingEditWlImage;
      wl.updatedAt = Date.now();
      pendingEditWlImage = null;
      await saveWishlists();
      editingWlId = null;
      renderManageWishlists();
    }

    function renderManageCategories() {
      const content = document.getElementById('content');
      const defaultTags = ['–¥–æ—Ä–æ–≥–æ', '–¥–µ—à–µ–≤–æ', '–º–µ—á—Ç–∞', '–æ—Ç–ø—É—Å–∫', '—Å–µ–º—å—è', '–∫–æ—Å–º–µ—Ç–∏–∫–∞', '–æ–¥–µ–∂–¥–∞', '–ø–æ–¥–∞—Ä–æ–∫', '–¥–æ–º', '–≥–∞–¥–∂–µ—Ç'];
      const allTags = [...new Set([...categories, ...defaultTags])];

      content.innerHTML = `
        <button class="btn btn-slay" id="newTagBtn" style="margin-bottom:20px;width:100%;">+ –Ω–æ–≤—ã–π —Ç–µ–≥</button>
        <div id="newTagForm" style="display:none;margin-bottom:20px;gap:8px;align-items:center;" class="tag-form-row">
          <input type="text" id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞" style="flex:1;padding:10px 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);">
          <button type="button" id="newTagCancel" style="padding:10px;background:none;border:none;cursor:pointer;font-size:1.2rem;">‚úï</button>
          <button type="button" class="btn" id="addCatBtn">‚úì</button>
        </div>
        <div id="tagCloud" class="tag-cloud"></div>
        <div id="trashZone" class="trash-zone" data-drop-zone>–ü–µ—Ä–µ—Ç–∞—â–∏ —Å—é–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</div>
      `;

      const showNewTagForm = () => {
        document.getElementById('newTagForm').style.display = 'flex';
        document.getElementById('newTagBtn').style.display = 'none';
        document.getElementById('newCatName').value = '';
        document.getElementById('newCatName').focus();
      };
      const hideNewTagForm = () => {
        document.getElementById('newTagForm').style.display = 'none';
        document.getElementById('newTagBtn').style.display = 'block';
      };

      document.getElementById('newTagBtn').addEventListener('click', showNewTagForm);
      document.getElementById('newTagCancel').addEventListener('click', hideNewTagForm);
      document.getElementById('addCatBtn').addEventListener('click', async () => {
        const v = document.getElementById('newCatName').value.trim();
        if (!v || !/^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-_]+$/.test(v)) return;
        if (categories.includes(v)) return;
        categories.push(v);
        await saveCategories();
        hideNewTagForm();
        renderManageCategories();
      });
      document.getElementById('newCatName').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') document.getElementById('addCatBtn').click();
        if (e.key === 'Escape') hideNewTagForm();
      });

      const cloud = document.getElementById('tagCloud');
      cloud.innerHTML = allTags.map((c) => {
        const isUser = categories.includes(c);
        return `<span class="tag-chip ${isUser ? 'user-tag' : ''}" data-cat="${escapeHtml(c)}" draggable="${isUser}">${escapeHtml(c)}</span>`;
      }).join('');

      cloud.querySelectorAll('.tag-chip.user-tag').forEach((chip) => {
        chip.addEventListener('click', () => chip.classList.toggle('selected'));
        chip.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', chip.dataset.cat); e.dataTransfer.effectAllowed = 'move'; });
      });

      const trash = document.getElementById('trashZone');
      trash.addEventListener('dragover', (e) => { e.preventDefault(); trash.classList.add('drag-over'); });
      trash.addEventListener('dragleave', () => trash.classList.remove('drag-over'));
      trash.addEventListener('drop', async (e) => {
        e.preventDefault();
        trash.classList.remove('drag-over');
        const cat = e.dataTransfer.getData('text/plain');
        if (!cat || !categories.includes(cat)) return;
        categories = categories.filter((x) => x !== cat);
        await saveCategories();
        renderManageCategories();
        tg?.HapticFeedback?.notificationOccurred?.('success');
      });
    }

    function getMyWishes() {
      return wishes.filter((w) => {
        const ids = w.wishlistIds || [];
        if (ids.length === 0) return true;
        return ids.some((id) => { const wl = wishlists.find((x) => x.id === id); return wl && !wl.isFollowedPublic; });
      });
    }

    function renderManageWishes() {
      const content = document.getElementById('content');
      const myWishes = getMyWishes();
      content.innerHTML = `
        <div class="sort-filter-bar" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
          <select id="wishesSortBy" style="padding:8px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:0.85rem;">
            <option value="date">–ü–æ –¥–∞—Ç–µ</option>
            <option value="alpha">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É</option>
          </select>
          <select id="wishesFilterTag" style="padding:8px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:0.85rem;">
            <option value="">–í—Å–µ —Ç–µ–≥–∏</option>
            ${categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
          </select>
          <select id="wishesFilterWl" style="padding:8px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:0.85rem;">
            <option value="">–í—Å–µ –≤–∏—à–ª–∏—Å—Ç—ã</option>
            ${wishlists.filter((wl) => !wl.isFollowedPublic).map((wl) => `<option value="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</option>`).join('')}
          </select>
        </div>
        <button class="btn" id="addWishBtn" style="margin-bottom:16px;">+ –î–æ–±–∞–≤–∏—Ç—å –∂–µ–ª–∞–Ω–∏–µ</button>
        <div id="wishList" class="wish-grid"></div>
      `;
      document.getElementById('addWishBtn').addEventListener('click', () => openWishModal());

      const applySortFilter = () => {
        const sortBy = document.getElementById('wishesSortBy')?.value || 'date';
        const filterTag = document.getElementById('wishesFilterTag')?.value || '';
        const filterWl = document.getElementById('wishesFilterWl')?.value || '';
        let items = [...myWishes];
        if (filterTag) items = items.filter((w) => (w.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏') === filterTag);
        if (filterWl) items = items.filter((w) => (w.wishlistIds || []).includes(filterWl));
        if (sortBy === 'alpha') items.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        else items.sort((a, b) => (parseInt(String(b.id).replace(/\D/g, ''), 10) || 0) - (parseInt(String(a.id).replace(/\D/g, ''), 10) || 0));
        const list = document.getElementById('wishList');
        if (items.length === 0) {
          list.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>–ù–µ—Ç –∂–µ–ª–∞–Ω–∏–π.</p></div>';
          return;
        }
        list.innerHTML = items.map((w, i) => { let h = renderCard(w, { type: 'standalone' }, null); return (i % 4 === 0) ? h.replace(/class="card/, 'class="card tile-wide') : h; }).join('');
        list.querySelectorAll('.btn-edit').forEach((b) => b.addEventListener('click', () => openWishModal(b.dataset.id)));
        list.querySelectorAll('.btn-del').forEach((b) => b.addEventListener('click', () => deleteWish(b.dataset.id).then(() => render()).catch(() => {})));
        list.querySelectorAll('.btn-move').forEach((b) => b.addEventListener('click', (e) => toggleMoveMenu(e, b.dataset.id)));
      };

      applySortFilter();
      document.getElementById('wishesSortBy')?.addEventListener('change', applySortFilter);
      document.getElementById('wishesFilterTag')?.addEventListener('change', applySortFilter);
      document.getElementById('wishesFilterWl')?.addEventListener('change', applySortFilter);
    }

    async function renderWishlistDetail(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl) { navigateTo('main'); return; }
      if (wl.isFollowedPublic) {
        await renderFollowedPublicDetail(wlId);
        return;
      }
      const content = document.getElementById('content');
      const getIds = (w) => (Array.isArray(w.wishlistIds) ? w.wishlistIds : []);
      const wlWishes = wishes.filter((w) => getIds(w).includes(wlId));
      const byCat = {};
      wlWishes.forEach((w) => { const c = w.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'; if (!byCat[c]) byCat[c] = []; byCat[c].push(w); });
      const catOrder = [...categories, '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'].filter((c) => byCat[c]?.length);
      Object.keys(byCat).forEach((c) => { if (!catOrder.includes(c)) catOrder.push(c); });
      const pr = wl.privacy;
      const prLabel = pr === 'private' ? '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π' : (pr === 'public' ? '–ü—É–±–ª–∏—á–Ω—ã–π' : (pr === 'shared' ? '–°–æ–≤–º–µ—Å—Ç–Ω—ã–π' : ''));
      const shareBtn = pr === 'public' && isOwner(wl) ? `<button class="btn btn-sm btn-secondary" data-wl-share="${wl.id}">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>` : '';
      const inviteBtn = pr === 'shared' && isOwner(wl) ? `<button class="btn btn-sm btn-secondary" data-wl-invite="${wl.id}">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>` : '';
      const sec = { type: 'wishlist', wl, wishes: wlWishes };

      content.innerHTML = `
        <button class="btn back-btn" data-nav-back data-nav-back="manageWishlists">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="wl-section-header" style="margin-bottom:16px;">
          ${wl.image ? `<img class="wl-section-img" src="${escapeHtml(wl.image)}" alt="">` : ''}
          <span class="wl-section-title">${escapeHtml(wl.name)}</span>
          ${prLabel ? `<span class="privacy-badge">${escapeHtml(prLabel)}</span>` : ''}
          <span class="wl-header-actions">${shareBtn}${inviteBtn}</span>
        </div>
        <div class="sort-filter-bar" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
          <select id="wlSortBy" style="padding:8px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:0.85rem;">
            <option value="date">–ü–æ –¥–∞—Ç–µ</option>
            <option value="alpha">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É</option>
          </select>
          <select id="wlFilterTag" style="padding:8px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:0.85rem;">
            <option value="">–í—Å–µ —Ç–µ–≥–∏</option>
            ${categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
          </select>
        </div>
        <button class="btn" id="addWishToWl" style="margin-bottom:16px;">+ –î–æ–±–∞–≤–∏—Ç—å –∂–µ–ª–∞–Ω–∏–µ</button>
        <div id="wlWishlistCards" class="wish-grid"></div>
      `;
      content.querySelector('[data-nav-back]').addEventListener('click', () => navigateTo('manageWishlists'));

      const applySortFilter = () => {
        const sortBy = document.getElementById('wlSortBy')?.value || 'date';
        const filterTag = document.getElementById('wlFilterTag')?.value || '';
        let items = [...wlWishes];
        if (filterTag) items = items.filter((w) => (w.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏') === filterTag);
        if (sortBy === 'alpha') items.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        else items.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
        const cardsEl = document.getElementById('wlWishlistCards');
        if (!cardsEl) return;
        cardsEl.innerHTML = items.length === 0
          ? '<div class="empty-state" style="grid-column:1/-1;"><p>–ù–µ—Ç –∂–µ–ª–∞–Ω–∏–π.</p></div>'
          : items.map((w, i) => { let h = renderCard(w, sec, null); return (i % 4 === 0) ? h.replace(/class="card/, 'class="card tile-wide') : h; }).join('');
        cardsEl.querySelectorAll('.btn-edit').forEach((b) => b.addEventListener('click', () => openWishModal(b.dataset.id)));
        cardsEl.querySelectorAll('.btn-del').forEach((b) => b.addEventListener('click', () => deleteWish(b.dataset.id).then(() => { wl.updatedAt = Date.now(); saveWishlists(); render(); }).catch(() => {})));
        cardsEl.querySelectorAll('.btn-move').forEach((b) => b.addEventListener('click', (e) => toggleMoveMenu(e, b.dataset.id)));
      };

      applySortFilter();
      document.getElementById('wlSortBy')?.addEventListener('change', applySortFilter);
      document.getElementById('wlFilterTag')?.addEventListener('change', applySortFilter);

      content.querySelector('#addWishToWl')?.addEventListener('click', () => { openWishModal(null, wlId); });
      content.querySelectorAll('[data-wl-share]').forEach((b) => b.addEventListener('click', () => openShareModal(b.dataset.wlShare)));
      content.querySelectorAll('[data-wl-invite]').forEach((b) => b.addEventListener('click', () => openInviteModal(b.dataset.wlInvite)));
    }

    async function renderFollowedPublicDetail(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl?.isFollowedPublic) return;
      const getIds = (w) => (Array.isArray(w.wishlistIds) ? w.wishlistIds : []);
      const wlWishes = wishes.filter((w) => getIds(w).includes(wlId));
      let reservedCards = {};
      if (useSupabase && sb && wlWishes.length) {
        const wishIds = wlWishes.map((w) => w.id);
        const { data: resRows } = await sb.from('reservations').select('wish_id, user_id, user_name').in('wish_id', wishIds);
        (resRows || []).forEach((r) => { reservedCards[r.wish_id] = { userId: r.user_id, userName: r.user_name || '–ö—Ç–æ-—Ç–æ' }; });
      }
      const byCat = {};
      wlWishes.forEach((w) => { const c = w.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'; if (!byCat[c]) byCat[c] = []; byCat[c].push(w); });
      const catOrder = Object.keys(byCat);
      const content = document.getElementById('content');
      const d = { wishlist: wl, wishes: wlWishes, reservedCards, ownerName: '' };
      content.innerHTML = `
        <button class="btn back-btn" data-nav-back>‚Üê –ù–∞–∑–∞–¥</button>
        <div class="wl-section">
          <div class="wl-section-header">
            ${wl.image ? `<img class="wl-section-img" src="${escapeHtml(wl.image)}" alt="">` : ''}
            <span class="wl-section-title">${escapeHtml(wl.name || '–í–∏—à–ª–∏—Å—Ç')}</span>
          </div>
          <div class="wl-section-body view-readonly">
            ${catOrder.map((catName) => {
              const catItems = byCat[catName] || [];
              return `
                <div class="categories-section">
                  <div class="category-title"><span class="count">${catItems.length}</span> ${escapeHtml(catName)}</div>
                  <div class="wishlist">${catItems.map((w) => renderCard(w, null, { reserved: reservedCards, items: d })).join('')}</div>
                </div>`;
            }).join('')}
          </div>
        </div>`;
      content.querySelector('[data-nav-back]').addEventListener('click', () => navigateTo('main'));
      content.querySelectorAll('.btn-reserve').forEach((b) => b.addEventListener('click', () => reserveCardInFollowed(wlId, b.dataset.cardId)));
      content.querySelectorAll('.btn-unreserve').forEach((b) => b.addEventListener('click', () => unreserveCardInFollowed(wlId, b.dataset.cardId)));
    }

    async function reserveCardInFollowed(wlId, cardId) {
      if (!useSupabase || !sb) return;
      const u = tg?.initDataUnsafe?.user;
      const userId = u?.id ? 'tg_' + u.id : 'anon_' + Date.now();
      const userName = u?.first_name || '–ö—Ç–æ-—Ç–æ';
      await sb.from('reservations').upsert({ wish_id: cardId, user_id: userId, user_name: userName }, { onConflict: 'wish_id' });
      tg?.HapticFeedback?.notificationOccurred?.('success');
      renderWishlistDetail(wlId);
    }

    async function unreserveCardInFollowed(wlId, cardId) {
      if (!useSupabase || !sb) return;
      const u = tg?.initDataUnsafe?.user;
      const userId = u?.id ? 'tg_' + u.id : null;
      const { data: r } = await sb.from('reservations').select('user_id').eq('wish_id', cardId).single();
      if (!r || (userId && r.user_id !== userId)) return;
      await sb.from('reservations').delete().eq('wish_id', cardId);
      tg?.HapticFeedback?.notificationOccurred?.('success');
      renderWishlistDetail(wlId);
    }

    function renderPublicView() {
      const d = publicViewData;
      const content = document.getElementById('content');
      const wl = d.wishlist || {};
      const items = d.wishes || [];
      const reserved = d.reservedCards || {};
      const byCat = {};
      items.forEach((w) => {
        const c = w.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
        if (!byCat[c]) byCat[c] = [];
        byCat[c].push(w);
      });
      const catOrder = Object.keys(byCat);
      content.innerHTML = `
        <button class="btn back-btn" id="publicViewHomeBtn" style="margin-bottom:16px;">üè† –î–æ–º–æ–π</button>
        <div class="wl-section">
          <div class="wl-section-header">
            ${wl.image ? `<img class="wl-section-img" src="${escapeHtml(wl.image)}" alt="">` : ''}
            <span class="wl-section-title">${escapeHtml(wl.name || '–í–∏—à–ª–∏—Å—Ç')}</span>
          </div>
          <div class="wl-section-body view-readonly">
            ${catOrder.map((catName) => {
              const catItems = byCat[catName] || [];
              return `
                <div class="categories-section">
                  <div class="category-title"><span class="count">${catItems.length}</span> ${escapeHtml(catName)}</div>
                  <div class="wishlist">${catItems.map((w) => renderCard(w, null, { reserved, items: d })).join('')}</div>
                </div>`;
            }).join('')}
          </div>
        </div>`;
      content.querySelector('#publicViewHomeBtn')?.addEventListener('click', () => {
        sessionStorage.setItem('publicViewGoHome', '1');
        history.replaceState(null, '', window.location.pathname);
        window.location.reload();
      });
      content.querySelectorAll('.btn-reserve').forEach((b) => b.addEventListener('click', () => reserveCard(b.dataset.cardId)));
      content.querySelectorAll('.btn-unreserve').forEach((b) => b.addEventListener('click', () => unreserveCard(b.dataset.cardId)));
    }

    async function reserveCard(cardId) {
      if (!publicViewData) return;
      const u = tg?.initDataUnsafe?.user;
      const userId = u?.id ? 'tg_' + u.id : 'anon_' + Date.now();
      const userName = u?.first_name || '–ö—Ç–æ-—Ç–æ';
      const reserved = { ...(publicViewData.reservedCards || {}) };
      reserved[cardId] = { userId, userName };
      publicViewData.reservedCards = reserved;
      const base = window.location.origin + window.location.pathname;
      const hash = window.location.hash.slice(1);
      if (hash.startsWith('w/') && useSupabase && sb) {
        await sb.from('reservations').upsert({ wish_id: cardId, user_id: userId, user_name: userName }, { onConflict: 'wish_id' });
        history.replaceState(null, '', base + '#' + hash);
      } else {
        await ensureLzString();
        history.replaceState(null, '', base + '#' + packPayload(publicViewData));
      }
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    async function unreserveCard(cardId) {
      if (!publicViewData) return;
      const u = tg?.initDataUnsafe?.user;
      const userId = u?.id ? 'tg_' + u.id : null;
      const reserved = publicViewData.reservedCards?.[cardId];
      if (!reserved || (userId && reserved.userId !== userId)) return;
      const next = { ...(publicViewData.reservedCards || {}) };
      delete next[cardId];
      publicViewData.reservedCards = next;
      const base = window.location.origin + window.location.pathname;
      const hash = window.location.hash.slice(1);
      if (hash.startsWith('w/') && useSupabase && sb) {
        await sb.from('reservations').delete().eq('wish_id', cardId);
        history.replaceState(null, '', base + '#' + hash);
      } else {
        await ensureLzString();
        history.replaceState(null, '', base + '#' + packPayload(publicViewData));
      }
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    document.addEventListener('click', () => closeMoveMenus());

    function toggleMoveMenu(e, wishId) {
      e.stopPropagation();
      closeMoveMenus();
      const btn = document.querySelector(`.btn-move[data-id="${wishId}"]`);
      if (!btn) return;
      const wrap = btn.closest('.card-move-wrap');
      const w = wishes.find((x) => x.id === wishId);
      const ids = Array.isArray(w?.wishlistIds) ? w.wishlistIds : [];
      const menu = document.createElement('div');
      menu.className = 'card-move-menu';
      wishlists.filter((wl) => !wl.isFollowedPublic).forEach((wl) => {
        const inList = ids.includes(wl.id);
        const opt = document.createElement('button');
        opt.textContent = inList ? `‚úì –£–±—Ä–∞—Ç—å –∏–∑ ¬´${wl.name}¬ª` : `–î–æ–±–∞–≤–∏—Ç—å –≤ ¬´${wl.name}¬ª`;
        opt.addEventListener('click', async (e2) => { e2.stopPropagation(); await toggleWishWishlist(wishId, wl.id); closeMoveMenus(); });
        menu.appendChild(opt);
      });
      if (menu.children.length === 0) return;
      wrap.appendChild(menu);
    }

    function closeMoveMenus() {
      document.querySelectorAll('.card-move-menu').forEach((m) => m.remove());
    }

    async function toggleWishWishlist(wishId, wlId) {
      const w = wishes.find((x) => x.id === wishId);
      if (!w) return;
      const ids = Array.isArray(w.wishlistIds) ? [...w.wishlistIds] : [];
      const idx = ids.indexOf(wlId);
      if (idx >= 0) ids.splice(idx, 1);
      else ids.push(wlId);
      w.wishlistIds = ids;
      const wl = wishlists.find((x) => x.id === wlId);
      if (wl) wl.updatedAt = Date.now();
      await saveWishes();
      await saveWishlists();
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }

    function renderCard(w, section, publicViewOpts) {
      const priceStr = formatPrice(w.price, w.currency);
      const isPublicView = !!publicViewOpts;
      const reserved = publicViewOpts?.reserved?.[w.id];
      const reservedClass = reserved ? ' card-reserved' : '';
      const reservedBadge = reserved
        ? `<div class="card-reserved-badge">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ${reserved.userName ? `: ${escapeHtml(reserved.userName)}` : ''}</div>`
        : '';
      const canMove = !isPublicView && wishlists.length > 0;
      const moveBtn = canMove
        ? `<div class="card-move-wrap">
             <button class="btn btn-secondary btn-sm btn-move card-move-btn" data-id="${w.id}">–í –≤–∏—à–ª–∏—Å—Ç</button>
           </div>`
        : '';
      const isReservedByMe = reserved && reserved.userId === currentUserId;
      let reserveBtn = '';
      if (isPublicView) {
        if (!reserved) reserveBtn = `<button class="btn btn-sm btn-reserve" data-card-id="${w.id}">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>`;
        else if (isReservedByMe) reserveBtn = `<button class="btn btn-sm btn-secondary btn-unreserve" data-card-id="${w.id}">–Ø –ø–µ—Ä–µ–¥—É–º–∞–ª</button>`;
      }
      const actions = isPublicView
        ? `<div class="card-actions">${reserveBtn}</div>`
        : `<div class="card-actions">
             ${moveBtn}
             <button class="btn btn-secondary btn-sm btn-edit" data-id="${w.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
             <button class="btn btn-secondary btn-sm btn-del" data-id="${w.id}">–£–¥–∞–ª–∏—Ç—å</button>
           </div>`;
      return `
        <div class="card${reservedClass}" data-id="${w.id}">
          <img class="card-img" src="${escapeHtml(w.image || '')}" alt="" onerror="this.style.display='none'">
          <div class="card-title">${escapeHtml(w.name)}</div>
          ${priceStr ? `<div class="card-price">${escapeHtml(priceStr)}</div>` : ''}
          ${w.size ? `<div class="card-meta">–†–∞–∑–º–µ—Ä: ${escapeHtml(w.size)}</div>` : ''}
          ${w.link ? `<a class="card-link" href="${escapeHtml(w.link)}" target="_blank" rel="noopener">${escapeHtml(w.link)}</a>` : ''}
          ${w.comment ? `<div class="card-comment">${escapeHtml(w.comment)}</div>` : ''}
          ${reservedBadge}
          ${actions}
        </div>`;
    }

    function openWishModalFromLink(extractedData, link) {
      window._wishFromLink = true;
      window._wishFromImage = false;
      window._stashedImageFromPhoto = null;
      _imageFromPhotoForSave = null;
      tg?.HapticFeedback?.impactOccurred?.('light');
      const imgSrc = extractedData?.imageBase64 || extractedData?.image || null;
      pendingImageBase64 = extractedData?.imageBase64 || extractedData?.image || null;
      const form = document.getElementById('wishForm');
      form.reset();
      document.getElementById('wishId').value = '';
      const imgPreview = document.getElementById('imgPreview');
      if (imgSrc) {
        imgPreview.src = imgSrc;
        imgPreview.style.display = 'block';
        imgPreview.onerror = () => { imgPreview.style.display = 'none'; pendingImageBase64 = null; };
        document.getElementById('imgUploadText').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ';
      } else {
        imgPreview.style.display = 'none';
        document.getElementById('imgUploadText').textContent = '–ù–∞–∂–º–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ —Ñ–æ—Ç–æ';
      }
      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });
      document.getElementById('wishModalTitle').textContent = '–ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Å—ã–ª–∫–∏';
      document.getElementById('wishLink').value = link || extractedData?.link || '';
      updateClosingConfirmation();
      const autoFilled = new Set();
      if (extractedData?.name) {
        document.getElementById('wishName').value = extractedData.name;
        autoFilled.add('name');
      }
      if (extractedData?.price != null) {
        document.getElementById('wishPrice').value = String(extractedData.price);
        autoFilled.add('price');
      }
      if (extractedData?.currency) {
        const normalized = normalizeCurrency(extractedData.currency);
        if (normalized) {
          document.getElementById('wishCurrency').value = normalized;
          autoFilled.add('currency');
        }
      }
      if (extractedData?.size) {
        document.getElementById('wishSize').value = extractedData.size;
        autoFilled.add('size');
      }
      const sel = document.getElementById('wishCategory');
      sel.innerHTML = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +
        categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      const wlSelect = document.getElementById('wishWishlistSelect');
      const selectedIds = new Set();
      const editableWishlists = wishlists.filter((wl) => !wl.isFollowedPublic);
      wlSelect.innerHTML = editableWishlists.length === 0
        ? '<span style="color:var(--text-secondary);font-size:0.9rem;">–ù–µ—Ç –≤–∏—à–ª–∏—Å—Ç–æ–≤</span>'
        : `<div class="multiselect-trigger" id="wlMultiselectTrigger"></div>
           <div class="multiselect-panel" id="wlMultiselectPanel">
             ${editableWishlists.map((wl) => `<div class="multiselect-option" data-id="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</div>`).join('')}
           </div>`;
      const trig = document.getElementById('wlMultiselectTrigger');
      const pan = document.getElementById('wlMultiselectPanel');
      if (trig && pan) {
        const renderMultiselect = () => {
          const names = editableWishlists.filter((wl) => selectedIds.has(wl.id)).map((wl) => wl.name);
          trig.innerHTML = names.length > 0
            ? names.map((n) => `<span class="multiselect-chip">${escapeHtml(n)}</span>`).join('')
            : '<span class="multiselect-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏—à–ª–∏—Å—Ç—ã</span>';
          pan.querySelectorAll('.multiselect-option').forEach((opt) => opt.classList.toggle('selected', selectedIds.has(opt.dataset.id)));
        };
        trig.addEventListener('click', (e) => { e.stopPropagation(); wlSelect.classList.toggle('open'); });
        pan.querySelectorAll('.multiselect-option').forEach((opt) => {
          opt.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = opt.dataset.id;
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            renderMultiselect();
          });
        });
        document.addEventListener('click', () => wlSelect.classList.remove('open'), { once: true });
        wlSelect._getSelectedIds = () => [...selectedIds];
        renderMultiselect();
      }
      document.querySelectorAll('.form-group label').forEach((label) => {
        const inputId = label.getAttribute('for');
        if (!inputId) return;
        const fieldName = inputId.replace('wish', '').toLowerCase();
        if (autoFilled.has(fieldName) || (fieldName === 'link' && link)) {
          label.style.color = 'var(--accent)';
          label.innerHTML = label.textContent.replace(/\s*\(–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ\)/g, '') + ' <span style="font-size:0.7rem;opacity:0.7;">(–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ)</span>';
        }
      });
      updateCounters();
      document.getElementById('wishModal').classList.add('open');
    }

    function openWishModalFromText(extractedData) {
      window._wishFromLink = true;
      window._wishFromImage = false;
      window._stashedImageFromPhoto = null;
      _imageFromPhotoForSave = null;
      tg?.HapticFeedback?.impactOccurred?.('light');
      pendingImageBase64 = PLACEHOLDER_IMAGE;
      const form = document.getElementById('wishForm');
      form.reset();
      document.getElementById('wishId').value = '';
      const imgPreview = document.getElementById('imgPreview');
      imgPreview.src = PLACEHOLDER_IMAGE;
      imgPreview.style.display = 'block';
      imgPreview.onerror = () => { imgPreview.style.display = 'none'; pendingImageBase64 = null; };
      document.getElementById('imgUploadText').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ';
      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });
      document.getElementById('wishModalTitle').textContent = '–ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞';
      document.getElementById('wishLink').value = '';
      updateClosingConfirmation();
      const autoFilled = new Set();
      if (extractedData?.name) {
        document.getElementById('wishName').value = extractedData.name;
        autoFilled.add('name');
      }
      if (extractedData?.price != null) {
        document.getElementById('wishPrice').value = String(extractedData.price);
        autoFilled.add('price');
      }
      if (extractedData?.currency) {
        const normalized = normalizeCurrency(extractedData.currency);
        if (normalized) {
          document.getElementById('wishCurrency').value = normalized;
          autoFilled.add('currency');
        }
      }
      if (extractedData?.size) {
        document.getElementById('wishSize').value = extractedData.size;
        autoFilled.add('size');
      }
      const sel = document.getElementById('wishCategory');
      sel.innerHTML = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +
        categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      const wlSelect = document.getElementById('wishWishlistSelect');
      const selectedIds = new Set();
      const editableWishlists = wishlists.filter((wl) => !wl.isFollowedPublic);
      wlSelect.innerHTML = editableWishlists.length === 0
        ? '<span style="color:var(--text-secondary);font-size:0.9rem;">–ù–µ—Ç –≤–∏—à–ª–∏—Å—Ç–æ–≤</span>'
        : `<div class="multiselect-trigger" id="wlMultiselectTrigger"></div>
           <div class="multiselect-panel" id="wlMultiselectPanel">
             ${editableWishlists.map((wl) => `<div class="multiselect-option" data-id="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</div>`).join('')}
           </div>`;
      const trig = document.getElementById('wlMultiselectTrigger');
      const pan = document.getElementById('wlMultiselectPanel');
      if (trig && pan) {
        const renderMultiselect = () => {
          const names = editableWishlists.filter((wl) => selectedIds.has(wl.id)).map((wl) => wl.name);
          trig.innerHTML = names.length > 0
            ? names.map((n) => `<span class="multiselect-chip">${escapeHtml(n)}</span>`).join('')
            : '<span class="multiselect-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏—à–ª–∏—Å—Ç—ã</span>';
          pan.querySelectorAll('.multiselect-option').forEach((opt) => opt.classList.toggle('selected', selectedIds.has(opt.dataset.id)));
        };
        trig.addEventListener('click', (e) => { e.stopPropagation(); wlSelect.classList.toggle('open'); });
        pan.querySelectorAll('.multiselect-option').forEach((opt) => {
          opt.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = opt.dataset.id;
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            renderMultiselect();
          });
        });
        document.addEventListener('click', () => wlSelect.classList.remove('open'), { once: true });
        wlSelect._getSelectedIds = () => [...selectedIds];
        renderMultiselect();
      }
      document.querySelectorAll('.form-group label').forEach((label) => {
        const inputId = label.getAttribute('for');
        if (!inputId) return;
        const fieldName = inputId.replace('wish', '').toLowerCase();
        if (autoFilled.has(fieldName)) {
          label.style.color = 'var(--accent)';
          label.innerHTML = label.textContent.replace(/\s*\(–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ\)/g, '') + ' <span style="font-size:0.7rem;opacity:0.7;">(–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ)</span>';
        }
      });
      updateCounters();
      document.getElementById('wishModal').classList.add('open');
    }

    function openWishModalFromImage(imageBase64, extractedData) {
      window._wishFromLink = false;
      window._wishFromImage = true;
      const hasRealImage = imageBase64 && imageBase64 !== PLACEHOLDER_IMAGE;
      const imageToUse = hasRealImage ? imageBase64 : null;
      window._stashedImageFromPhoto = imageToUse;
      _imageFromPhotoForSave = imageToUse;
      pendingImageBase64 = imageToUse;
      tg?.HapticFeedback?.impactOccurred?.('light');
      const form = document.getElementById('wishForm');
      form.reset();
      document.getElementById('wishId').value = '';
      const imgPreview = document.getElementById('imgPreview');
      if (hasRealImage) {
        imgPreview.src = imageBase64;
        imgPreview.style.display = 'block';
        imgPreview.onerror = () => { imgPreview.style.display = 'none'; };
        document.getElementById('imgUploadText').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ';
      } else {
        imgPreview.style.display = 'none';
        imgPreview.removeAttribute('src');
        document.getElementById('imgUploadText').textContent = '–ù–∞–∂–º–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ —Ñ–æ—Ç–æ';
      }
      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });
      document.getElementById('wishModalTitle').textContent = '–ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
      
      // –í–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã —Å –¥–∞–Ω–Ω—ã–º–∏
      updateClosingConfirmation();
      
      const autoFilled = new Set();
      if (extractedData.name) {
        document.getElementById('wishName').value = extractedData.name;
        autoFilled.add('name');
      }
      if (extractedData.price) {
        document.getElementById('wishPrice').value = String(extractedData.price);
        autoFilled.add('price');
      }
      if (extractedData.currency) {
        const normalized = normalizeCurrency(extractedData.currency);
        if (normalized) {
          document.getElementById('wishCurrency').value = normalized;
          autoFilled.add('currency');
        }
      }
      if (extractedData.size) {
        document.getElementById('wishSize').value = extractedData.size;
        autoFilled.add('size');
      }
      
      const sel = document.getElementById('wishCategory');
      sel.innerHTML = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +
        categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

      const wlSelect = document.getElementById('wishWishlistSelect');
      const selectedIds = new Set();
      const editableWishlists = wishlists.filter((wl) => !wl.isFollowedPublic);
      const renderMultiselect = () => {
        const names = editableWishlists.filter((wl) => selectedIds.has(wl.id)).map((wl) => wl.name);
        trigger.innerHTML = names.length > 0
          ? names.map((n) => `<span class="multiselect-chip">${escapeHtml(n)}</span>`).join('')
          : '<span class="multiselect-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏—à–ª–∏—Å—Ç—ã</span>';
        panel.querySelectorAll('.multiselect-option').forEach((opt) => opt.classList.toggle('selected', selectedIds.has(opt.dataset.id)));
      };
      wlSelect.innerHTML = editableWishlists.length === 0
        ? '<span style="color:var(--text-secondary);font-size:0.9rem;">–ù–µ—Ç –≤–∏—à–ª–∏—Å—Ç–æ–≤</span>'
        : `<div class="multiselect-trigger" id="wlMultiselectTrigger"></div>
           <div class="multiselect-panel" id="wlMultiselectPanel">
             ${editableWishlists.map((wl) => `<div class="multiselect-option" data-id="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</div>`).join('')}
           </div>`;
      const trigger = document.getElementById('wlMultiselectTrigger');
      const panel = document.getElementById('wlMultiselectPanel');
      if (trigger && panel) {
        trigger.addEventListener('click', (e) => { e.stopPropagation(); wlSelect.classList.toggle('open'); });
        panel.querySelectorAll('.multiselect-option').forEach((opt) => {
          opt.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = opt.dataset.id;
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            renderMultiselect();
          });
        });
        document.addEventListener('click', () => wlSelect.classList.remove('open'), { once: true });
        wlSelect._getSelectedIds = () => [...selectedIds];
        renderMultiselect();
      }
      
      document.querySelectorAll('.form-group label').forEach((label) => {
        const inputId = label.getAttribute('for');
        if (!inputId) return;
        const fieldName = inputId.replace('wish', '').toLowerCase();
        if (autoFilled.has(fieldName)) {
          label.style.color = 'var(--accent)';
          label.innerHTML = label.textContent + ' <span style="font-size:0.7rem;opacity:0.7;">(–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ)</span>';
        }
      });
      
      updateCounters();
      document.getElementById('wishModal').classList.add('open');
      // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert ‚Äî –ø–æ–ø–∞–ø –∞–Ω–∞–ª–∏–∑–∞ –µ—â—ë –æ—Ç–∫—Ä—ã—Ç, —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É
    }

    function openWishModal(editId = null, defaultWlId = null) {
      window._wishFromLink = false;
      window._wishFromImage = false;
      window._stashedImageFromPhoto = null;
      _imageFromPhotoForSave = null;
      tg?.HapticFeedback?.impactOccurred?.('light');
      pendingImageBase64 = null;
      const form = document.getElementById('wishForm');
      form.reset();
      document.getElementById('wishId').value = '';
      document.getElementById('imgPreview').style.display = 'none';
      document.getElementById('imgUploadText').textContent = '–ù–∞–∂–º–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ —Ñ–æ—Ç–æ';
      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });
      document.getElementById('wishModalTitle').textContent = editId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∂–µ–ª–∞–Ω–∏–µ' : '–î–æ–±–∞–≤–∏—Ç—å –∂–µ–ª–∞–Ω–∏–µ';
      
      // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—É—Å—Ç–æ–π —Ñ–æ—Ä–º—ã (–±—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –ø—Ä–∏ –≤–≤–æ–¥–µ –¥–∞–Ω–Ω—ã—Ö)
      updateClosingConfirmation();
      
      document.querySelectorAll('.form-group label').forEach((label) => {
        label.style.color = '';
        const text = label.textContent.replace(/\s*\(–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ\)/g, '');
        label.textContent = text;
      });

      const sel = document.getElementById('wishCategory');
      sel.innerHTML = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +
        categories.map((c) => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

      const wlSelect = document.getElementById('wishWishlistSelect');
      const initialIds = editId ? (wishes.find((x) => x.id === editId)?.wishlistIds || []) : (defaultWlId ? [defaultWlId] : []);
      const selectedIds = new Set(Array.isArray(initialIds) ? initialIds : []);
      const editableWishlists = wishlists.filter((wl) => !wl.isFollowedPublic);
      const renderMultiselect = () => {
        const names = editableWishlists.filter((wl) => selectedIds.has(wl.id)).map((wl) => wl.name);
        trigger.innerHTML = names.length > 0
          ? names.map((n) => `<span class="multiselect-chip">${escapeHtml(n)}</span>`).join('')
          : '<span class="multiselect-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏—à–ª–∏—Å—Ç—ã</span>';
        panel.querySelectorAll('.multiselect-option').forEach((opt) => opt.classList.toggle('selected', selectedIds.has(opt.dataset.id)));
      };
      wlSelect.innerHTML = editableWishlists.length === 0
        ? '<span style="color:var(--text-secondary);font-size:0.9rem;">–ù–µ—Ç –≤–∏—à–ª–∏—Å—Ç–æ–≤</span>'
        : `<div class="multiselect-trigger" id="wlMultiselectTrigger"></div>
           <div class="multiselect-panel" id="wlMultiselectPanel">
             ${editableWishlists.map((wl) => `<div class="multiselect-option" data-id="${escapeHtml(wl.id)}">${escapeHtml(wl.name)}</div>`).join('')}
           </div>`;
      const trigger = document.getElementById('wlMultiselectTrigger');
      const panel = document.getElementById('wlMultiselectPanel');
      if (trigger && panel) {
        trigger.addEventListener('click', (e) => { e.stopPropagation(); wlSelect.classList.toggle('open'); });
        panel.querySelectorAll('.multiselect-option').forEach((opt) => {
          opt.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = opt.dataset.id;
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            renderMultiselect();
          });
        });
        document.addEventListener('click', () => wlSelect.classList.remove('open'), { once: true });
        wlSelect._getSelectedIds = () => [...selectedIds];
        renderMultiselect();
      }

      if (editId) {
        const w = wishes.find((x) => x.id === editId);
        if (w) {
          document.getElementById('wishId').value = w.id;
          document.getElementById('wishName').value = w.name || '';
          document.getElementById('wishPrice').value = w.price || '';
          document.getElementById('wishCurrency').value = w.currency || '';
          document.getElementById('wishSize').value = w.size || '';
          document.getElementById('wishLink').value = w.link || '';
          document.getElementById('wishComment').value = w.comment || '';
          document.getElementById('wishCategory').value = w.category || '';
          if (w.image) {
            pendingImageBase64 = w.image;
            document.getElementById('imgPreview').src = w.image;
            document.getElementById('imgPreview').style.display = 'block';
            document.getElementById('imgUploadText').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ';
          }
        }
      }
      updateCounters();
      document.getElementById('wishModal').classList.add('open');
    }

    function closeWishModal() {
      document.getElementById('wishModal').classList.remove('open');
      window._wishFromImage = false;
      window._stashedImageFromPhoto = null;
      _imageFromPhotoForSave = null;
      updateClosingConfirmation();
    }

    function updateCounters() {
      try {
        const nameEl = document.getElementById('nameCounter');
        const commentEl = document.getElementById('commentCounter');
        const wishName = document.getElementById('wishName');
        const wishComment = document.getElementById('wishComment');
        if (nameEl && wishName) nameEl.textContent = `${(wishName.value || '').length}/100`;
        if (commentEl && wishComment) commentEl.textContent = `${(wishComment.value || '').length}/500`;
      } catch (_) {}
    }

    document.getElementById('wishName')?.addEventListener('input', () => { updateCounters(); updateClosingConfirmation(); });
    document.getElementById('wishComment')?.addEventListener('input', () => { updateCounters(); updateClosingConfirmation(); });
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—è—Ö —Ñ–æ—Ä–º—ã –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
    ['wishLink', 'wishPrice', 'wishSize', 'wishWishlist'].forEach((id) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', updateClosingConfirmation);
        el.addEventListener('change', updateClosingConfirmation);
      }
    });
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.getElementById('wishImage')?.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        updateClosingConfirmation();
      }
    });

    document.getElementById('imgUpload').addEventListener('click', () => document.getElementById('wishImage').click());
    document.getElementById('imgUpload').addEventListener('dragover', (e) => { e.preventDefault(); document.getElementById('imgUpload').classList.add('dragover'); });
    document.getElementById('imgUpload').addEventListener('dragleave', () => document.getElementById('imgUpload').classList.remove('dragover'));
    document.getElementById('imgUpload').addEventListener('drop', (e) => {
      e.preventDefault();
      document.getElementById('imgUpload').classList.remove('dragover');
      const f = e.dataTransfer?.files?.[0];
      if (f && f.type.startsWith('image/')) handleImageFile(f);
    });
    document.getElementById('wishImage').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) handleImageFile(f);
    });

    async function handleImageFile(file) {
      document.getElementById('imgError').style.display = 'none';
      try {
        let b64 = await fileToBase64(file);
        b64 = await resizeImageBase64(b64, 960, 0.8);
        pendingImageBase64 = b64;
        if (window._wishFromImage) { window._stashedImageFromPhoto = b64; _imageFromPhotoForSave = b64; }
        document.getElementById('imgPreview').src = b64;
        document.getElementById('imgPreview').style.display = 'block';
        document.getElementById('imgUploadText').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ';
        updateClosingConfirmation();
      } catch (e) {
        document.getElementById('imgError').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
        document.getElementById('imgError').style.display = 'block';
      }
    }

    document.getElementById('wishForm').addEventListener('submit', (async (e) => {
      e.preventDefault();
      const id = document.getElementById('wishId').value;
      const isNew = !id;
      const capturedImageFromPhoto = window._wishFromImage ? (_imageFromPhotoForSave || window._stashedImageFromPhoto || null) : null;
      const name = document.getElementById('wishName').value.trim();
      const price = document.getElementById('wishPrice').value;
      const currency = document.getElementById('wishCurrency').value;
      const size = document.getElementById('wishSize').value.trim();
      const link = document.getElementById('wishLink').value.trim();
      const comment = document.getElementById('wishComment').value.trim();
      const category = document.getElementById('wishCategory').value || undefined;
      const wlSel = document.getElementById('wishWishlistSelect');
      const wishlistIds = wlSel?._getSelectedIds ? wlSel._getSelectedIds() : [];

      ['imgError','nameError','linkError','priceError','sizeError'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      });

      const hasValidImage = (pendingImageBase64 && pendingImageBase64 !== PLACEHOLDER_IMAGE) || (window._wishFromImage && (capturedImageFromPhoto || window._stashedImageFromPhoto || _imageFromPhotoForSave));
      if (isNew && window._wishFromImage && !hasValidImage) {
        document.getElementById('imgError').textContent = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —Ñ–æ—Ç–æ';
        document.getElementById('imgError').style.display = 'block';
        return;
      }
      if (isNew && !hasValidImage && !window._wishFromLink) {
        document.getElementById('imgError').textContent = '–î–æ–±–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
        document.getElementById('imgError').style.display = 'block';
        return;
      }
      const nameErr = validateName(name);
      if (nameErr) {
        document.getElementById('nameError').textContent = nameErr;
        document.getElementById('nameError').style.display = 'block';
        return;
      }
      const linkErr = validateLink(link);
      if (linkErr) {
        document.getElementById('linkError').textContent = linkErr;
        document.getElementById('linkError').style.display = 'block';
        return;
      }
      const priceErr = validatePrice(price);
      if (priceErr && price) {
        document.getElementById('priceError').textContent = priceErr;
        document.getElementById('priceError').style.display = 'block';
        return;
      }
      const sizeErr = validateSize(size);
      if (sizeErr) {
        document.getElementById('sizeError').textContent = sizeErr;
        document.getElementById('sizeError').style.display = 'block';
        return;
      }

      let imageForSave = (window._wishFromImage && capturedImageFromPhoto)
        ? capturedImageFromPhoto
        : (window._wishFromImage && (_imageFromPhotoForSave || window._stashedImageFromPhoto))
          ? (_imageFromPhotoForSave || window._stashedImageFromPhoto)
          : (pendingImageBase64 && pendingImageBase64 !== PLACEHOLDER_IMAGE)
            ? pendingImageBase64
            : (wishes.find((x) => x.id === id)?.image);
      if (imageForSave && typeof imageForSave === 'string' && imageForSave.startsWith('data:image/') && useSupabase && sb) {
        const uploadedUrl = await uploadImageToSupabaseStorage(imageForSave);
        if (uploadedUrl) imageForSave = uploadedUrl;
      }
      const payload = {
        id: id || 'w_' + Date.now(),
        name,
        image: imageForSave,
        price: price ? (() => { const n = parseFloat(String(price).replace(',', '.')); return isNaN(n) ? undefined : String(Math.round(n * 100) / 100); })() : undefined,
        currency: currency || undefined,
        size: size || undefined,
        link: link || undefined,
        comment: comment || undefined,
        category,
        wishlistIds,
      };

      const idx = wishes.findIndex((x) => x.id === payload.id);
      if (idx >= 0) wishes[idx] = { ...wishes[idx], ...payload };
      else wishes.push(payload);

      wishlistIds.forEach((wlId) => { const wl = wishlists.find((x) => x.id === wlId); if (wl) wl.updatedAt = Date.now(); });
      try {
        await saveWishes();
        await saveWishlists();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
        tg?.showAlert?.('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.');
        return;
      }
      if (window._wishFromImage) _imageFromPhotoForSave = null;
      render();
      closeWishModal();
      updateClosingConfirmation();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    }));

    async function deleteWish(id) {
      tg?.HapticFeedback?.impactOccurred?.('medium');
      wishes = wishes.filter((x) => x.id !== id);
      await saveWishes();
      render();
    }

    document.getElementById('wishCancel').addEventListener('click', closeWishModal);
    document.getElementById('wishModal').addEventListener('click', (e) => {
      if (e.target.id === 'wishModal') closeWishModal();
    });

    function openCatsModal() {
      tg?.HapticFeedback?.impactOccurred?.('light');
      const list = document.getElementById('catList');
      list.innerHTML = categories.length === 0
        ? '<div class="empty-cats">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç. –î–æ–±–∞–≤—å —Å–≤–æ—é.</div>'
        : categories.map((c) => `
            <div class="cat-item" data-cat="${escapeHtml(c)}">
              <span>${escapeHtml(c)}</span>
              <span class="cat-item-remove" data-cat="${escapeHtml(c)}">‚úï</span>
            </div>`).join('');
      list.querySelectorAll('.cat-item-remove').forEach((el) => {
        el.addEventListener('click', async () => {
          categories = categories.filter((x) => x !== el.dataset.cat);
          await saveCategories();
          openCatsModal();
        });
      });
      document.getElementById('newCatName').value = '';
      document.getElementById('catsModal').classList.add('open');
    }

    document.getElementById('catsClose').addEventListener('click', () => document.getElementById('catsModal').classList.remove('open'));
    document.getElementById('catsModal').addEventListener('click', (e) => {
      if (e.target.id === 'catsModal') e.target.classList.remove('open');
    });

    document.getElementById('addCatBtn').addEventListener('click', async () => {
      const v = document.getElementById('newCatName').value.trim();
      if (!v) return;
      const re = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-_]+$/;
      if (!re.test(v)) return;
      if (categories.includes(v)) return;
      categories.push(v);
      await saveCategories();
      document.getElementById('newCatName').value = '';
      openCatsModal();
    });

    document.getElementById('newCatName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('addCatBtn').click();
    });

    function openWlModal() {
      tg?.HapticFeedback?.impactOccurred?.('light');
      document.getElementById('wlAddForm').style.display = 'block';
      document.getElementById('wlEditForm').style.display = 'none';
      editingWlId = null;
      pendingWlImageBase64 = null;
      document.getElementById('wlImgPreview').style.display = 'none';
      document.getElementById('wlImgText').textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
      const list = document.getElementById('wlList');
      list.innerHTML = wishlists.length === 0
        ? '<div class="empty-cats">–í–∏—à–ª–∏—Å—Ç–æ–≤ –Ω–µ—Ç. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π.</div>'
        : wishlists.map((wl) => {
            const pr = wl.privacy === 'private' ? '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π' : (wl.privacy === 'public' ? '–ü—É–±–ª–∏—á–Ω—ã–π' : '–°–æ–≤–º–µ—Å—Ç–Ω—ã–π');
            const isCollab = wl.privacy === 'shared' && canEditWishlist(wl) && !isOwner(wl);
            const isFollowed = !!wl.isFollowedPublic;
            const removeOrLeave = (isCollab || isFollowed)
              ? `<span class="wl-item-leave" data-wl-id="${escapeHtml(wl.id)}" data-followed="${isFollowed}" style="color:var(--accent);cursor:pointer;padding:4px;font-size:0.85rem;">–ü–æ–∫–∏–Ω—É—Ç—å</span>`
              : (isOwner(wl) ? `<span class="wl-item-remove" data-wl-id="${escapeHtml(wl.id)}">‚úï</span>` : '');
            const editBtn = isFollowed ? '' : `<span class="wl-item-edit" data-wl-id="${escapeHtml(wl.id)}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</span>`;
            return `
            <div class="wl-item" data-wl-id="${escapeHtml(wl.id)}">
              ${wl.image ? `<img class="wl-item-img" src="${escapeHtml(wl.image)}" alt="">` : '<div class="wl-item-img" style="background:var(--border);flex-shrink:0;"></div>'}
              <div class="wl-item-body">
                <div>${escapeHtml(wl.name)}</div>
                <span class="privacy-badge" style="font-size:0.7rem;margin-top:4px;display:inline-block;">${escapeHtml(pr)}</span>
              </div>
              ${editBtn}
              ${removeOrLeave}
            </div>`;
          }).join('');
      list.querySelectorAll('.wl-item-edit').forEach((el) => {
        el.addEventListener('click', () => openEditWlForm(el.dataset.wlId));
      });
      list.querySelectorAll('.wl-item-leave').forEach((el) => {
        el.addEventListener('click', async () => {
          const wlId = el.dataset.wlId;
          if (el.dataset.followed === 'true') {
            await leaveFollowedPublicWishlist(wlId);
            if (useSupabase && sb) { const r = await loadWishlistsFromSupabase(); if (r.data) wishlists = r.data; } else wishlists = wishlists.filter((x) => x.id !== wlId);
          } else {
            await leaveWishlist(el.dataset.wlId);
          }
          openWlModal();
        });
      });
      list.querySelectorAll('.wl-item-remove').forEach((el) => {
        el.addEventListener('click', async () => {
          const wlId = el.dataset.wlId;
          wishes.forEach((w) => {
            const ids = Array.isArray(w.wishlistIds) ? w.wishlistIds : [];
            w.wishlistIds = ids.filter((id) => id !== wlId);
          });
          wishlists = wishlists.filter((x) => x.id !== wlId);
          await saveWishlists();
          await saveWishes();
          openWlModal();
        });
      });
      document.getElementById('newWlName').value = '';
      document.getElementById('wlModal').classList.add('open');
    }

    document.getElementById('wlClose').addEventListener('click', () => document.getElementById('wlModal').classList.remove('open'));
    document.getElementById('wlModal').addEventListener('click', (e) => {
      if (e.target.id === 'wlModal') e.target.classList.remove('open');
    });

    document.getElementById('wlImgUpload').addEventListener('click', () => document.getElementById('wlImage').click());
    document.getElementById('wlImage').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f || !f.type.startsWith('image/')) return;
      try {
        let b64 = await fileToBase64(f);
        b64 = await resizeImageBase64(b64, 400);
        pendingWlImageBase64 = b64;
        document.getElementById('wlImgPreview').src = b64;
        document.getElementById('wlImgPreview').style.display = 'block';
        document.getElementById('wlImgText').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É';
      } catch (_) {}
    });

    document.getElementById('addWlBtn').addEventListener('click', async () => {
      const name = document.getElementById('newWlName').value.trim();
      if (!name) return;
      const wl = {
        id: 'wl_' + Date.now(),
        name,
        image: pendingWlImageBase64 || undefined,
        privacy: document.getElementById('newWlPrivacy').value || 'private',
        ownerId: currentUserId,
        coAuthorIds: [currentUserId],
      };
      wishlists.push(wl);
      await saveWishlists();
      pendingWlImageBase64 = null;
      document.getElementById('newWlName').value = '';
      document.getElementById('wlImgPreview').style.display = 'none';
      document.getElementById('wlImgText').textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
      document.getElementById('wlImage').value = '';
      openWlModal();
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    });

    async function openEditWlForm(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl) return;
      editingWlId = wlId;
      pendingEditWlImage = null;
      document.getElementById('wlAddForm').style.display = 'none';
      document.getElementById('wlEditForm').style.display = 'block';
      document.getElementById('editWlName').value = wl.name || '';
      document.getElementById('editWlPrivacy').value = wl.privacy || 'private';
      document.getElementById('wlImgPreviewEdit').style.display = 'none';
      document.getElementById('wlImgTextEdit').textContent = '–û–±–ª–æ–∂–∫–∞';
      if (wl.image) {
        document.getElementById('wlImgPreviewEdit').src = wl.image;
        document.getElementById('wlImgPreviewEdit').style.display = 'block';
        document.getElementById('wlImgTextEdit').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É';
      }
      const extras = document.getElementById('wlEditFormExtras');
      extras.innerHTML = '';
      const isCollab = wl.privacy === 'shared' && canEditWishlist(wl) && !isOwner(wl);
      if (isCollab) {
        extras.innerHTML = '<button type="button" class="btn btn-secondary" id="editWlLeave" style="margin-top:12px;">–ü–æ–∫–∏–Ω—É—Ç—å –≤–∏—à–ª–∏—Å—Ç</button>';
        document.getElementById('editWlLeave').addEventListener('click', async () => { await leaveWishlist(wlId); document.getElementById('wlModal').classList.remove('open'); openWlModal(); });
      } else if (wl.privacy === 'shared' && isOwner(wl)) {
        const coAuths = (wl.coAuthorIds || []).filter((id) => id !== (wl.ownerId || wl.owner_id));
        if (coAuths.length > 0) {
          const names = await Promise.all(coAuths.map(async (uid) => {
            if (useSupabase && sb) {
              const { data } = await sb.from('users').select('first_name, username').eq('id', uid).single();
              return data ? (data.username ? '@' + data.username : data.first_name || uid) : uid;
            }
            return uid;
          }));
          extras.innerHTML = `
            <div class="form-group" style="margin-top:12px;">
              <label>–£–¥–∞–ª–∏—Ç—å —Å–æ–∞–≤—Ç–æ—Ä–∞</label>
              <select id="editWlRemoveCollab" style="width:100%;padding:8px 12px;margin-top:4px;border-radius:8px;background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border);">
                <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                ${coAuths.map((id, i) => `<option value="${escapeHtml(id)}">${escapeHtml(names[i] || id)}</option>`).join('')}
              </select>
              <button type="button" class="btn btn-secondary btn-sm" id="editWlRemoveCollabBtn" style="margin-top:8px;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>`;
          document.getElementById('editWlRemoveCollabBtn').addEventListener('click', async () => {
            const uid = document.getElementById('editWlRemoveCollab').value;
            if (!uid) return;
            await removeCollaborator(wlId, uid);
            openEditWlForm(wlId);
          });
        }
      }
    }

    document.getElementById('editWlCancel').addEventListener('click', () => {
      editingWlId = null;
      document.getElementById('wlAddForm').style.display = 'block';
      document.getElementById('wlEditForm').style.display = 'none';
      openWlModal();
    });

    document.getElementById('editWlSave').addEventListener('click', async () => {
      if (!editingWlId) return;
      const wl = wishlists.find((x) => x.id === editingWlId);
      if (!wl) return;
      const name = document.getElementById('editWlName').value.trim();
      if (!name) return;
      wl.name = name;
      wl.privacy = document.getElementById('editWlPrivacy').value || 'private';
      if (pendingEditWlImage) wl.image = pendingEditWlImage;
      await saveWishlists();
      editingWlId = null;
      document.getElementById('wlAddForm').style.display = 'block';
      document.getElementById('wlEditForm').style.display = 'none';
      openWlModal();
      render();
      tg?.HapticFeedback?.notificationOccurred?.('success');
    });

    document.getElementById('wlImgUploadEdit').addEventListener('click', () => document.getElementById('wlImageEdit').click());
    document.getElementById('wlImageEdit').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f || !f.type.startsWith('image/')) return;
      try {
        let b64 = await fileToBase64(f);
        b64 = await resizeImageBase64(b64, 400);
        pendingEditWlImage = b64;
        document.getElementById('wlImgPreviewEdit').src = b64;
        document.getElementById('wlImgPreviewEdit').style.display = 'block';
        document.getElementById('wlImgTextEdit').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É';
      } catch (_) {}
    });

    async function buildShareUrl(type, wlId, payload) {
      if (TELEGRAM_BOT && TELEGRAM_APP) {
        const param = type === 'share' ? 'w_' + wlId : 'i_' + wlId;
        return 'https://t.me/' + TELEGRAM_BOT + '/' + TELEGRAM_APP + '?startapp=' + param;
      }
      const base = window.location.origin + window.location.pathname;
      if (useSupabase && sb) return base + (type === 'share' ? '#w/' : '#i/') + wlId;
      await ensureLzString();
      return base + '#' + packPayload(payload);
    }

    async function openShareModal(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl || wl.privacy !== 'public') return;
      const ownerName = tg?.initDataUnsafe?.user?.username ? '@' + tg.initDataUnsafe.user.username : (tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      const url = await buildShareUrl('share', wlId, { type: 'public', wishlist: wl, wishes: wishes.filter((w) => (w.wishlistIds || []).includes(wlId)), reservedCards: {}, ownerName });
      if (tg?.openTelegramLink) {
        const text = `–ü–æ—Å–º–æ—Ç—Ä–∏ –º–æ–π –≤–∏—à–ª–∏—Å—Ç ¬´${wl.name || '–í–∏—à–ª–∏—Å—Ç'}¬ª!`;
        tg.openTelegramLink('https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(text));
      } else {
        document.getElementById('shareWlLink').textContent = url;
        document.getElementById('shareWlHint').style.display = (TELEGRAM_BOT && TELEGRAM_APP) ? 'none' : 'block';
        document.getElementById('shareWlModal').classList.add('open');
      }
    }

    async function openInviteModal(wlId) {
      const wl = wishlists.find((x) => x.id === wlId);
      if (!wl || wl.privacy !== 'shared') return;
      const invOwnerName = tg?.initDataUnsafe?.user?.username ? '@' + tg.initDataUnsafe.user.username : (tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      const url = await buildShareUrl('invite', wlId, { type: 'invite', wishlist: { ...wl, coAuthorIds: wl.coAuthorIds || [wl.ownerId] }, wishes: wishes.filter((w) => (w.wishlistIds || []).includes(wlId)), ownerName: invOwnerName });
      if (tg?.openTelegramLink) {
        const text = `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –≤–∏—à–ª–∏—Å—Ç—É ¬´${wl.name || '–í–∏—à–ª–∏—Å—Ç'}¬ª –∫–∞–∫ —Å–æ–∞–≤—Ç–æ—Ä!`;
        tg.openTelegramLink('https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(text));
      } else {
        document.getElementById('inviteWlLink').textContent = url;
        document.getElementById('inviteWlHint').style.display = (TELEGRAM_BOT && TELEGRAM_APP) ? 'none' : 'block';
        document.getElementById('inviteWlModal').classList.add('open');
      }
    }

    document.getElementById('shareWlClose').addEventListener('click', () => document.getElementById('shareWlModal').classList.remove('open'));
    document.getElementById('shareWlCopy').addEventListener('click', () => {
      navigator.clipboard?.writeText(document.getElementById('shareWlLink').textContent);
      tg?.HapticFeedback?.notificationOccurred?.('success');
      document.getElementById('shareWlCopy').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      setTimeout(() => { document.getElementById('shareWlCopy').textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
    });
    document.getElementById('shareWlModal').addEventListener('click', (e) => { if (e.target.id === 'shareWlModal') e.target.classList.remove('open'); });

    document.getElementById('shareWelcomeOk').addEventListener('click', () => {
      document.getElementById('shareWelcomeModal').classList.remove('open');
    });

    document.getElementById('inviteConsentAccept').addEventListener('click', async () => {
      if (!pendingInviteData) return;
      const next = { ...pendingInviteData };
      pendingInviteData = null;
      document.getElementById('inviteConsentModal').classList.remove('open');
      if (next.fullPayload && !useSupabase) {
        await handleInviteJoin(next.fullPayload);
      } else if (useSupabase && sb) {
        await ensureUser();
        await sb.from('wishlist_collaborators').upsert({ wishlist_id: next.wlId, user_id: currentUserId }, { onConflict: 'wishlist_id,user_id' });
        sessionStorage.setItem('accepted_invite_' + next.wlId, '1');
      }
      window.location.reload();
    });

    document.getElementById('inviteConsentDecline').addEventListener('click', () => {
      if (!pendingInviteData) return;
      const wlId = pendingInviteData.wlId;
      pendingInviteData = null;
      document.getElementById('inviteConsentModal').classList.remove('open');
      sessionStorage.setItem('declined_invite_' + wlId, '1');
      window.location.reload();
    });

    document.getElementById('inviteWlClose').addEventListener('click', () => document.getElementById('inviteWlModal').classList.remove('open'));
    document.getElementById('inviteWlCopy').addEventListener('click', () => {
      navigator.clipboard?.writeText(document.getElementById('inviteWlLink').textContent);
      tg?.HapticFeedback?.notificationOccurred?.('success');
      document.getElementById('inviteWlCopy').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      setTimeout(() => { document.getElementById('inviteWlCopy').textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
    });
    document.getElementById('inviteWlModal').addEventListener('click', (e) => { if (e.target.id === 'inviteWlModal') e.target.classList.remove('open'); });

    (function(){var h=document.getElementById('mainHeader');if(h){var t=0,n=0;h.addEventListener('click',function(){var now=Date.now();if(now-t>1200)n=0;t=now;n++;if(n>=5){n=0;if(typeof loadEruda==='function')loadEruda();}});}})();

    (async function init() {
      let content;
      try {
        content = document.getElementById('content');
        if (!content) { document.body.insertAdjacentHTML('beforeend', '<div id="content" style="padding:16px;"></div>'); content = document.getElementById('content'); }
        currentView = 'main';
        if (!Array.isArray(wishlists)) wishlists = [];
        if (!Array.isArray(wishes)) wishes = [];
        if (!Array.isArray(categories)) categories = [];
        bindActionButtons();
        document.getElementById('tabHome')?.classList.add('active');
        render();
      } catch (e) {
        console.error('Init/render error:', e);
        const c = document.getElementById('content');
        if (c) c.innerHTML = '<p style="padding:24px;color:var(--accent);">–û—à–∏–±–∫–∞: ' + String(e && e.message || e).slice(0, 100) + '</p><button class="btn" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>';
        return;
      }
      const fallbackToLocal = function() {
        publicViewData = null;
        currentView = 'main';
        if (useSupabase) {
          wishes = []; wishlists = []; categories = [];
        } else {
          try { wishes = JSON.parse(safeGetItem(WISHES_KEY) || '[]').map(migrateWish); } catch (_) { wishes = []; }
          try { wishlists = (JSON.parse(safeGetItem(WISHLISTS_KEY) || '[]')).map(migrateWishlist); } catch (_) { wishlists = []; }
          try { const r = safeGetItem(CATS_KEY); categories = r ? JSON.parse(r) : []; } catch (_) { categories = []; }
        }
        if (!Array.isArray(wishlists)) wishlists = [];
        if (!Array.isArray(wishes)) wishes = [];
        if (!Array.isArray(categories)) categories = [];
      };
      try {
        const loadPromise = loadAll();
        const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 5000));
        await Promise.race([loadPromise, timeout]);
      } catch (e) {
        console.error('Load error:', e);
        fallbackToLocal();
      }
      isLoading = false;
      currentView = 'main';
      if (window._supabaseLoadError) {
        const raw = String(window._supabaseLoadError);
        const msg = raw.length > 200 ? raw.slice(0, 200) + '‚Ä¶' : raw;
        const safe = msg.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
        content.innerHTML = '<p style="text-align:center;padding:24px;color:var(--accent);">–û—à–∏–±–∫–∞ Supabase: ' + safe + '</p><p style="text-align:center;font-size:0.85rem;color:var(--text-secondary);">–ü—Ä–æ–≤–µ—Ä—å RLS: –≤—ã–ø–æ–ª–Ω–∏ supabase-disable-rls.sql –≤ SQL Editor.</p><button class="btn" style="margin:16px auto;display:block;" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>';
        return;
      }
      try {
        render();
      } catch (e) {
        console.error('Render error:', e);
        fallbackToLocal();
        try { render(); } catch (_) {
          content.innerHTML = '<p style="text-align:center;padding:24px;color:var(--text-secondary);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.</p><button class="btn" style="margin:0 auto;display:block;" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>';
        }
      }
    })();
  </script>
</body>
</html>
